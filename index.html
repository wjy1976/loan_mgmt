<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>借貸管理系統 (ver. 2.025.1225)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        
        /* Drag and Drop Styles */
        .draggable-card { cursor: grab; }
        .draggable-card:active { cursor: grabbing; }
        
        /* Table Styles */
        th, td { vertical-align: middle; }
        
        /* Input in table */
        .table-input {
            transition: all 0.2s;
        }
        .table-input:focus {
            outline: 2px solid #10b981;
            background-color: #ffffff;
        }
        
        /* 批次選擇相關樣式 */
        .batch-selection-mode .select-checkbox {
            display: table-cell !important;
        }
        
        .batch-selection-mode .sticky {
            left: 40px !important;
        }
        
        .batch-selection-mode .sticky:nth-child(2) {
            left: 160px !important;
        }
        
        .batch-selection-mode .sticky:nth-child(3) {
            left: 240px !important;
        }
        
        .batch-selection-mode .sticky:nth-child(4) {
            left: 320px !important;
        }
        
        .batch-selection-mode .sticky:nth-child(5) {
            left: 400px !important;
        }
        
        /* 手機版優化 */
        @media (max-width: 768px) {
            /* 隱藏桌面版表格，顯示手機版卡片 */
            .desktop-table-view {
                display: none;
            }
            .mobile-card-view {
                display: block;
            }
            
            /* 手機版卡片樣式 */
            .mobile-case-card {
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                padding: 1rem;
                margin-bottom: 1rem;
                background: white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .mobile-case-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 0.75rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid #f3f4f6;
            }
            
            .mobile-case-id {
                font-weight: bold;
                color: #374151;
                margin-right: 0.5rem;
            }
            
            .mobile-borrower-name {
                font-size: 1.125rem;
                font-weight: 600;
                margin-top: 0.25rem;
            }
            
            .mobile-status-badge {
                display: inline-block;
                padding: 0.25rem 0.5rem;
                border-radius: 0.5rem;
                font-size: 0.75rem;
                font-weight: 600;
                white-space: nowrap;
            }
            
            .mobile-payment-status {
                display: inline-flex;
                align-items: center;
                padding: 0.25rem 0.5rem;
                border-radius: 0.5rem;
                font-size: 0.75rem;
                font-weight: 600;
                margin-top: 0.5rem;
            }
            
            .mobile-payment-status.paid {
                background-color: #d1fae5;
                color: #065f46;
            }
            
            .mobile-payment-status.unpaid {
                background-color: #fee2e2;
                color: #991b1b;
            }
            
            .mobile-payment-status.overdue {
                background-color: #fef3c7;
                color: #92400e;
            }
            
            .mobile-case-details {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .mobile-detail-item {
                display: flex;
                flex-direction: column;
            }
            
            .mobile-detail-label {
                font-size: 0.75rem;
                color: #6b7280;
                margin-bottom: 0.25rem;
            }
            
            .mobile-detail-value {
                font-weight: 500;
                color: #374151;
            }
            
            .mobile-case-actions {
                display: flex;
                justify-content: space-between;
                padding-top: 0.75rem;
                border-top: 1px solid #f3f4f6;
            }
            
            .mobile-action-button {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0.5rem;
                border-radius: 0.5rem;
                font-size: 0.875rem;
            }
            
            /* 手機版搜尋欄位調整 */
            .mobile-search-container {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .mobile-search-container .flex {
                width: 100%;
                justify-content: space-between;
            }
            
            .mobile-search-container input {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            /* 手機版按鈕調整 */
            .mobile-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            
            .mobile-button-small {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            
            /* 手機版批次選擇卡片 */
            .mobile-batch-select {
                position: absolute;
                top: 0.5rem;
                left: 0.5rem;
                z-index: 10;
            }
            
            .mobile-batch-select-card {
                position: relative;
                padding-left: 2.5rem;
            }
        }
        
        @media (min-width: 769px) {
            /* 桌面版顯示表格，隱藏手機版卡片 */
            .desktop-table-view {
                display: block;
            }
            .mobile-card-view {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800">

    <div id="app"></div>
    
    <!-- 隱藏的檔案輸入框，用於 CSV 匯入 -->
    <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="window.handleFileChange(event)" />

    <!-- 系統訊息與確認容器 -->
    <div id="system-modals">
        <!-- 訊息提示 (Error/Success) -->
        <div id="message-container" class="fixed top-4 right-4 w-full max-w-sm z-[90] pointer-events-none"></div>

        <!-- 確認視窗 Modal -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 animate-fade-in backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all">
                <div class="p-6">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-red-100 text-red-600 rounded-full">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800" id="confirm-title">確認操作</h3>
                            <p class="text-sm text-gray-500" id="confirm-message">您確定要執行此操作嗎？此動作無法復原。</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 border-t border-gray-100">
                    <button id="confirm-cancel" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg text-sm transition-colors">取消</button>
                    <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">確定</button>
                </div>
            </div>
        </div>
        
        <!-- 載入中 Modal -->
        <div id="loading-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 animate-fade-in backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl p-6 flex items-center space-x-4">
                <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                <p class="text-gray-700 font-medium" id="loading-text">處理中，請稍候...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc, serverTimestamp, writeBatch, orderBy, getDoc, setDoc, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Custom Alert/Confirm Logic ---
        const showMessage = (message, type) => {
            const container = document.getElementById('message-container');
            if (!container) return;

            const isError = type === 'error';
            const bgColor = isError ? 'bg-red-50 border-red-300' : 'bg-emerald-50 border-emerald-300';
            const textColor = isError ? 'text-red-700' : 'text-emerald-700';
            const icon = isError ? 'x-circle' : 'check-circle';

            const messageBox = document.createElement('div');
            messageBox.className = `p-4 mt-3 border rounded-xl shadow-lg flex items-start space-x-3 animate-fade-in pointer-events-auto ${bgColor}`;
            messageBox.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 flex-shrink-0 ${textColor}"></i><p class="text-sm font-medium ${textColor}">${message}</p>`;
            container.prepend(messageBox);
            lucide.createIcons();

            setTimeout(() => {
                messageBox.remove();
            }, 4000);
        };

        window.showError = (message) => showMessage(message, 'error');
        window.showSuccess = (message) => showMessage(message, 'success');

        window.showConfirm = (message, callback) => {
            const modal = document.getElementById('confirm-modal');
            const msgEl = document.getElementById('confirm-message');
            const okBtn = document.getElementById('confirm-ok');
            const cancelBtn = document.getElementById('confirm-cancel');

            if (!modal || !msgEl || !okBtn || !cancelBtn) return;

            msgEl.textContent = message;
            modal.classList.remove('hidden');

            const newOk = okBtn.cloneNode(true); okBtn.parentNode.replaceChild(newOk, okBtn);
            const newCancel = cancelBtn.cloneNode(true); cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

            const closeAndClean = () => modal.classList.add('hidden');

            newOk.addEventListener('click', () => { closeAndClean(); callback(true); });
            newCancel.addEventListener('click', () => { closeAndClean(); callback(false); });
        };

        // --- Configuration ---
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAHwE1LPtzDpKtfP77gQahh1dKoobGGyw4",
          authDomain: "loanproject-2fe6d.firebaseapp.com",
          projectId: "loanproject-2fe6d",
          storageBucket: "loanproject-2fe6d.firebasestorage.app",
          messagingSenderId: "754719036128",
          appId: "1:754719036128:web:57b3b4ad579bd00af8f685"
        };

        // --- Initialization ---
        let app, auth, db;
        let firebaseAvailable = false;
        let appId = 'loanproject-default'; 

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // 設定登入狀態為session，關閉瀏覽器即清除
            try {
                await setPersistence(auth, browserSessionPersistence);
                console.log("Persistence設定為session");
            } catch (e) {
                console.error("設定persistence失敗:", e);
            }
            
            firebaseAvailable = true;
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.warn("Firebase 初始化失敗:", e);
            firebaseAvailable = false;
        }

        // --- Global State ---
        const initialCardLayout = [
            { id: 'totalIncome', label: "總收入 (累計)", type: "primary", icon: "wallet", isCurrency: true, width: 2 },
            { id: 'creditAmount', label: "債權總額", type: "primary", icon: "file-text", isCurrency: true, width: 1 },
            { id: 'outstanding', label: "在外本金", type: "warning", icon: "dollar-sign", isCurrency: true, width: 1 },
            { id: 'currentLent', label: "目前放款額", type: "warning", icon: "credit-card", isCurrency: true, width: 1 },
            { id: 'monthDue', label: "本月應收款", type: "primary", icon: "credit-card", compact: true, isCurrency: true, width: 1 },
            { id: 'monthCollected', label: "本月已收款", type: "primary", icon: "check", compact: true, isCurrency: true, width: 1 },
            { id: 'monthDiff', label: "本月款差", type: "critical", icon: "alert-circle", compact: true, isCurrency: true, width: 1 },
            { id: 'monthInterestDiff', label: "本月息差", type: "critical", icon: "alert-circle", compact: true, isCurrency: true, width: 1 },
            { id: 'monthInterestDue', label: "本月應收息", type: "primary", icon: "trending-up", compact: true, isCurrency: true, width: 1 },
            { id: 'monthInterestCollected', label: "本月已收息", type: "primary", icon: "check", compact: true, isCurrency: true, width: 1 },
            { id: 'totalManagementFee', label: "本月管理費", type: "primary", icon: "credit-card", isCurrency: true, width: 1 },
            { id: 'badDebtAmount', label: "呆帳金額", type: "critical", icon: "x", isCurrency: true, width: 1 }
        ];
        
        // --- 核心欄位定義 ---
        const listFieldDefinitions = [
            { key: 'actions', label: '操作', isAction: true, widthVal: 120 }, // Sticky 1
            { key: 'caseNumber', label: '編號', bg: 'bg-gray-100', widthVal: 80 }, // Sticky 2
            { key: 'borrower', label: '借款人', font: 'font-bold', widthVal: 100 }, // Sticky 3
            { key: 'status', label: '狀態', widthVal: 80 }, // Sticky 4
            { key: 'paymentStatus', label: '本月繳款狀態', isComputed: true, widthVal: 100 }, // Sticky 5
            { key: 'repaidTerms', label: '還款期數(次)', widthVal: 90 },
            { key: 'method', label: '方式', widthVal: 80 },
            { key: 'date', label: '放款日期', widthVal: 100 },
            { key: 'loanAmount', label: '借款金額', isCurrency: true, widthVal: 100 },
            { key: 'disbursed', label: '放款金額', isCurrency: true, widthVal: 100 },
            { key: 'arrears', label: '欠款', isCurrency: true, isDanger: true, isComputed: true, widthVal: 100 },
            { key: 'outstanding', label: '在外本金', isCurrency: true, isComputed: true, widthVal: 100 },
            { key: 'interestRate', label: '利率(%)', isCurrency: false, widthVal: 80 },
            { key: 'agent', label: '銀行/人', widthVal: 100 },
            { key: 'terms', label: '期數', widthVal: 60 },
            { key: 'repayDay', label: '每期還款日', widthVal: 80 },
            { key: 'principalPerTerm', label: '每期還款本金', isCurrency: true, widthVal: 100 },
            { key: 'interestPerTerm', label: '每期利息', isCurrency: true, widthVal: 100 },
            { key: 'remainingTerms', label: '餘期', isComputed: true, widthVal: 60 },
            { key: 'roiTerms', label: '回本期數', isComputed: true, widthVal: 80 },
            { key: 'totalInterestIncome', label: '利息收入', isCurrency: true, widthVal: 100 },
            { key: 'note', label: '附註', isEditable: true, widthVal: 150 },
        ];
        const listStickyOffsets = [0, 120, 200, 300, 380];

        const state = {
            currentUser: null,
            currentUserUid: null,
            currentUserName: 'Guest', 
            isAdmin: false,
            allowedStatus: ['0', '1', '3', '4'],
            viewingUid: null,
            usersDirectory: [],
            
            isDemoMode: !firebaseAvailable,
            isRegistering: false,
            authLoading: false,
            activeTab: 'dashboard',
            records: [],
            cardLayout: initialCardLayout, 
            editingRecord: null,
            searchTerm: '',
            repaymentSearchTerm: '',
            selectedRepaymentId: '',
            repaymentDate: new Date().toISOString().split('T')[0],
            repaymentPrincipal: '',
            repaymentInterest: '',
            currentPage: 1,
            itemsPerPage: 10,
            modalType: null,
            showAIModal: false,
            activeModal: { type: null, record: null },
            tempScheduleLines: [],
            isLoadingListener: false,
            isImporting: false,
            unpaidFilter: null,
            
            // 新增：批次刪除相關狀態
            batchDeleteMode: false,
            selectedCasesForBatch: [],
            activeCasesFilter: true, // 修改：預設顯示狀態1、2和3的案件
            
            // 新增：卡片顏色設定
            cardColors: {} // Store card color preferences
        };

        // Demo Data
        if (state.isDemoMode) {
             state.records = [
                 { id: 'demo1', caseNumber: '#001', displayId: '#001', borrower: '王小明', status: '1', method: '叨簿子', loanAmount: 100000, disbursed: 90000, interestRate: 5.0, terms: 10, principalPerTerm: 10000, interestPerTerm: 5000, date: '2023-10-01', schedule: '2023-11-01 本金:10000 利息:5000\n2023-12-01 本金:10000 利息:5000', note: '正常繳款中', job: '工程師', agent: '張三', ownerUid: 'demo' },
                 { id: 'demo2', caseNumber: '#002', displayId: '#002', borrower: '李大華', status: '4', method: '設定', loanAmount: 500000, disbursed: 450000, interestRate: 3.0, specialRate: 5.0, terms: 0, principalPerTerm: 0, interestPerTerm: 15000, date: '2023-09-15', schedule: '', note: '代管案件，每月僅收息', job: '業務', agent: '李四', ownerUid: 'demo' },
                 { id: 'demo3', caseNumber: '#003', displayId: '#003', borrower: '陳淑芬', status: '3', method: '票貼', loanAmount: 30000, disbursed: 27000, interestRate: 10.0, terms: 3, principalPerTerm: 10000, interestPerTerm: 3000, date: '2023-11-01', schedule: '', note: '已失聯，列為呆帳', job: '自營商', agent: '王五', ownerUid: 'demo' },
                 { id: 'demo4', caseNumber: '#004', displayId: '#004', borrower: '張志豪', status: '0', method: '小額', loanAmount: 20000, disbursed: 20000, interestRate: 0, terms: 1, principalPerTerm: 20000, interestPerTerm: 0, date: '2023-08-01', schedule: '2023-08-05 本金:20000 利息:0', note: '已結清', job: '司機', agent: '趙六', ownerUid: 'demo' }
               ];
        }

        const initialFormState = {
            status: '1', method: '叨簿子', date: '', borrower: '', job: '',
            idNumber: '', address: '', telephone: '', mobile: '',
            loanAmount: '', disbursed: '', interestRate: '', specialRate: '', agent: '', 
            terms: '', repayDay: '', principalPerTerm: '', interestPerTerm: '',
            currentPrincipal: '', currentInterest: '', 
            note: '', schedule: ''
        };
        let formData = { ...initialFormState };

        // --- Helper Functions ---
        const formatNumber = (num) => {
            if (typeof num === 'string' && !/^-?\d/.test(num)) return num;
            if (num === '∞' || num === '-') return num;
            if (num === null || num === undefined || num === '') return "";
            const n = Number(num);
            if (isNaN(n)) return num; 
            return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        };
        
        // 修改：案件編號格式化，現在只是顯示用的序號
        const formatCaseId = (num) => {
            return `#${String(num).padStart(3, '0')}`;
        };
        
        // 新增：計算顯示編號（根據當前顯示的記錄順序）
        const calculateDisplayIds = (filteredRecords) => {
            return filteredRecords.map((record, index) => {
                return {
                    ...record,
                    displayId: formatCaseId(index + 1)
                };
            });
        };
        
        const extractDatesFromSchedule = (scheduleStr) => {
            if (!scheduleStr) return [];
            const regex = /\b(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})\b/g; 
            const matches = []; let match;
            while ((match = regex.exec(scheduleStr)) !== null) {
                const d = new Date(match[0].replace(/\//g, '-')); 
                if (!isNaN(d.getTime())) matches.push(d);
            }
            return matches;
        };
        
        const sortScheduleLines = (lines) => {
            return [...lines].sort((a, b) => {
                const datesA = extractDatesFromSchedule(a); const datesB = extractDatesFromSchedule(b);
                const dateA = datesA.length > 0 ? datesA[0] : null; const dateB = datesB.length > 0 ? datesB[0] : null;
                if (dateA && dateB) return dateA - dateB; if (dateA) return -1; if (dateB) return 1; return 0; 
            });
        };
        
        const getPaymentStatus = (record) => {
            if (record.status === '4') return { isPaid: true, isOverdue: false }; 
            const dates = extractDatesFromSchedule(record.schedule);
            const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
            let isPaidThisMonth = false;
            for (let d of dates) { if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) { isPaidThisMonth = true; break; } }
            if (!isPaidThisMonth && record.lastRepaymentDate) { const lastDate = new Date(record.lastRepaymentDate); if (lastDate.getMonth() === currentMonth && lastDate.getFullYear() === currentYear) isPaidThisMonth = true; }
            if (record.status === '0') return { isPaid: true, isOverdue: false };
            let repayDay = null; if (record.repayDay) { const match = String(record.repayDay).match(/(\d+)/); if (match) repayDay = parseInt(match[1], 10); }
            let isOverdue = false; if (!isPaidThisMonth && repayDay) { const currentDay = now.getDate(); if (currentDay > repayDay) isOverdue = true; }
            return { isPaid: isPaidThisMonth, isOverdue };
        };

        const parseSchedule = (scheduleStr) => {
            if (!scheduleStr) return [];
            const lines = scheduleStr.split('\n').filter(l => l.trim() !== '');
            return lines.map(line => {
                const dateMatch = line.match(/^(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/);
                
                let pMatch = line.match(/本金:(\d+)/);
                let iMatch = line.match(/利息:(\d+)/);
                
                if (!pMatch) pMatch = line.match(/P:(\d+)/);
                if (!iMatch) iMatch = line.match(/I:(\d+)/);
                
                const date = dateMatch ? new Date(dateMatch[1].replace(/\//g, '-')) : null;
                const principal = pMatch ? parseInt(pMatch[1], 10) : 0;
                const interest = iMatch ? parseInt(iMatch[1], 10) : 0;
                
                const raw = dateMatch ? `${dateMatch[0]} 本金:${principal} 利息:${interest}` : line;
                
                return { date, principal, interest, raw };
            }).filter(item => item.date !== null);
        };

        // 修改：外在本金計算公式，修正欠款計算
        const calculateDerivedData = (record) => {
            const loanAmount = Number(record.loanAmount) || 0; 
            const disbursed = Number(record.disbursed) || 0;
            
            const entries = parseSchedule(record.schedule);
            let totalPrincipalPaid = 0;
            let totalInterestPaid = 0;
            
            entries.forEach(e => {
                totalPrincipalPaid += e.principal;
                totalInterestPaid += e.interest;
            });

            if (record.status === '4') {
                return {
                    outstanding: record.outstandingPrincipal !== undefined ? Number(record.outstandingPrincipal) : (disbursed - totalPrincipalPaid - totalInterestPaid),
                    arrears: record.arrears !== undefined ? Number(record.arrears) : (loanAmount - totalPrincipalPaid), // 修改：欠款只減本金
                    remainingTerms: '-', 
                    roiTerms: '-',
                    totalPrincipalPaid,
                    totalInterestPaid
                };
            }

            if (record.status === '0' || record.status === '2') {
                return { 
                    outstanding: 0,
                    arrears: record.status === '0' ? 0 : (loanAmount - totalPrincipalPaid), // 修改：欠款只減本金
                    remainingTerms: '-', 
                    roiTerms: '-',
                    totalPrincipalPaid,
                    totalInterestPaid
                };
            }

            let outstanding = disbursed - totalPrincipalPaid - totalInterestPaid; 
            if (outstanding < 0) outstanding = 0; 

            let arrears = loanAmount - totalPrincipalPaid; // 修改：欠款只減本金

            let remainingTerms = '-'; 
            let roiTerms = "-";
            const method = record.method || ''; 
            const isSpecialMethod = ['設定', '票貼', '小額'].includes(method);
            
            if (!isSpecialMethod) {
                const terms = Number(record.terms) || 0; 
                const repaidTerms = entries.length;
                let val = terms - repaidTerms; 
                if (val < 0) val = 0; 
                remainingTerms = Math.floor(val); 
                
                const termPrincipal = Number(record.principalPerTerm) || 0; 
                const termInterest = Number(record.interestPerTerm) || 0; 
                const termTotal = termPrincipal + termInterest;
                
                if (record.status === '3') {
                    roiTerms = "∞"; 
                } else if (record.status === '1') { 
                    if (termTotal > 0 && outstanding > 0) { 
                        let val = outstanding / termTotal; 
                        if (val < 0) val = 0; 
                        // 避免 Infinity
                        if (val === Infinity) {
                            roiTerms = "∞";
                        } else {
                            roiTerms = Math.ceil(val);
                        }
                    } else if (outstanding <= 0) {
                        roiTerms = "0"; 
                    }
                }
            }
            
            return { outstanding, arrears, remainingTerms, roiTerms, totalPrincipalPaid, totalInterestPaid };
        };
        
        const getStatusLabel = (status) => {
            switch(String(status)) {
                case '0': return { text: '結案', color: 'bg-gray-100 text-gray-600' };
                case '1': return { text: '進行中', color: 'bg-emerald-100 text-emerald-600' };
                case '2': return { text: '代管中', color: 'bg-blue-100 text-blue-600' };
                case '3': return { text: '呆帳', color: 'bg-red-100 text-red-600' };
                case '4': return { text: '結案(呆)', color: 'bg-orange-100 text-orange-600' };
                default: return { text: status, color: 'bg-gray-100 text-gray-600' };
            }
        };

        // --- Logic ---
        const updateState = (updates) => { Object.assign(state, updates); renderApp(); };

        window.updateStatus4Amount = async (id, field, value) => {
            const val = Number(value) || 0;
            const idx = state.records.findIndex(r => r.id === id);
            
            if (idx !== -1) {
                const updatedRecord = { ...state.records[idx] };
                if (field === 'arrears') updatedRecord.arrears = val;
                else if (field === 'outstanding') updatedRecord.outstandingPrincipal = val;
                
                state.records[idx] = updatedRecord;
                renderApp();

                if (firebaseAvailable && state.currentUser) {
                    try {
                        const updateData = {};
                        if (field === 'arrears') updateData.arrears = val;
                        if (field === 'outstanding') updateData.outstandingPrincipal = val;
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'loan_records', id), updateData);
                    } catch (e) {
                        console.error("Update failed", e);
                        window.showError("更新失敗，請檢查網路連線。");
                    }
                }
            }
        };

        const calculateStats = () => {
            const s = { 
                totalIncome: 0, creditAmount: 0, outstanding: 0, 
                monthCollected: 0, monthInterestCollected: 0, monthDue: 0, monthInterestDue: 0, 
                borrowers: 0, 
                badDebtAmount: 0, 
                currentLent: 0, 
                monthDiff: 0, monthInterestDiff: 0, totalManagementFee: 0, 
                activeCases: 0, unpaidCount: 0, normalClosedCount: 0, closedBadDebtCount: 0, activeBadDebtCount: 0,
                unpaidRecords: [], closedRecords: [], activeRecords: [], badDebtCases: [], managedCases: 0, managedRecords: [] // 新增：代管案件相關
            };

            const uniqueBorrowers = new Set();
            
            // Filter records based on Admin View Mode
            let displayRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all' && state.viewingUid !== null) {
                displayRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                 displayRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }

            // 搜尋邏輯
            const searchTerm = state.searchTerm.toLowerCase();
            const filtered = displayRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm) ||
                 r.method?.toLowerCase().includes(searchTerm)) // 新增：搜尋方式
            );

            // 計算本月已收款和本月已收息
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            filtered.forEach(r => {
                const calc = calculateDerivedData(r); 
                const principal = Number(r.principalPerTerm) || 0; 
                const termInterest = Number(r.interestPerTerm) || 0;
                
                if (r.status === '1' || r.status === '3' || r.status === '4') {
                     s.creditAmount += calc.arrears;
                     s.outstanding += calc.outstanding;
                     s.currentLent += Number(r.disbursed) || 0;
                }

                if (r.status === '1') {
                    s.monthDue += (principal + termInterest);
                    s.monthInterestDue += termInterest; 
                } else if (r.status === '2') {
                    s.monthDue += termInterest; 
                    s.hasManagedCases = true;
                    s.totalManagementFee += termInterest; 
                    s.managedCases++; // 計算代管案件數
                    s.managedRecords.push(r); // 添加到代管案件列表
                }

                if (r.status === '3' || r.status === '4') {
                    s.badDebtAmount += calc.arrears;
                }

                if (r.status === '0') {
                    s.normalClosedCount++; s.closedRecords.push(r);
                } else if (r.status === '4') {
                    s.closedBadDebtCount++; s.badDebtCases.push(r);
                } else if (r.status === '3') {
                    s.activeBadDebtCount++; s.badDebtCases.push(r);
                } else if (r.status === '1') {
                    s.activeCases++; s.activeRecords.push(r);
                    const { isOverdue } = getPaymentStatus(r);
                    if (isOverdue) { s.unpaidCount++; s.unpaidRecords.push(r); }
                    
                    const { isPaid } = getPaymentStatus(r);
                    if (!isPaid) {
                        s.monthDiff += (principal + termInterest);
                        s.monthInterestDiff += termInterest;
                    }
                } else if (r.status === '2') {
                     const { isPaid } = getPaymentStatus(r);
                     if (!isPaid) {
                        s.monthDiff += termInterest; 
                     }
                }

                s.totalIncome += calc.totalInterestPaid; 
                
                // 計算本月已收款和本月已收息
                if (r.status === '1' || r.status === '2') {
                    const { isPaid } = getPaymentStatus(r);
                    if (isPaid) {
                        s.monthCollected += (r.status === '2' ? 0 : principal) + termInterest;
                        s.monthInterestCollected += termInterest;
                    }
                }

                if (r.borrower) uniqueBorrowers.add(r.borrower);
            });

            s.totalIncome -= s.badDebtAmount; 
            s.borrowers = uniqueBorrowers.size;
            return s;
        };

        const getCardConfig = (id) => {
            const stats = calculateStats(); if (!stats) return null;
            const layoutItem = state.cardLayout.find(c => c.id === id);
            const width = layoutItem ? layoutItem.width : 1;
            
            const config = {
                totalIncome: { label: "總收入 (累計)", value: stats.totalIncome, type: "primary", icon: "wallet", isCurrency: true },
                creditAmount: { label: "債權總額", value: stats.creditAmount, type: "primary", icon: "file-text", isCurrency: true },
                outstanding: { label: "在外本金", value: stats.outstanding, type: "warning", icon: "dollar-sign", isCurrency: true },
                currentLent: { label: "目前放款額", value: stats.currentLent, type: "warning", icon: "credit-card", isCurrency: true },
                monthDue: { label: "本月應收款", value: stats.monthDue, type: "primary", icon: "credit-card", compact: true, isCurrency: true },
                monthCollected: { label: "本月已收款", value: stats.monthCollected, type: "primary", icon: "check", compact: true, isCurrency: true },
                monthDiff: { label: "本月款差", value: stats.monthDiff, type: "critical", icon: "alert-circle", compact: true, isCurrency: true },
                monthInterestDiff: { label: "本月息差", value: stats.monthInterestDiff, type: "critical", icon: "alert-circle", compact: true, isCurrency: true },
                monthInterestDue: { label: "本月應收息", value: stats.monthInterestDue, type: "primary", icon: "trending-up", compact: true, isCurrency: true },
                monthInterestCollected: { label: "本月已收息", value: stats.monthInterestCollected, type: "primary", icon: "check", compact: true, isCurrency: true },
                totalManagementFee: { label: "本月管理費", value: stats.totalManagementFee, type: "primary", icon: "credit-card", isCurrency: true },
                badDebtAmount: { label: "呆帳金額", value: stats.badDebtAmount, type: "critical", icon: "x", isCurrency: true }
            };
            if (id === 'totalManagementFee' && !stats.hasManagedCases) return null;
            return { ...config[id], width };
        };

        // 新增：卡片顏色變更函數
        window.changeCardColor = (e, id) => {
            e.stopPropagation(); // 防止觸發卡片點擊開啟列表的事件
            const colors = ['primary', 'warning', 'critical', 'danger', 'info'];
            const current = state.cardColors[id] || 'primary'; // 預設是 primary
            const next = colors[(colors.indexOf(current) + 1) % colors.length]; // 循環切換下一個顏色
            state.cardColors[id] = next;
            renderApp(); // 重新渲染畫面
        };

        window.setActiveTab = (tab) => updateState({ activeTab: tab, modalType: null });
        window.updateState = (updates) => updateState(updates);
        window.handleDragStart = (e, id) => { e.dataTransfer.setData('cardId', id); };
        window.handleDragOver = (e) => { e.preventDefault(); };
        window.handleDrop = (e, targetId) => { e.preventDefault(); const sourceId = e.dataTransfer.getData('cardId'); if (sourceId && sourceId !== targetId) { const layout = [...state.cardLayout]; const fromIndex = layout.findIndex(c => c.id === sourceId); const toIndex = layout.findIndex(c => c.id === targetId); if (fromIndex !== -1 && toIndex !== -1) { const [moved] = layout.splice(fromIndex, 1); layout.splice(toIndex, 0, moved); updateState({ cardLayout: layout }); } } };
        window.resizeCard = (e, id) => { e.stopPropagation(); const layout = state.cardLayout.map(c => { if (c.id === id) { return { ...c, width: c.width === 2 ? 1 : 2 }; } return c; }); updateState({ cardLayout: layout }); };
        window.toggleAuthMode = () => { updateState({ isRegistering: !state.isRegistering }); };
        
        // 修正：Auth流程
        window.handleAuth = async (e) => { 
            e.preventDefault(); 
            if (!firebaseAvailable) { window.showError("Firebase 未設定，將無法儲存資料。"); return; } 
            
            const usernameInput = document.getElementById('authUsername').value.trim(); 
            const passwordInput = document.getElementById('authPassword').value; 
            const emailInput = state.isRegistering ? document.getElementById('authEmail').value.trim() : null;
            const confirmPass = state.isRegistering ? document.getElementById('authConfirmPassword').value : null;

            updateState({ authLoading: true }); 

            try { 
                const userDirCollection = collection(db, 'artifacts', appId, 'public', 'data', 'user_directory');

                if (state.isRegistering) { 
                    if (passwordInput !== confirmPass) throw new Error("密碼不一致"); 
                    
                    let role = 'user';
                    let allowedStatus = ['0', '1', '3', '4'];
                    
                    try {
                        const snapshot = await getDocs(query(userDirCollection));
                        
                        if (snapshot.empty) {
                            role = 'admin';
                            allowedStatus = ['0', '1', '2', '3', '4'];
                            console.log("第一個用戶，設定為管理員");
                        }
                    } catch (error) {
                        console.error("檢查用戶目錄失敗:", error);
                        role = 'user';
                    }
                    
                    const userCredential = await createUserWithEmailAndPassword(auth, emailInput, passwordInput); 
                    const user = userCredential.user; 
                    await updateProfile(user, { displayName: usernameInput }); 
                    
                    await setDoc(doc(userDirCollection, user.uid), { 
                        email: emailInput, 
                        uid: user.uid, 
                        username: usernameInput, 
                        role: role,
                        allowedStatus: allowedStatus,
                        createdAt: serverTimestamp() 
                    }); 
                    
                    window.showSuccess(role === 'admin' ? "註冊成功！您是本系統的管理員。" : "註冊成功！您是本系統的普通用戶。");
                    
                } else { 
                    const q = query(userDirCollection, where("username", "==", usernameInput));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        if (usernameInput.includes('@')) {
                            await signInWithEmailAndPassword(auth, usernameInput, passwordInput);
                        } else {
                            throw new Error("找不到帳號，請確認 ID 是否正確");
                        }
                    } else {
                        const userDoc = querySnapshot.docs[0];
                        const targetEmail = userDoc.data().email; 
                        await signInWithEmailAndPassword(auth, targetEmail, passwordInput); 
                    } 
                } 
            } catch (err) { 
                window.showError(err.message); 
                updateState({ authLoading: false }); 
            } 
        };

        window.handleLogout = async () => { 
            document.getElementById('confirm-modal')?.classList.add('hidden');
            document.getElementById('loading-modal')?.classList.add('hidden');
            
            if (firebaseAvailable) { 
                try { 
                    await signOut(auth); 
                } catch (e) { 
                    console.error(e); 
                } 
            }
            
            updateState({ 
                currentUser: null, 
                currentUserUid: null,
                currentUserName: 'Guest',
                isAdmin: false,
                allowedStatus: ['0', '1', '3', '4'],
                viewingUid: null,
                usersDirectory: [],
                isDemoMode: false,
                isRegistering: false,
                authLoading: false,
                activeTab: 'dashboard',
                records: [],
                cardLayout: initialCardLayout,
                editingRecord: null,
                searchTerm: '',
                repaymentSearchTerm: '',
                selectedRepaymentId: '',
                repaymentDate: new Date().toISOString().split('T')[0],
                repaymentPrincipal: '',
                repaymentInterest: '',
                currentPage: 1,
                itemsPerPage: 10,
                modalType: null,
                showAIModal: false,
                activeModal: { type: null, record: null },
                tempScheduleLines: [],
                isLoadingListener: false,
                isImporting: false,
                unpaidFilter: null,
                batchDeleteMode: false,
                selectedCasesForBatch: [],
                activeCasesFilter: true, // 保持預設顯示未結案案件（狀態1、2、3）
                cardColors: {} // 清除顏色設定
            });
            
            formData = { ...initialFormState };
            
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = '';
            
            const authUsername = document.getElementById('authUsername');
            const authPassword = document.getElementById('authPassword');
            const authEmail = document.getElementById('authEmail');
            const authConfirmPassword = document.getElementById('authConfirmPassword');
            
            if (authUsername) authUsername.value = '';
            if (authPassword) authPassword.value = '';
            if (authEmail) authEmail.value = '';
            if (authConfirmPassword) authConfirmPassword.value = '';
            
            if (typeof sessionStorage !== 'undefined') {
                sessionStorage.removeItem('firebase:authUser:' + firebaseConfig.apiKey + ':' + appId);
            }
            
            window.showSuccess("已成功登出系統");
        };
        
        window.openNewForm = () => { formData = { ...initialFormState }; updateState({ editingRecord: null, activeTab: 'form' }); };
        window.startEdit = (id) => { const record = state.records.find(r => r.id === id); if (record) { formData = { ...record }; updateState({ editingRecord: record, activeTab: 'form' }); } };
        
        window.handleSearch = (val) => { state.searchTerm = val; state.currentPage = 1; state.unpaidFilter = null; window.refreshListUI(); };
        window.changePage = (delta) => { state.currentPage += delta; window.refreshListUI(); };
        
        window.goToFirstPage = () => { state.currentPage = 1; window.refreshListUI(); };
        window.goToLastPage = () => { 
            let sourceRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all' && state.viewingUid !== null) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }
            
            const searchTerm = state.searchTerm.toLowerCase();
            let filtered = sourceRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm) ||
                 r.method?.toLowerCase().includes(searchTerm)) // 新增：搜尋方式
            );
            
            // 修正：按日期排序
            filtered.sort((a, b) => {
                const dateA = a.date ? new Date(a.date.replace(/\//g, '-')) : new Date('9999-12-31');
                const dateB = b.date ? new Date(b.date.replace(/\//g, '-')) : new Date('9999-12-31');
                return dateA - dateB;
            });
            
            if (state.unpaidFilter === 'all_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid } = getPaymentStatus(r);
                    return (r.status === '1' || r.status === '2') && !isPaid; // 修改：包括狀態2
                });
            } else if (state.unpaidFilter === 'current_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid, isOverdue } = getPaymentStatus(r);
                    return (r.status === '1' || r.status === '2') && !isPaid && isOverdue; // 修改：包括狀態2
                });
            }
            
            // 修正：篩選狀態1、2和3的案件
            if (state.activeCasesFilter) {
                filtered = filtered.filter(r => r.status === '1' || r.status === '2' || r.status === '3');
            }
            
            const totalPages = Math.ceil(filtered.length / state.itemsPerPage) || 1;
            state.currentPage = totalPages;
            window.refreshListUI(); 
        };
        
        window.goToPage = (pageNum) => { 
            let sourceRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all' && state.viewingUid !== null) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }
            
            const searchTerm = state.searchTerm.toLowerCase();
            let filtered = sourceRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm) ||
                 r.method?.toLowerCase().includes(searchTerm)) // 新增：搜尋方式
            );
            
            // 修正：按日期排序
            filtered.sort((a, b) => {
                const dateA = a.date ? new Date(a.date.replace(/\//g, '-')) : new Date('9999-12-31');
                const dateB = b.date ? new Date(b.date.replace(/\//g, '-')) : new Date('9999-12-31');
                return dateA - dateB;
            });
            
            if (state.unpaidFilter === 'all_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid } = getPaymentStatus(r);
                    return (r.status === '1' || r.status === '2') && !isPaid; // 修改：包括狀態2
                });
            } else if (state.unpaidFilter === 'current_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid, isOverdue } = getPaymentStatus(r);
                    return (r.status === '1' || r.status === '2') && !isPaid && isOverdue; // 修改：包括狀態2
                });
            }
            
            // 修正：篩選狀態1、2和3的案件
            if (state.activeCasesFilter) {
                filtered = filtered.filter(r => r.status === '1' || r.status === '2' || r.status === '3');
            }
            
            const totalPages = Math.ceil(filtered.length / state.itemsPerPage) || 1;
            const page = parseInt(pageNum);
            if (!isNaN(page) && page >= 1 && page <= totalPages) {
                state.currentPage = page;
                window.refreshListUI();
            }
        };
        
        window.filterUnpaidCases = (type) => {
            state.unpaidFilter = type;
            state.currentPage = 1;
            state.searchTerm = '';
            state.activeCasesFilter = false;
            window.refreshListUI();
        };
        
        window.showAllCases = () => {
            state.unpaidFilter = null;
            state.searchTerm = '';
            state.currentPage = 1;
            state.activeCasesFilter = false;
            window.refreshListUI();
        };

        // 修正：顯示所有未結案（狀態1、2和3）
        window.showActiveCases = () => {
            state.activeCasesFilter = true;
            state.unpaidFilter = null;
            state.searchTerm = '';
            state.currentPage = 1;
            window.refreshListUI();
        };

        // 新增：批次選擇相關功能
        window.toggleBatchDeleteMode = () => {
            updateState({ 
                batchDeleteMode: !state.batchDeleteMode,
                selectedCasesForBatch: [] 
            });
        };

        window.toggleSelectCaseForBatch = (caseId) => {
            const index = state.selectedCasesForBatch.indexOf(caseId);
            if (index === -1) {
                state.selectedCasesForBatch.push(caseId);
            } else {
                state.selectedCasesForBatch.splice(index, 1);
            }
            renderApp();
        };

        window.selectAllVisibleCasesForBatch = () => {
            let sourceRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all' && state.viewingUid !== null) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }

            const searchTerm = state.searchTerm.toLowerCase();
            let filtered = sourceRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm) ||
                 r.method?.toLowerCase().includes(searchTerm)) // 新增：搜尋方式
            );
            
            filtered.sort((a, b) => {
                const dateA = a.date ? new Date(a.date.replace(/\//g, '-')) : new Date('9999-12-31');
                const dateB = b.date ? new Date(b.date.replace(/\//g, '-')) : new Date('9999-12-31');
                return dateA - dateB;
            });
            
            if (state.unpaidFilter === 'all_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid } = getPaymentStatus(r);
                    return (r.status === '1' || r.status === '2') && !isPaid; // 修改：包括狀態2
                });
            } else if (state.unpaidFilter === 'current_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid, isOverdue } = getPaymentStatus(r);
                    return (r.status === '1' || r.status === '2') && !isPaid && isOverdue; // 修改：包括狀態2
                });
            }
            
            // 修正：篩選狀態1、2和3的案件
            if (state.activeCasesFilter) {
                filtered = filtered.filter(r => r.status === '1' || r.status === '2' || r.status === '3');
            }
            
            const currentRecords = filtered.slice((state.currentPage - 1) * state.itemsPerPage, state.currentPage * state.itemsPerPage);
            
            // 如果已經全選，則取消全選
            const allSelected = currentRecords.every(r => state.selectedCasesForBatch.includes(r.id));
            
            if (allSelected) {
                // 取消選擇所有可見案件
                currentRecords.forEach(r => {
                    const index = state.selectedCasesForBatch.indexOf(r.id);
                    if (index !== -1) {
                        state.selectedCasesForBatch.splice(index, 1);
                    }
                });
            } else {
                // 選擇所有可見案件
                currentRecords.forEach(r => {
                    if (!state.selectedCasesForBatch.includes(r.id)) {
                        state.selectedCasesForBatch.push(r.id);
                    }
                });
            }
            
            renderApp();
        };

        window.executeBatchDelete = async () => {
            if (state.selectedCasesForBatch.length === 0) {
                window.showError("請先選擇要刪除的案件");
                return;
            }

            const selectedCount = state.selectedCasesForBatch.length;
            const selectedRecords = state.records.filter(r => state.selectedCasesForBatch.includes(r.id));
            
            // 顯示確認訊息
            let message = `確定要刪除選取的 ${selectedCount} 筆案件嗎？<br>`;
            selectedRecords.slice(0, 5).forEach((r, i) => {
                message += `${i+1}. ${r.displayId || r.caseNumber || ''} - ${r.borrower}<br>`;
            });
            if (selectedCount > 5) {
                message += `... 還有 ${selectedCount - 5} 筆案件`;
            }
            message += "<br><br>此操作無法復原！";
            
            window.showConfirm(message, async (confirmed) => {
                if (!confirmed) return;

                showLoading(true, `正在刪除 ${selectedCount} 筆案件...`);

                try {
                    if (state.isDemoMode) {
                        // Demo模式：從本地記錄中刪除
                        state.records = state.records.filter(r => !state.selectedCasesForBatch.includes(r.id));
                        
                        showLoading(false);
                        window.showSuccess(`已成功刪除 ${selectedCount} 筆案件。`);
                        
                        // 退出批次刪除模式
                        updateState({ 
                            batchDeleteMode: false,
                            selectedCasesForBatch: [] 
                        });
                        
                    } else if (firebaseAvailable) {
                        // Firebase模式：批次刪除文件
                        const batch = writeBatch(db);
                        
                        selectedRecords.forEach(record => {
                            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'loan_records', record.id);
                            batch.delete(docRef);
                        });
                        
                        await batch.commit();
                        
                        showLoading(false);
                        window.showSuccess(`已成功刪除 ${selectedCount} 筆案件。`);
                        
                        // 退出批次刪除模式
                        updateState({ 
                            batchDeleteMode: false,
                            selectedCasesForBatch: [] 
                        });
                    }
                } catch (error) {
                    showLoading(false);
                    console.error("批次刪除失敗:", error);
                    window.showError(`批次刪除失敗: ${error.message}`);
                }
            });
        };

        // 修正：狀態2的公式計算 - 移除獨立的管理費欄位，將公式整合到管理費(合約)欄位
        window.updateFormData = (key, val, shouldRender = false) => { 
            formData[key] = val; 
            const loan = Number(formData.loanAmount) || 0; 
            const t = Number(formData.terms) || 0; 
            const interestRate = (parseFloat(formData.interestRate) || 0) / 100; 
            const specialRate = (parseFloat(formData.specialRate) || 0) / 100; 

            if (key === 'loanAmount' || key === 'terms' || key === 'status' || key === 'method') { 
                if (formData.status === '2') { 
                    // 狀態2：代管案件
                    if (formData.method === '叨簿子') {
                        // 叨簿子：應付 = (借款利率-利率)*借款金額 + 借款金額/期數
                        const principalPerTerm = t > 0 ? Math.round(loan / t) : 0;
                        const interestToClient = Math.round(loan * (specialRate - interestRate));
                        // 管理費 = 借款金額 * 利率
                        const managementFee = Math.round(loan * interestRate);
                        formData.principalPerTerm = principalPerTerm; // 應付本金部分
                        formData.interestPerTerm = managementFee; // 管理費（我們收）
                        formData.expectedPayment = interestToClient + principalPerTerm; // 應付總金額（給委託人）
                    } else {
                        // 非叨簿子：應付 = (借款利率-利率)*借款金額
                        const interestToClient = Math.round(loan * (specialRate - interestRate));
                        // 管理費 = 借款金額 * 利率
                        const managementFee = Math.round(loan * interestRate);
                        formData.principalPerTerm = 0;
                        formData.interestPerTerm = managementFee; // 管理費（我們收）
                        formData.expectedPayment = interestToClient; // 應付總金額（給委託人）
                    }
                } 
                else if ((formData.status === '1' || formData.method === '叨簿子') && t > 0) formData.principalPerTerm = Math.round(loan / t); 
                if (['設定', '票貼', '小額'].includes(formData.method)) { formData.principalPerTerm = 0; formData.terms = 0; } 
            } 
            
            if (key === 'status' || key === 'loanAmount' || key === 'interestRate' || key === 'specialRate') { 
                if (formData.status === '2') { 
                    // 重新計算狀態2的金額
                    const loan = Number(formData.loanAmount) || 0; 
                    const t = Number(formData.terms) || 0; 
                    const interestRate = (parseFloat(formData.interestRate) || 0) / 100; 
                    const specialRate = (parseFloat(formData.specialRate) || 0) / 100;
                    
                    if (formData.method === '叨簿子') {
                        const principalPerTerm = t > 0 ? Math.round(loan / t) : 0;
                        const interestToClient = Math.round(loan * (specialRate - interestRate));
                        const managementFee = Math.round(loan * interestRate);
                        formData.principalPerTerm = principalPerTerm;
                        formData.interestPerTerm = managementFee; // 管理費（我們收）
                        formData.expectedPayment = interestToClient + principalPerTerm;
                    } else {
                        const interestToClient = Math.round(loan * (specialRate - interestRate));
                        const managementFee = Math.round(loan * interestRate);
                        formData.principalPerTerm = 0;
                        formData.interestPerTerm = managementFee; // 管理費（我們收）
                        formData.expectedPayment = interestToClient;
                    }
                } 
                else { 
                    formData.interestPerTerm = Math.round(loan * interestRate); 
                } 
            } 

            if (shouldRender) { renderApp(); } 
            else { 
                const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; }; 
                const setText = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; }; 
                
                setVal('input_principalPerTerm', formData.principalPerTerm); 
                setVal('input_interestPerTerm', formData.interestPerTerm); 
                
                const calc = calculateDerivedData(formData); 
                setText('display_arrears', formatNumber(calc.arrears)); 
                setText('display_outstanding', formatNumber(calc.outstanding)); 
                
                if(formData.status === '2') { 
                    // 顯示應付金額（給委託人的錢）
                    setVal('input_expectedPayment', formatNumber(formData.expectedPayment || 0)); 
                } 
            } 
        };

        // 修正：儲存表單功能
        window.handleSaveForm = async () => { 
            if (!state.currentUser && !state.isDemoMode) { 
                window.showError("請先登入才能儲存資料。"); 
                return; 
            }
            
            if (formData.status === '2' && !state.allowedStatus.includes('2')) {
                window.showError("您沒有權限使用「代管案件」狀態（狀態2）。");
                return;
            }
            
            const dataToSave = { ...formData, updatedAt: serverTimestamp() }; 
            
            if (state.isDemoMode) { 
                if (!state.editingRecord) { 
                    const newRec = { 
                        ...dataToSave, 
                        id: `new_${Date.now()}`, 
                        caseNumber: '', 
                        createdAt: serverTimestamp(), 
                        ownerUid: 'demo' 
                    }; 
                    state.records.push(newRec); 
                } else { 
                    const idx = state.records.findIndex(r => r.id === state.editingRecord.id); 
                    if (idx !== -1) state.records[idx] = { ...state.records[idx], ...dataToSave }; 
                } 
                
            } else if (firebaseAvailable) { 
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'loan_records'); 
                
                if (!state.editingRecord) { 
                    dataToSave.createdAt = serverTimestamp(); 
                    dataToSave.ownerUid = state.currentUserUid;
                    
                    // 先儲存案件
                    const docRef = await addDoc(colRef, dataToSave);
                    
                    window.showSuccess(`案件資料已成功新增。`);
                } else { 
                    await updateDoc(doc(colRef, state.editingRecord.id), dataToSave);
                    window.showSuccess(`案件資料已成功更新。`);
                } 
            } 
            
            window.setActiveTab('list'); 
        };
        
        // 修正：刪除功能
        window.handleDelete = (id) => {
            window.showConfirm("確定要永久刪除此案件嗎？此操作無法復原。", async (confirmed) => {
                if (!confirmed) return;
                
                const recordToDelete = state.records.find(r => r.id === id);
                if (!recordToDelete) {
                    window.showError("找不到要刪除的案件");
                    return;
                }
                
                if (state.isDemoMode) {
                    // 刪除案件
                    state.records = state.records.filter(r => r.id !== id);
                    
                    renderApp();
                    window.showSuccess("案件已成功刪除。");
                } else if (firebaseAvailable) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'loan_records', id));
                        window.showSuccess("案件已成功刪除。");
                    } catch (e) {
                        console.error("刪除失敗:", e);
                        window.showError("刪除失敗，請檢查權限或連線。");
                    }
                }
            });
        };
        
        // Admin Functions
        window.toggleUserStatus2Permission = async (uid) => {
            if (!state.isAdmin) {
                window.showError("只有管理員可以修改權限");
                return;
            }
            
            if (uid === state.currentUserUid) {
                window.showError("無法修改自己的權限");
                return;
            }
            
            const targetUser = state.usersDirectory.find(u => u.uid === uid);
            if (!targetUser) {
                window.showError("找不到用戶資料");
                return;
            }
            
            const currentAllowed = targetUser.allowedStatus || [];

            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_directory', uid);
                let newAllowed = [...currentAllowed];
                
                if (newAllowed.includes('2')) {
                    newAllowed = newAllowed.filter(s => s !== '2');
                } else {
                    newAllowed.push('2');
                    newAllowed.sort();
                }
                
                await updateDoc(userRef, { allowedStatus: newAllowed });
                window.showSuccess("權限已更新");
            } catch(e) {
                console.error(e);
                window.showError("權限更新失敗");
            }
        };

        // 新增：清理無主案件功能
        window.cleanupOrphanedCases = async () => {
            if (!state.isAdmin) {
                window.showError("只有管理員可以清理無主案件");
                return;
            }
            
            window.showConfirm("確定要清理所有無主案件嗎？這些案件將被永久刪除且無法復原。", async (confirmed) => {
                if (!confirmed) return;
                
                showLoading(true, "正在檢查無主案件...");
                
                try {
                    // 取得所有用戶
                    const userDirCollection = collection(db, 'artifacts', appId, 'public', 'data', 'user_directory');
                    const userSnapshot = await getDocs(userDirCollection);
                    const validUserIds = userSnapshot.docs.map(doc => doc.id);
                    
                    // 取得所有案件
                    const loanRecordsRef = collection(db, 'artifacts', appId, 'public', 'data', 'loan_records');
                    const loanSnapshot = await getDocs(loanRecordsRef);
                    
                    const batch = writeBatch(db);
                    let deletedCount = 0;
                    
                    // 找出無主案件
                    loanSnapshot.docs.forEach((docSnap) => {
                        const data = docSnap.data();
                        if (!validUserIds.includes(data.ownerUid)) {
                            batch.delete(docSnap.ref);
                            deletedCount++;
                        }
                    });
                    
                    if (deletedCount > 0) {
                        await batch.commit();
                        window.showSuccess(`已成功刪除 ${deletedCount} 筆無主案件`);
                        
                        // 重新載入案件列表
                        if (state.isLoadingListener) {
                            state.isLoadingListener = false;
                        }
                    } else {
                        window.showSuccess("沒有發現無主案件");
                    }
                    
                    showLoading(false);
                } catch (error) {
                    showLoading(false);
                    console.error("清理無主案件失敗:", error);
                    window.showError(`清理失敗: ${error.message}`);
                }
            });
        };

        window.deleteUserAccount = async (uid, username) => {
            if (!state.isAdmin) {
                window.showError("只有管理員可以刪除帳號");
                return;
            }
            
            if (uid === state.currentUserUid) {
                window.showError("無法刪除自己的帳號");
                return;
            }
            
            window.showConfirm(`確定要永久刪除用戶 "${username}" 嗎？此操作將同時刪除該用戶的所有貸款記錄，且無法復原。`, async (confirmed) => {
                if (!confirmed) return;
                
                showLoading(true, "正在刪除用戶資料...");
                
                try {
                    const batch = writeBatch(db);
                    
                    // 1. 刪除用戶目錄中的記錄
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_directory', uid);
                    batch.delete(userRef);
                    
                    // 2. 刪除該用戶的所有貸款記錄
                    const loanRecordsRef = collection(db, 'artifacts', appId, 'public', 'data', 'loan_records');
                    const q = query(loanRecordsRef, where('ownerUid', '==', uid));
                    const querySnapshot = await getDocs(q);
                    
                    querySnapshot.docs.forEach((docSnap) => {
                        batch.delete(docSnap.ref);
                    });
                    
                    await batch.commit();
                    
                    // 更新本地狀態
                    state.usersDirectory = state.usersDirectory.filter(u => u.uid !== uid);
                    state.records = state.records.filter(r => r.ownerUid !== uid);
                    
                    if (state.viewingUid === uid) {
                        state.viewingUid = 'all';
                    }
                    
                    showLoading(false);
                    window.showSuccess(`用戶 "${username}" 已成功刪除`);
                    renderApp();
                    
                } catch (error) {
                    showLoading(false);
                    console.error("刪除用戶失敗:", error);
                    window.showError(`刪除用戶失敗: ${error.message}`);
                }
            });
        };

        window.updateRepaymentInput = (key, val) => { state[key] = val; };
        window.updateRepaymentSearch = (val) => { 
            state.repaymentSearchTerm = val; 
            state.selectedRepaymentId = ''; 
            
            let repaymentCases = state.records.filter(r => {
                if (r.status === '1') return true;
                if (r.status === '2' && state.allowedStatus.includes('2')) return true;
                return false;
            });
            
            const container = document.getElementById('repaymentDropdownContainer'); 
            const select = document.getElementById('repaymentSelect'); 
            if (container && select) { 
                if (val) { 
                    select.hidden = true; 
                    select.classList.add('hidden'); 
                    container.hidden = false; 
                    container.classList.remove('hidden'); 
                    const filteredOptions = repaymentCases.filter(r => { 
                        const { isPaid } = getPaymentStatus(r); 
                        const matchesSearch = (r.borrower||'').includes(val) || (r.displayId||'').includes(val) || (r.method||'').includes(val); // 新增：搜尋方式
                        return matchesSearch && !isPaid; 
                    }); 
                    if (filteredOptions.length > 0) { 
                        const html = filteredOptions.map(r => { 
                            const amount = (Number(r.currentPrincipal)||Number(r.principalPerTerm)||0) + (Number(r.currentInterest)||Number(r.interestPerTerm)||0); 
                            const displayId = r.displayId || r.caseNumber || ''; 
                            return `<div onclick="window.handleRepaymentSelect('${r.id}')" class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0 text-sm"><span class="font-bold text-gray-800">${displayId} - ${r.borrower || ''}</span><span class="block text-xs text-red-500">此案件本月尚未繳款</span><span class="block text-xs text-gray-500">每期應繳: $${formatNumber(amount)}</span></div>`; 
                        }).join(''); 
                        container.innerHTML = html; 
                    } else { 
                        container.innerHTML = `<div class="p-3 text-gray-500 text-sm text-center">找不到符合條件的未繳案件</div>`; 
                    } 
                } else { 
                    select.hidden = false; 
                    select.classList.remove('hidden'); 
                    container.hidden = true; 
                    container.classList.add('hidden'); 
                    container.innerHTML = ''; 
                } 
            } 
        };
        
        window.handleRepaymentSelect = (id) => { 
            const record = state.records.find(r => r.id === id); 
            if (record) { 
                const { isPaid } = getPaymentStatus(record); 
                const defP = record.currentPrincipal !== undefined && record.currentPrincipal !== "" ? Number(record.currentPrincipal) : Number(record.principalPerTerm);
                const defI = record.currentInterest !== undefined && record.currentInterest !== "" ? Number(record.currentInterest) : Number(record.interestPerTerm);

                updateState({ 
                    selectedRepaymentId: id, 
                    repaymentSearchTerm: '', 
                    repaymentPrincipal: isPaid || record.status === '2' ? 0 : defP, 
                    repaymentInterest: isPaid ? 0 : defI
                }); 
            } 
        };
        window.resetRepaymentSelection = () => updateState({ selectedRepaymentId: '', repaymentPrincipal: '', repaymentInterest: '' });
        
        window.submitRepayment = async () => { 
            const record = state.records.find(r => r.id === state.selectedRepaymentId); 
            if (!record) return; 
            
            const newEntry = `${state.repaymentDate} 本金:${Number(state.repaymentPrincipal)} 利息:${Number(state.repaymentInterest)}`;
            const currentSchedule = record.schedule || ''; 
            const newSchedule = (currentSchedule ? currentSchedule + '\n' : '') + newEntry;
            const sortedSchedule = sortScheduleLines(newSchedule.split('\n').filter(x=>x.trim())).join('\n'); 
            
            const data = { 
                schedule: sortedSchedule, 
                lastRepaymentDate: state.repaymentDate, 
                updatedAt: serverTimestamp() 
            }; 
            
            if (state.isDemoMode) { 
                const idx = state.records.findIndex(r => r.id === record.id); 
                if (idx !== -1) state.records[idx] = { ...state.records[idx], ...data }; 
                renderApp(); 
            } else if (firebaseAvailable) { 
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'loan_records', record.id), data); 
            } 
            
            window.showSuccess("入帳成功！財務指標已更新。"); 
            window.resetRepaymentSelection(); 
        };
        
        window.openModal = (type, id) => { const r = state.records.find(rec => rec.id === id); let lines = []; if (type === 'schedule') { lines = sortScheduleLines((r.schedule || '').split('\n').filter(l => l.trim() !== '')); } updateState({ activeModal: { type, record: r }, tempScheduleLines: lines }); };
        window.saveModalData = async (id, type) => { 
            let data = {}; 
            if (type === 'note') {
                const val = document.getElementById('modalTextarea') ? document.getElementById('modalTextarea').value : '';
                data.note = val; 
            } else { 
                const sorted = sortScheduleLines(state.tempScheduleLines).join('\n'); 
                data.schedule = sorted; 
                const r = state.records.find(rec => rec.id === id); 
                const count = extractDatesFromSchedule(sorted).length; 
                const dates = extractDatesFromSchedule(sorted); 
                let latestDate = null; 
                if (dates.length > 0) { 
                    dates.sort((a, b) => b - a); 
                    latestDate = dates[0].toISOString().split('T')[0]; 
                } 
                data.repaidTerms = count; 
                data.totalInterestIncome = count * (Number(r.interestPerTerm)||0); 
                data.actualReceivedMonth = count * (Number(r.principalPerTerm)||0); 
                if(latestDate) data.lastRepaymentDate = latestDate; 
            } 
            if (state.isDemoMode) { 
                const idx = state.records.findIndex(r => r.id === id); 
                if (idx !== -1) state.records[idx] = { ...state.records[idx], ...data }; 
                renderApp(); 
            } else if (firebaseAvailable) { 
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'loan_records', id), data); 
            } 
            updateState({ activeModal: { type: null, record: null } }); 
        };
        
        window.addScheduleLine = () => {
            const record = state.activeModal.record;
            const principal = Number(record.principalPerTerm) || 0;
            const interest = Number(record.interestPerTerm) || 0;
            const today = new Date().toISOString().split('T')[0];
            state.tempScheduleLines.push(`${today} 本金:${principal} 利息:${interest}`);
            renderApp();
        };
        
        window.updateScheduleLine = (index, value) => { state.tempScheduleLines[index] = value; }; 
        window.deleteScheduleLine = (index) => { state.tempScheduleLines.splice(index, 1); renderApp(); };
        window.handlePaymentStatusClick = (id) => { window.handleRepaymentSelect(id); updateState({ activeTab: 'repayment' }); };
        
        window.enterDemoMode = () => { 
            if(state.records.length === 0) { 
                state.records = [
                     { id: 'demo1', caseNumber: '#001', displayId: '#001', borrower: '王小明', status: '1', method: '叨簿子', loanAmount: 100000, disbursed: 90000, interestRate: 5.0, terms: 10, principalPerTerm: 10000, interestPerTerm: 5000, date: '2023-10-01', schedule: '2023-11-01 本金:10000 利息:5000\n2023-12-01 本金:10000 利息:5000', note: '正常繳款中', job: '工程師', agent: '張三', ownerUid: 'demo' },
                     { id: 'demo2', caseNumber: '#002', displayId: '#002', borrower: '李大華', status: '4', method: '設定', loanAmount: 500000, disbursed: 450000, interestRate: 3.0, specialRate: 5.0, terms: 0, principalPerTerm: 0, interestPerTerm: 15000, date: '2023-09-15', schedule: '', note: '代管案件，每月僅收息', job: '業務', agent: '李四', ownerUid: 'demo' },
                     { id: 'demo3', caseNumber: '#003', displayId: '#003', borrower: '陳淑芬', status: '3', method: '票貼', loanAmount: 30000, disbursed: 27000, interestRate: 10.0, terms: 3, principalPerTerm: 10000, interestPerTerm: 3000, date: '2023-11-01', schedule: '', note: '已失聯，列為呆帳', job: '自營商', agent: '王五', ownerUid: 'demo' },
                     { id: 'demo4', caseNumber: '#004', displayId: '#004', borrower: '張志豪', status: '0', method: '小額', loanAmount: 20000, disbursed: 20000, interestRate: 0, terms: 1, principalPerTerm: 20000, interestPerTerm: 0, date: '2023-08-01', schedule: '2023-08-05 本金:20000 利息:0', note: '已結清', job: '司機', agent: '趙六', ownerUid: 'demo' }
                ];
            }
            
            updateState({ 
                isDemoMode: true, 
                currentUser: 'Guest', 
                allowedStatus: ['0', '1', '3', '4'],
                isAdmin: false,
                activeCasesFilter: true // 預設顯示未結案案件（狀態1、2、3）
            }); 
        };
        window.openModalList = (type) => updateState({ modalType: type });

        // =======================================================
        // EXCEL EXPORT & VERTICAL CSV IMPORT LOGIC
        // =======================================================
        
        window.exportToExcel = () => {
            let sourceRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all' && state.viewingUid !== null) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }
            
            const searchTerm = state.searchTerm.toLowerCase();
            const filtered = sourceRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm) ||
                 r.method?.toLowerCase().includes(searchTerm)) // 新增：搜尋方式
            );
            
            // 按日期排序
            filtered.sort((a, b) => {
                const dateA = a.date ? new Date(a.date.replace(/\//g, '-')) : new Date('9999-12-31');
                const dateB = b.date ? new Date(b.date.replace(/\//g, '-')) : new Date('9999-12-31');
                return dateA - dateB;
            });
            
            // 計算顯示編號
            const filteredWithDisplayIds = calculateDisplayIds(filtered);
            
            if (filteredWithDisplayIds.length === 0) {
                window.showError("目前無資料可匯出");
                return;
            }

            let maxScheduleEntries = 0;
            filteredWithDisplayIds.forEach(record => {
                const entries = parseSchedule(record.schedule || '');
                if (entries.length > maxScheduleEntries) {
                    maxScheduleEntries = entries.length;
                }
            });
            
            const verticalFields = [
                '編號', '狀態', '方式', '放款日期', '借款人', '工作', 
                '借款金額', '放款金額', '利率(%)', '銀行/人', '期數', 
                '每期還款日期', '每期還款本金', '每期利息', '還款期數',
                '利息收入', '欠款', '在外本金', '餘期', '回本餘期', 
                '附註'
            ];
            
            let csvLines = [];
            
            verticalFields.forEach((fieldName) => {
                let rowValues = [fieldName];
                
                filteredWithDisplayIds.forEach((record) => {
                    let value = '';
                    const calc = calculateDerivedData(record);
                    
                    switch(fieldName) {
                        case '編號':
                            value = record.displayId || record.caseNumber || '';
                            break;
                        case '狀態':
                            value = getStatusLabel(record.status).text;
                            break;
                        case '方式':
                            value = record.method || '';
                            break;
                        case '放款日期':
                            value = record.date || '';
                            break;
                        case '借款人':
                            value = record.borrower || '';
                            break;
                        case '工作':
                            value = record.job || '';
                            break;
                        case '借款金額':
                            value = formatNumber(record.loanAmount || 0);
                            break;
                        case '放款金額':
                            value = formatNumber(record.disbursed || 0);
                            break;
                        case '利率(%)':
                            value = record.interestRate || 0;
                            break;
                        case '銀行/人':
                            value = record.agent || '';
                            break;
                        case '期數':
                            value = record.terms || 0;
                            break;
                        case '每期還款日期':
                            value = record.repayDay || '';
                            break;
                        case '每期還款本金':
                            value = formatNumber(record.principalPerTerm || 0);
                            break;
                        case '每期利息':
                            value = formatNumber(record.interestPerTerm || 0);
                            break;
                        case '還款期數':
                            value = parseSchedule(record.schedule).length;
                            break;
                        case '利息收入':
                            value = formatNumber(calc.totalInterestPaid || 0);
                            break;
                        case '欠款':
                            value = formatNumber(calc.arrears || 0);
                            break;
                        case '在外本金':
                            value = formatNumber(calc.outstanding || 0);
                            break;
                        case '餘期':
                            value = calc.remainingTerms || 0;
                            break;
                        case '回本餘期':
                            value = calc.roiTerms || 0;
                            break;
                        case '附註':
                            value = record.note || '';
                            break;
                        default:
                            value = '';
                    }
                    
                    rowValues.push(`"${String(value).replace(/"/g, '""')}"`);
                });
                
                csvLines.push(rowValues.join(','));
            });
            
            if (maxScheduleEntries > 0) {
                let scheduleTitleRow = ['還款日程'];
                filteredWithDisplayIds.forEach(() => scheduleTitleRow.push(''));
                csvLines.push(scheduleTitleRow.join(','));
                
                for (let i = 0; i < maxScheduleEntries; i++) {
                    let rowValues = [`還款${i + 1}`];
                    
                    filteredWithDisplayIds.forEach((record) => {
                        const entries = parseSchedule(record.schedule || '');
                        let value = '';
                        
                        if (i < entries.length) {
                            const entry = entries[i];
                            const dateStr = entry.date ? entry.date.toISOString().split('T')[0] : '';
                            value = `${dateStr} 本金:${formatNumber(entry.principal)} 利息:${formatNumber(entry.interest)}`;
                        }
                        
                        rowValues.push(`"${value}"`);
                    });
                    
                    csvLines.push(rowValues.join(','));
                }
            }
            
            const csvContent = csvLines.join('\n');
            
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `借貸管理資料_垂直格式_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Vertical CSV Import Logic
        const MAP_ROWS = {
            STATUS: 0,
            CATEGORY: 1,
            LOAN_DATE: 2,
            BORROWER: 3,
            JOB: 4,
            AMOUNT: 5,
            ACTUAL_AMOUNT: 6,
            INTEREST_RATE: 7,
            AGENT: 8,
            PERIODS: 9,
            RULE_DAY: 10,
            HISTORY_START: 11
        };
        
        const cleanNumber = (val) => val ? parseFloat(String(val).replace(/,/g, '').replace(/%/g, '').trim()) : 0;
        
        const parseCSV = (text) => {
            const rawRows = text.trim().split(/\r\n|\n/).filter(row => row.trim() !== '');
            
            const rows = rawRows.map(row => {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < row.length; j++) {
                    const char = row[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                return values.map(v => v.replace(/^"(.*)"$/, '$1').replace(/""/g, '"'));
            });

            if (rows.length === 0) return [];
            
            const parsedCases = [];
            const totalCols = rows[0].length;
            const startingCol = 1;

            console.log(`CSV解析：總列數=${totalCols}, 從第${startingCol}列開始解析`);

            for (let col = startingCol; col < totalCols; col++) {
                const borrowerName = rows[MAP_ROWS.BORROWER]?.[col]?.trim();
                const loanAmount = cleanNumber(rows[MAP_ROWS.AMOUNT]?.[col]);
                
                if (!borrowerName && loanAmount === 0) {
                    console.log(`跳過第${col}列：無借款人名稱且借款金額為0`);
                    continue;
                }

                let status = String(rows[MAP_ROWS.STATUS]?.[col] || '1').trim();
                const terms = cleanNumber(rows[MAP_ROWS.PERIODS]?.[col]);
                const interestRateFloat = cleanNumber(rows[MAP_ROWS.INTEREST_RATE]?.[col]) / 100;

                if (!['0', '1', '2', '3', '4'].includes(status)) {
                    const statusText = status.toLowerCase();
                    if (statusText.includes('進行') || statusText.includes('正常')) status = '1';
                    else if (statusText.includes('代管')) status = '2';
                    else if (statusText.includes('呆帳')) status = '3';
                    else if (statusText.includes('結案')) status = '0';
                    else status = '1';
                }

                let principalPerTerm = 0;
                if (status !== '2' && terms > 0) {
                    principalPerTerm = Math.round(loanAmount / terms);
                }
                const interestPerTerm = Math.round(loanAmount * interestRateFloat);

                const scheduleLines = [];
                let lastRepaymentDate = '';

                const scheduleRowIndex = rows.findIndex(row => row[0]?.includes('還款日程'));
                if (scheduleRowIndex !== -1 && rows[scheduleRowIndex]?.[col]) {
                    const scheduleText = rows[scheduleRowIndex][col];
                    if (scheduleText) {
                        const scheduleEntries = scheduleText.split('|').map(entry => entry.trim());
                        scheduleEntries.forEach(entry => {
                            if (entry) {
                                const dateMatch = entry.match(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/);
                                const principalMatch = entry.match(/本金[:\s]*(\d+)/);
                                const interestMatch = entry.match(/利息[:\s]*(\d+)/);
                                
                                if (dateMatch) {
                                    const cleanDate = dateMatch[0].replace(/\//g, '-');
                                    const principal = principalMatch ? parseInt(principalMatch[1], 10) : principalPerTerm;
                                    const interest = interestMatch ? parseInt(interestMatch[1], 10) : interestPerTerm;
                                    scheduleLines.push(`${cleanDate} 本金:${principal} 利息:${interest}`);
                                }
                            }
                        });
                    }
                }
                
                if (scheduleLines.length === 0) {
                    for (let rowIdx = MAP_ROWS.HISTORY_START; rowIdx < rows.length; rowIdx++) {
                        const historyDateStr = rows[rowIdx]?.[col]?.trim();
                        if (historyDateStr && /\d{4}[-\/]\d{1,2}[-\/]\d{1,2}/.test(historyDateStr)) {
                            const cleanDate = historyDateStr.replace(/\//g, '-');
                            const entry = `${cleanDate} 本金:${principalPerTerm} 利息:${interestPerTerm}`;
                            scheduleLines.push(entry);
                        }
                    }
                }
                
                const sortedSchedule = sortScheduleLines(scheduleLines).join('\n');
                const repaidTermsCount = extractDatesFromSchedule(sortedSchedule).length;
                const totalInterestIncome = repaidTermsCount * interestPerTerm;
                
                if (repaidTermsCount > 0) {
                    const allDates = extractDatesFromSchedule(sortedSchedule);
                    allDates.sort((a, b) => b.getTime() - a.getTime());
                    if (allDates.length > 0) lastRepaymentDate = allDates[0].toISOString().split('T')[0];
                }

                // 修正：確保放款日期被正確解析
                let loanDate = rows[MAP_ROWS.LOAN_DATE]?.[col] || '';
                // 嘗試格式化日期
                if (loanDate) {
                    // 嘗試轉換各種日期格式
                    const dateMatch = loanDate.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
                    if (dateMatch) {
                        const year = dateMatch[1];
                        const month = dateMatch[2].padStart(2, '0');
                        const day = dateMatch[3].padStart(2, '0');
                        loanDate = `${year}-${month}-${day}`;
                    }
                }

                const newCase = {
                    status: status,
                    method: rows[MAP_ROWS.CATEGORY]?.[col] || '',
                    date: loanDate, // 修正：使用格式化後的日期
                    borrower: borrowerName || `未知借款人_${col}`,
                    job: rows[MAP_ROWS.JOB]?.[col] || '',
                    loanAmount: loanAmount,
                    disbursed: cleanNumber(rows[MAP_ROWS.ACTUAL_AMOUNT]?.[col]) || loanAmount,
                    interestRate: cleanNumber(rows[MAP_ROWS.INTEREST_RATE]?.[col]) || 0,
                    agent: rows[MAP_ROWS.AGENT]?.[col] || '',
                    terms: terms,
                    repayDay: rows[MAP_ROWS.RULE_DAY]?.[col] || '',
                    principalPerTerm: principalPerTerm,
                    interestPerTerm: interestPerTerm,
                    schedule: sortedSchedule,
                    repaidTerms: repaidTermsCount,
                    totalInterestIncome: totalInterestIncome,
                    lastRepaymentDate: lastRepaymentDate,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    note: rows.find(row => row[0]?.includes('附註'))?.[col] || '',
                    idNumber: '', 
                    address: '', 
                    telephone: '', 
                    mobile: '',
                };
                
                console.log(`解析第${col}列案件：${newCase.borrower}, 狀態=${newCase.status}, 金額=${newCase.loanAmount}, 放款日期=${newCase.date}`);
                parsedCases.push(newCase);
            }
            
            console.log(`CSV解析完成：共解析 ${parsedCases.length} 筆案件`);
            return parsedCases;
        };
        
        const showLoading = (show, text = "處理中...") => {
            const modal = document.getElementById('loading-modal');
            const textEl = document.getElementById('loading-text');
            if (modal) {
                if (show) {
                    modal.classList.remove('hidden');
                    if (textEl) textEl.textContent = text;
                    state.isImporting = true;
                } else {
                    modal.classList.add('hidden');
                    state.isImporting = false;
                }
            }
            renderApp(); 
        };

        window.handleFileSelect = () => { document.getElementById('csvFileInput').click(); };

        window.handleFileChange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) { window.showError("請選擇有效的 CSV 檔案。"); return; }

            const reader = new FileReader();
            reader.readAsText(file, 'Big5');

            reader.onload = async (e) => {
                const csvText = e.target.result;
                try { await window.processCsvData(csvText); } 
                catch (error) { showLoading(false); console.error("CSV 處理失敗:", error); window.showError(`CSV 匯入處理失敗。`); }
            };
            event.target.value = ''; 
        };
        
        window.processCsvData = async (csvText) => {
            if (!state.currentUser && !state.isDemoMode) { window.showError("請先登入才能匯入資料。"); return; }
            
            showLoading(true, "正在解析檔案及計算合約金額...");
            
            let records = [];
            try { records = parseCSV(csvText); } 
            catch (e) { showLoading(false); window.showError(`CSV 解析錯誤: ${e.message}`); return; }
            
            if (records.length === 0) { showLoading(false); window.showError("CSV 檔案內容為空或無法解析出有效案件。"); return; }
            
            if (state.isDemoMode) {
                const demoRecords = records.map(r => ({ 
                    ...r, 
                    createdAt: new Date().getTime(), 
                    updatedAt: new Date().getTime(), 
                    id: `new_demo_${Math.random()}`, 
                    ownerUid: 'demo' 
                }));
                state.records = [...state.records, ...demoRecords];
                
                showLoading(false);
                window.showSuccess(`本地試用模式：成功匯入 ${records.length} 筆案件。`);
                renderApp();
                return;
            }

            if (firebaseAvailable) {
                try {
                    const batch = writeBatch(db);
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'loan_records');
                    
                    records.forEach((record) => {
                        const newDocRef = doc(colRef);
                        batch.set(newDocRef, {
                            ...record,
                            ownerUid: state.currentUserUid,
                            caseNumber: '',
                            displayId: ''
                        });
                    });

                    await batch.commit();
                    
                    showLoading(false);
                    window.showSuccess(`成功匯入 ${records.length} 筆新案件！`);
                } catch (e) {
                    showLoading(false);
                    console.error("Firebase 批次寫入失敗:", e);
                    window.showError(`資料庫寫入失敗: ${e.message}`);
                }
            }
        };

        // 生成手機版卡片HTML
        const generateMobileCardsHtml = () => {
            let sourceRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all' && state.viewingUid !== null) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }

            const searchTerm = state.searchTerm.toLowerCase();
            let filtered = sourceRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm) ||
                 r.method?.toLowerCase().includes(searchTerm)) // 新增：搜尋方式
            );
            
            // 修正排序邏輯：按放款日期排序（從舊到新）
            filtered.sort((a, b) => {
                const dateA = a.date ? new Date(a.date.replace(/\//g, '-')) : new Date('9999-12-31');
                const dateB = b.date ? new Date(b.date.replace(/\//g, '-')) : new Date('9999-12-31');
                return dateA - dateB;
            });
            
            if (state.unpaidFilter === 'all_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid } = getPaymentStatus(r);
                    return (r.status === '1' || r.status === '2') && !isPaid; // 修改：包括狀態2
                });
            } else if (state.unpaidFilter === 'current_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid, isOverdue } = getPaymentStatus(r);
                    return (r.status === '1' || r.status === '2') && !isPaid && isOverdue; // 修改：包括狀態2
                });
            }
            
            // 修正：篩選狀態1、2和3的案件
            if (state.activeCasesFilter) {
                filtered = filtered.filter(r => r.status === '1' || r.status === '2' || r.status === '3');
            }
            
            // 計算顯示編號
            const filteredWithDisplayIds = calculateDisplayIds(filtered);
            
            const currentRecords = filteredWithDisplayIds.slice((state.currentPage - 1) * state.itemsPerPage, state.currentPage * state.itemsPerPage);
            
            if (filteredWithDisplayIds.length === 0) {
                return `<div class="p-8 text-center text-gray-400">目前無資料，請點擊新增案件</div>`;
            }

            return currentRecords.map(r => {
                const { isPaid, isOverdue } = getPaymentStatus(r);
                const calc = calculateDerivedData(r);
                const statusLbl = getStatusLabel(r.status);
                
                // 根據狀態設定借款人名字顏色
                let borrowerColorClass = '';
                switch(r.status) {
                    case '0': borrowerColorClass = 'text-gray-400'; break;
                    case '2': borrowerColorClass = 'text-blue-600'; break;
                    case '3': borrowerColorClass = 'text-red-600'; break;
                    case '4': borrowerColorClass = 'text-orange-600'; break;
                    default: borrowerColorClass = 'text-gray-800';
                }
                
                let paymentStatusClass = 'unpaid';
                let paymentStatusText = '未繳';
                let paymentStatusIcon = 'alert-circle';
                
                if (isPaid) {
                    paymentStatusClass = 'paid';
                    paymentStatusText = '已繳清';
                    paymentStatusIcon = 'check';
                } else if (isOverdue) {
                    paymentStatusClass = 'overdue';
                    paymentStatusText = '逾期未繳';
                    paymentStatusIcon = 'alert-triangle';
                }
                
                const termAmount = (Number(r.principalPerTerm) || 0) + (Number(r.interestPerTerm) || 0);
                
                // 批次選擇模式的卡片
                if (state.batchDeleteMode) {
                    const isSelected = state.selectedCasesForBatch.includes(r.id);
                    
                    return `
                    <div class="mobile-case-card mobile-batch-select-card">
                        <div class="mobile-batch-select">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="window.toggleSelectCaseForBatch('${r.id}')" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        </div>
                        <div class="mobile-case-header">
                            <div>
                                <div class="flex items-center">
                                    <span class="mobile-case-id">${r.displayId || r.caseNumber || ''}</span>
                                    <span class="mobile-status-badge ${statusLbl.color}">${statusLbl.text}</span>
                                </div>
                                <div class="mobile-borrower-name ${borrowerColorClass}">${r.borrower || ''}</div>
                                <div class="mobile-payment-status ${paymentStatusClass}">
                                    <i data-lucide="${paymentStatusIcon}" class="w-3 h-3 mr-1"></i>
                                    ${paymentStatusText}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mobile-case-details">
                            <div class="mobile-detail-item">
                                <span class="mobile-detail-label">借款金額</span>
                                <span class="mobile-detail-value">$${formatNumber(r.loanAmount || 0)}</span>
                            </div>
                            <div class="mobile-detail-item">
                                <span class="mobile-detail-label">放款金額</span>
                                <span class="mobile-detail-value">$${formatNumber(r.disbursed || 0)}</span>
                            </div>
                            <div class="mobile-detail-item">
                                <span class="mobile-detail-label">欠款</span>
                                <span class="mobile-detail-value text-red-600 font-bold">$${formatNumber(calc.arrears || 0)}</span>
                            </div>
                            <div class="mobile-detail-item">
                                <span class="mobile-detail-label">在外本金</span>
                                <span class="mobile-detail-value">$${formatNumber(calc.outstanding || 0)}</span>
                            </div>
                        </div>
                    </div>
                    `;
                }
                
                // 正常模式的卡片
                return `
                <div class="mobile-case-card">
                    <div class="mobile-case-header">
                        <div>
                            <div class="flex items-center">
                                <span class="mobile-case-id">${r.displayId || r.caseNumber || ''}</span>
                                <span class="mobile-status-badge ${statusLbl.color}">${statusLbl.text}</span>
                            </div>
                            <div class="mobile-borrower-name ${borrowerColorClass}">${r.borrower || ''}</div>
                            <div class="mobile-payment-status ${paymentStatusClass}">
                                <i data-lucide="${paymentStatusIcon}" class="w-3 h-3 mr-1"></i>
                                ${paymentStatusText}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mobile-case-details">
                        <div class="mobile-detail-item">
                            <span class="mobile-detail-label">借款金額</span>
                            <span class="mobile-detail-value">$${formatNumber(r.loanAmount || 0)}</span>
                        </div>
                        <div class="mobile-detail-item">
                            <span class="mobile-detail-label">放款金額</span>
                            <span class="mobile-detail-value">$${formatNumber(r.disbursed || 0)}</span>
                        </div>
                        <div class="mobile-detail-item">
                            <span class="mobile-detail-label">欠款</span>
                            <span class="mobile-detail-value text-red-600 font-bold">$${formatNumber(calc.arrears || 0)}</span>
                        </div>
                        <div class="mobile-detail-item">
                            <span class="mobile-detail-label">在外本金</span>
                            <span class="mobile-detail-value">$${formatNumber(calc.outstanding || 0)}</span>
                        </div>
                        <div class="mobile-detail-item">
                            <span class="mobile-detail-label">每期應繳</span>
                            <span class="mobile-detail-value">$${formatNumber(termAmount)}</span>
                        </div>
                        <div class="mobile-detail-item">
                            <span class="mobile-detail-label">利率</span>
                            <span class="mobile-detail-value">${r.interestRate || 0}%</span>
                        </div>
                    </div>
                    
                    <div class="mobile-case-actions">
                        <button onclick="window.handlePaymentStatusClick('${r.id}')" class="mobile-action-button ${isPaid ? 'bg-emerald-100 text-emerald-600 hover:bg-emerald-200' : 'bg-red-100 text-red-600 hover:bg-red-200'}" title="還款入帳">
                            <i data-lucide="banknote" class="w-4 h-4"></i>
                        </button>
                        <button onclick="window.startEdit('${r.id}')" class="mobile-action-button bg-blue-100 text-blue-600 hover:bg-blue-200" title="編輯">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="window.handleDelete('${r.id}')" class="mobile-action-button bg-red-100 text-red-600 hover:bg-red-200" title="刪除">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        };

        // 修正：refreshListUI 函數，確保案件排序正確
        window.refreshListUI = () => {
            const tbody = document.getElementById('loanListBody');
            const mobileContainer = document.getElementById('mobileListContainer');
            const paginationInfo = document.getElementById('paginationInfo');
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            const btnFirst = document.getElementById('btnFirst');
            const btnLast = document.getElementById('btnLast');
            const pageInput = document.getElementById('pageInput');
            const pageGoBtn = document.getElementById('pageGoBtn');

            if (tbody) {
                let sourceRecords = state.records;
                if (state.isAdmin && state.viewingUid !== 'all' && state.viewingUid !== null) {
                    sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
                } else if (!state.isAdmin && !state.isDemoMode) {
                    sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
                }

                const searchTerm = state.searchTerm.toLowerCase();
                let filtered = sourceRecords.filter(r => 
                    (r.borrower?.toLowerCase().includes(searchTerm) || 
                     r.displayId?.toLowerCase().includes(searchTerm) ||
                     r.method?.toLowerCase().includes(searchTerm)) // 新增：搜尋方式
                );
                
                // 修正排序邏輯：按照放款日期排序
                filtered.sort((a, b) => {
                    const dateA = a.date ? new Date(a.date.replace(/\//g, '-')) : new Date('9999-12-31');
                    const dateB = b.date ? new Date(b.date.replace(/\//g, '-')) : new Date('9999-12-31');
                    return dateA - dateB;
                });
                
                if (state.unpaidFilter === 'all_unpaid') {
                    filtered = filtered.filter(r => {
                        const { isPaid } = getPaymentStatus(r);
                        return (r.status === '1' || r.status === '2') && !isPaid; // 修改：包括狀態2
                    });
                } else if (state.unpaidFilter === 'current_unpaid') {
                    filtered = filtered.filter(r => {
                        const { isPaid, isOverdue } = getPaymentStatus(r);
                        return (r.status === '1' || r.status === '2') && !isPaid && isOverdue; // 修改：包括狀態2
                    });
                }
                
                // 修正：篩選狀態1、2和3的案件
                if (state.activeCasesFilter) {
                    filtered = filtered.filter(r => r.status === '1' || r.status === '2' || r.status === '3');
                }
                
                // 計算顯示編號
                const filteredWithDisplayIds = calculateDisplayIds(filtered);
                
                const currentRecords = filteredWithDisplayIds.slice((state.currentPage - 1) * state.itemsPerPage, state.currentPage * state.itemsPerPage);
                
                if (filteredWithDisplayIds.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${state.batchDeleteMode ? listFieldDefinitions.length + 1 : listFieldDefinitions.length}" class="p-8 text-center text-gray-400">目前無資料，請點擊新增案件</td></tr>`;
                } else {
                    tbody.innerHTML = currentRecords.map(r => {
                        const { isPaid, isOverdue } = getPaymentStatus(r);
                        const calc = calculateDerivedData(r);
                        const statusLbl = getStatusLabel(r.status);
                        const isBadDebt = r.status === '3';
                        const isClosedBadDebt = r.status === '4';
                        
                        // 根據狀態設定借款人名字顏色
                        let borrowerColorClass = '';
                        switch(r.status) {
                            case '0': borrowerColorClass = 'text-gray-400'; break;
                            case '2': borrowerColorClass = 'text-blue-600'; break;
                            case '3': borrowerColorClass = 'text-red-600'; break;
                            case '4': borrowerColorClass = 'text-orange-600'; break;
                            default: borrowerColorClass = 'text-gray-800';
                        }
                        
                        // 批次選擇模式的checkbox欄位
                        const batchSelectCell = state.batchDeleteMode ? 
                            `<td class="py-2 px-2 text-center select-checkbox" style="min-width: 40px; max-width: 40px; position: sticky; left: 0; z: 20; background-color: white; border-right: 1px solid #e5e7eb;">
                                <input type="checkbox" ${state.selectedCasesForBatch.includes(r.id) ? 'checked' : ''} onclick="window.toggleSelectCaseForBatch('${r.id}')" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </td>` : '';

                        const regularCells = listFieldDefinitions.map((field, idx) => {
                            let content = '';
                            let val = r[field.key];
                            
                            if (field.key === 'caseNumber') {
                                val = r.displayId || r.caseNumber || ''; 
                            }

                            if (isBadDebt) {
                                if (field.key === 'loanAmount' || field.key === 'disbursed') val = 0;
                            }
                            if (isClosedBadDebt) {
                                if (field.key === 'principalPerTerm' || field.key === 'interestPerTerm') val = 0;
                            }

                            if (field.isComputed) {
                                if (field.key === 'paymentStatus') {
                                    if (isBadDebt) {
                                        content = `<div class="flex items-center justify-center p-2"><span class="text-gray-500 font-bold flex items-center text-xs bg-gray-100 px-2 py-1 rounded border border-gray-200 cursor-not-allowed" title="此案件已轉為呆帳"><i data-lucide="gavel" class="w-3 h-3 mr-1"></i>法務程序中</span></div>`;
                                    } else {
                                        content = `<div onclick="window.handlePaymentStatusClick('${r.id}')" class="flex items-center justify-center cursor-pointer p-2 rounded transition-colors ${isPaid ? 'hover:bg-emerald-200' : 'hover:bg-red-100'}" title="點擊前往還款頁面">${isPaid ? `<span class="text-emerald-600 font-bold flex items-center"><i data-lucide="check" class="w-3 h-3 mr-1"></i>已繳清</span>` : `<span class="font-bold flex items-center ${isOverdue ? 'text-red-700' : 'text-red-600'}">${isOverdue ? '<i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i>逾期未繳' : '未繳'}</span>`}</div>`;
                                    }
                                } else if (field.key === 'remainingTerms') content = calc.remainingTerms;
                                else if (field.key === 'roiTerms') content = calc.roiTerms;
                                else if (field.key === 'arrears') content = `<span class="font-mono ${Number(calc.arrears)>0?'text-red-600 font-bold':''}">${formatNumber(calc.arrears)}</span>`;
                                else if (field.key === 'outstanding') content = `<span class="font-mono font-bold">${formatNumber(calc.outstanding)}</span>`;
                                
                                if (isClosedBadDebt && (field.key === 'arrears' || field.key === 'outstanding')) {
                                    const inputVal = field.key === 'arrears' ? calc.arrears : calc.outstanding;
                                    const isRed = field.key === 'arrears';
                                    content = `<input type="number" value="${inputVal}" onchange="window.updateStatus4Amount('${r.id}', '${field.key}', this.value)" class="table-input w-24 p-1.5 border border-gray-300 rounded text-right font-mono text-xs ${isRed ? 'text-red-600 font-bold' : 'text-gray-700'}" onclick="event.stopPropagation()" title="可手動修改金額">`;
                                }

                            } else if (field.isAction) {
                                content = `<div class="flex space-x-2 justify-center items-center"><button onclick="window.startEdit('${r.id}')" class="text-blue-600 hover:text-blue-800 bg-blue-50 p-1 rounded" title="編輯"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="window.handleDelete('${r.id}')" class="text-red-600 hover:text-red-800 bg-red-50 p-1 rounded" title="刪除整筆案件"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                            } else if (field.key === 'status') {
                                content = `<span class="px-2 py-1 rounded text-xs ${statusLbl.color}">${statusLbl.text}</span>`;
                            } else if (field.key === 'repaidTerms') {
                                content = `<div class="cursor-pointer text-blue-600 font-bold hover:underline flex items-center justify-center" onclick="window.openModal('schedule', '${r.id}')" title="點擊查看還款日程">${parseSchedule(r.schedule).length} <i data-lucide="calendar-days" class="w-3 h-3 ml-1"></i></div>`;
                            } else if (field.key === 'borrower') {
                                // 借款人欄位：根據狀態設定顏色
                                content = `<span class="${borrowerColorClass} font-bold">${val}</span>`;
                            } else if (field.isEditable) {
                                const icon = field.key === 'note' ? 'file-pen-line' : 'calendar-days';
                                content = `<button onclick="window.openModal('${field.key}', '${r.id}')" class="flex items-center justify-center text-gray-500 hover:text-blue-600 bg-gray-100 hover:bg-blue-50 px-3 py-1 rounded-md text-xs transition-colors mx-auto"><i data-lucide="${icon}" class="w-3 h-3 mr-1"></i>檢視/編輯</button>`;
                            } else {
                                if (val === undefined || val === null) val = '-';
                                if (field.key === 'totalInterestIncome') val = calc.totalInterestPaid;
                                content = `<span class="${field.isCurrency ? 'font-mono' : ''} ${field.isDanger && Number(val) > 0 ? 'text-red-600 font-bold' : 'text-gray-700'}">${field.isCurrency ? '$' : ''}${formatNumber(val)}</span>`;
                            }
                            
                            let stickyClass = '';
                            let style = `min-width: ${field.widthVal}px; max-width: ${field.widthVal}px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;`;
                            
                            if (idx <= 4) { 
                                stickyClass = `sticky z-20 bg-white border-r border-gray-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]`;
                                style += ` left: ${listStickyOffsets[idx]}px;`;
                            } else {
                                style += ` border-r border-gray-100;`;
                            }
                            if (field.key === 'paymentStatus' && isOverdue && !isBadDebt) stickyClass = stickyClass.replace('bg-white', 'bg-emerald-100');

                            return `<td class="py-2 px-2 text-xs text-center ${field.font || ''} ${stickyClass}" style="${style}" title="${val||''}">${content}</td>`;
                        }).join('');

                        return `<tr class="hover:bg-gray-50 transition-colors">${batchSelectCell}${regularCells}</tr>`;
                    }).join('');
                }
                lucide.createIcons();
            }
            
            if (mobileContainer) {
                mobileContainer.innerHTML = generateMobileCardsHtml();
                lucide.createIcons();
            }

            if (paginationInfo && btnPrev && btnNext && btnFirst && btnLast && pageInput) {
                let sourceRecords = state.records;
                if (state.isAdmin && state.viewingUid !== 'all' && state.viewingUid !== null) {
                    sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
                } else if (!state.isAdmin && !state.isDemoMode) {
                    sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
                }
                
                const searchTerm = state.searchTerm.toLowerCase();
                let filtered = sourceRecords.filter(r => 
                    (r.borrower?.toLowerCase().includes(searchTerm) || 
                     r.displayId?.toLowerCase().includes(searchTerm) ||
                     r.method?.toLowerCase().includes(searchTerm)) // 新增：搜尋方式
                );
                
                // 修正排序邏輯
                filtered.sort((a, b) => {
                    const dateA = a.date ? new Date(a.date.replace(/\//g, '-')) : new Date('9999-12-31');
                    const dateB = b.date ? new Date(b.date.replace(/\//g, '-')) : new Date('9999-12-31');
                    return dateA - dateB;
                });
                
                if (state.unpaidFilter === 'all_unpaid') {
                    filtered = filtered.filter(r => {
                        const { isPaid } = getPaymentStatus(r);
                        return (r.status === '1' || r.status === '2') && !isPaid; // 修改：包括狀態2
                    });
                } else if (state.unpaidFilter === 'current_unpaid') {
                    filtered = filtered.filter(r => {
                        const { isPaid, isOverdue } = getPaymentStatus(r);
                        return (r.status === '1' || r.status === '2') && !isPaid && isOverdue; // 修改：包括狀態2
                    });
                }
                
                // 修正：篩選狀態1、2和3的案件
                if (state.activeCasesFilter) {
                    filtered = filtered.filter(r => r.status === '1' || r.status === '2' || r.status === '3');
                }
                
                const filteredWithDisplayIds = calculateDisplayIds(filtered);
                const totalPages = Math.ceil(filteredWithDisplayIds.length / state.itemsPerPage) || 1;
                
                paginationInfo.textContent = `第 ${state.currentPage} 頁 / 共 ${totalPages} 頁 (共 ${filteredWithDisplayIds.length} 筆)`;
                btnFirst.disabled = state.currentPage === 1;
                btnPrev.disabled = state.currentPage === 1;
                btnNext.disabled = state.currentPage >= totalPages || filteredWithDisplayIds.length === 0;
                btnLast.disabled = state.currentPage >= totalPages || filteredWithDisplayIds.length === 0;
                
                pageInput.value = state.currentPage;
                pageInput.max = totalPages;
                pageInput.min = 1;
            }
        };

        // Render Functions
        function renderAuth() { 
            return `<div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-4 font-sans">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in p-8">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 mb-4">
                            <i data-lucide="wallet" class="w-8 h-8 text-blue-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">${state.isRegistering ? "註冊新帳號" : "登入財務系統"}</h2>
                        <p class="text-xs text-gray-500 mt-2">${state.isRegistering ? "設定您的專屬帳號ID與綁定Email" : "使用您的帳號ID登入"}</p>
                    </div>
                    <form onsubmit="window.handleAuth(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">帳號 (ID)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-400"><i data-lucide="user" class="w-5 h-5"></i></span>
                                <input type="text" id="authUsername" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="請輸入帳號" required>
                            </div>
                        </div>
                        ${state.isRegistering ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">綁定 Email</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-400"><i data-lucide="at-sign" class="w-5 h-5"></i></span>
                                <input type="email" id="authEmail" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="name@example.com" required>
                            </div>
                        </div>` : ''}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-400"><i data-lucide="lock" class="w-5 h-5"></i></span>
                                <input type="password" id="authPassword" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="????????" required>
                            </div>
                        </div>
                        ${state.isRegistering ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">確認密碼</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-400"><i data-lucide="lock" class="w-5 h-5"></i></span>
                                <input type="password" id="authConfirmPassword" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="再次輸入密碼" required>
                            </div>
                        </div>` : ''}
                        <button type="submit" ${state.authLoading ? 'disabled' : ''} class="w-full text-white ${state.isRegistering ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-blue-600 hover:bg-blue-700'} py-3 rounded-lg font-bold transition-all shadow-md flex justify-center items-center disabled:opacity-50">
                            ${state.authLoading ? '<i data-lucide="refresh-cw" class="w-5 h-5 mr-2 animate-spin"></i>' : (state.isRegistering ? '<i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> 立即註冊' : '<i data-lucide="log-in" class="w-5 h-5 mr-2"></i> 登入系統')}
                        </button>
                    </form>
                    <div class="mt-6 text-center text-sm space-y-4">
                        <div>
                            <span class="text-gray-500">${state.isRegistering ? "已經有帳號了嗎？" : "還沒有帳號嗎？"}</span>
                            <button onclick="window.toggleAuthMode()" class="ml-2 text-blue-600 hover:text-blue-800 font-bold hover:underline focus:outline-none">
                                ${state.isRegistering ? "直接登入" : "註冊新帳號"}
                            </button>
                        </div>
                        <div class="pt-2 border-t border-gray-100">
                            <button onclick="window.enterDemoMode()" class="text-gray-400 hover:text-gray-600 text-xs flex items-center justify-center w-full hover:underline">
                                <i data-lucide="log-in" class="w-3 h-3 mr-1"></i> 先行試用 (免登入/不儲存資料)
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderDashboard(stats) {
            // 顏色映射函數
            const getColor = (id, defaultType) => {
                const c = state.cardColors[id] || defaultType;
                const map = {
                    primary: { bg: "bg-emerald-100", border: "border-emerald-300", text: "text-emerald-900", iconBg: "bg-emerald-200", iconColor: "text-emerald-700" },
                    warning: { bg: "bg-amber-50", border: "border-amber-200", text: "text-amber-900", iconBg: "bg-amber-100", iconColor: "text-amber-600" },
                    critical: { bg: "bg-red-200", border: "border-red-300", text: "text-red-900", iconBg: "bg-red-300", iconColor: "text-red-700" },
                    danger: { bg: "bg-rose-50", border: "border-rose-200", text: "text-rose-900", iconBg: "bg-rose-100", iconColor: "text-rose-600" },
                    info: { bg: "bg-blue-100", border: "border-blue-300", text: "text-blue-900", iconBg: "bg-blue-200", iconColor: "text-blue-700" },
                };
                return map[c] || map.primary;
            };
            
            // 移除代管案件數卡片，只保留系統案件狀態區塊的代管中
            const cardsToShow = state.cardLayout.filter(c => c.id !== 'managedCases');
            
            const cardsHtml = cardsToShow.filter(c => c.id !== 'totalManagementFee' || stats.hasManagedCases).map(c => {
                const config = getCardConfig(c.id); 
                if(!config) return '';
                
                const colorStyle = getColor(c.id, config.type);
                const colSpan = c.width === 2 ? 'lg:col-span-2' : 'lg:col-span-1';
                return `<div class="${colorStyle.bg} ${colSpan} border ${colorStyle.border} rounded-xl p-3 shadow-sm relative overflow-hidden flex flex-col justify-between h-full draggable-card hover:shadow-md transition-transform hover:scale-[1.01]" draggable="true" ondragstart="window.handleDragStart(event, '${c.id}')" ondragover="window.handleDragOver(event)" ondrop="window.handleDrop(event, '${c.id}')" onclick="window.openModalList('${c.id}')">
                    <div class="flex justify-between items-start z-10">
                        <span class="text-base font-bold text-gray-700">${config.label}</span>
                        <div class="flex items-center space-x-1">
                            <button onclick="window.changeCardColor(event, '${c.id}')" class="p-1 hover:bg-black/10 rounded" title="更換顏色">
                                <i data-lucide="palette" class="w-3 h-3 opacity-50"></i>
                            </button>
                            <button onclick="window.resizeCard(event, '${c.id}')" class="p-1 hover:bg-black/10 rounded" title="調整大小">
                                <i data-lucide="${c.width===1?'maximize-2':'minimize-2'}" class="w-3 h-3 opacity-50"></i>
                            </button>
                            <div class="p-1.5 rounded-lg ${colorStyle.iconBg}"><i data-lucide="${config.icon}" class="w-4 h-4 ${colorStyle.iconColor}"></i></div>
                        </div>
                    </div>
                    <div class="mt-1 z-10"><span class="text-2xl sm:text-3xl font-extrabold tracking-tight ${colorStyle.text}">${config.isCurrency ? '<span class="text-lg mr-1">$</span>' : ''}${formatNumber(config.value)}${!config.isCurrency ? '<span class="text-lg ml-1">件</span>' : ''}</span></div>
                </div>`;
            }).join('');

            return `<div class="animate-fade-in space-y-6">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">財務營運儀表板</h2>
                    </div>
                    ${state.isAdmin ? `
                    <div class="flex items-center space-x-2 bg-white p-1 rounded-lg border border-gray-200 shadow-sm">
                        <span class="text-xs font-bold text-gray-500 px-2">檢視對象:</span>
                        <select onchange="window.updateState({viewingUid: this.value})" class="text-sm border-none bg-transparent outline-none font-bold text-blue-600">
                            <option value="${state.currentUserUid}">我的帳號</option>
                            <option value="all" ${state.viewingUid === 'all' ? 'selected' : ''}>全部用戶</option>
                            ${state.usersDirectory.filter(u => u.uid !== state.currentUserUid).map(u => `<option value="${u.uid}" ${state.viewingUid === u.uid ? 'selected' : ''}>${u.username}</option>`).join('')}
                        </select>
                    </div>` : ''}
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
                    <div class="lg:col-span-3 grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-3">
                        ${cardsHtml}
                    </div>
                    <div class="flex flex-col gap-3">
                        <div class="bg-gradient-to-br from-teal-600 to-cyan-700 rounded-xl p-4 shadow-lg border border-transparent flex flex-col justify-center relative overflow-hidden flex-1 min-h-[300px]">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-xl"></div>
                            <div class="absolute bottom-0 left-0 w-24 h-24 bg-black/10 rounded-full -ml-10 -mb-10 blur-xl"></div>
                            <div class="flex items-center mb-4 relative z-10 border-b border-white/20 pb-2">
                                <i data-lucide="database" class="w-6 h-6 text-white mr-2"></i>
                                <h3 class="font-bold text-white text-xl tracking-wide">系統案件狀態</h3>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 relative z-10 flex-1">
                                <div onclick="window.openModalList('active')" class="bg-emerald-100 backdrop-blur-sm p-3 rounded-xl text-center cursor-pointer hover:bg-emerald-200 transition-all border border-emerald-300 group flex flex-col justify-center">
                                    <span class="block text-4xl font-extrabold text-emerald-800 mb-1 group-hover:scale-110 transition-transform">${formatNumber(stats.activeCases)}</span>
                                    <span class="text-base text-emerald-700 font-bold uppercase tracking-wider">進行中</span>
                                </div>
                                <div onclick="window.openModalList('unpaid')" class="bg-red-200 p-3 rounded-xl text-center cursor-pointer hover:bg-red-300 transition-all shadow-md group flex flex-col justify-center">
                                    <span class="block text-4xl font-extrabold text-red-800 mb-1 group-hover:scale-110 transition-transform">${formatNumber(stats.unpaidCount)}</span>
                                    <span class="text-lg text-red-700 font-bold uppercase tracking-wider flex items-center justify-center">
                                        <i data-lucide="alert-triangle" class="w-4 h-4 mr-1 animate-pulse"></i>本期逾期
                                    </span>
                                </div>
                                <div onclick="window.openModalList('closed')" class="bg-gray-200 p-3 rounded-xl text-center cursor-pointer hover:bg-gray-300 transition-all border border-gray-300 flex flex-col justify-center">
                                    <span class="block text-4xl font-bold text-gray-800 mb-1">${formatNumber(stats.normalClosedCount)}</span>
                                    <span class="text-lg text-gray-600 font-bold uppercase tracking-wider">結案</span>
                                </div>
                                <div onclick="window.openModalList('badDebt')" class="bg-pink-300 p-3 rounded-xl text-center cursor-pointer hover:bg-pink-400 transition-all shadow-md group flex flex-col justify-center">
                                    <span class="block text-4xl font-extrabold text-pink-900 mb-1 group-hover:scale-110 transition-transform">${formatNumber(stats.activeBadDebtCount + stats.closedBadDebtCount)}</span>
                                    <span class="text-lg text-pink-800 font-bold uppercase tracking-wider">呆帳</span>
                                </div>
                                ${stats.hasManagedCases ? `
                                <div onclick="window.openModalList('managed')" class="bg-blue-100 p-3 rounded-xl text-center cursor-pointer hover:bg-blue-200 transition-all border border-blue-300 flex flex-col justify-center">
                                    <span class="block text-4xl font-extrabold text-blue-800 mb-1">${formatNumber(stats.managedCases)}</span>
                                    <span class="text-lg text-blue-700 font-bold uppercase tracking-wider">代管中</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`; 
        }

        function renderList() {
            // 批次刪除模式下的表頭
            const batchDeleteHeader = state.batchDeleteMode ? 
                `<th class="p-2 font-semibold text-gray-700 text-sm whitespace-nowrap text-center sticky top-0 z-40 bg-gray-50 border-r border-gray-300" style="min-width: 40px; width: 40px; left: 0;">
                    <input type="checkbox" onclick="window.selectAllVisibleCasesForBatch()" ${state.selectedCasesForBatch.length > 0 ? 'checked' : ''} class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                </th>` : '';
            
            const headerHtml = listFieldDefinitions.map((field, idx) => {
                let stickyClass = '';
                let style = `min-width: ${field.widthVal}px; width: ${field.widthVal}px;`;
                
                if (idx <= 4) {
                    stickyClass = `sticky z-40 bg-gray-50 border-r border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]`;
                    style += ` left: ${listStickyOffsets[idx]}px;`;
                } else {
                    stickyClass = `sticky top-0 z-30 bg-gray-50 border-r border-gray-300`;
                }
                
                return `<th class="p-2 font-semibold text-gray-700 text-sm whitespace-nowrap text-center ${stickyClass}" style="${style}">${field.label}</th>`;
            }).join('');

            // 批次刪除模式的控制面板
            const batchDeletePanel = state.batchDeleteMode ? 
                `<div class="mb-4 bg-red-50 border border-red-200 rounded-lg p-4 flex flex-col sm:flex-row justify-between items-center">
                    <div class="flex items-center mb-2 sm:mb-0">
                        <div class="w-10 h-10 flex items-center justify-center bg-red-100 text-red-600 rounded-full mr-3">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-red-800">批次刪除模式</h3>
                            <p class="text-sm text-red-600">已選取 <span class="font-bold">${state.selectedCasesForBatch.length}</span> 筆案件</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.selectAllVisibleCasesForBatch()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 flex items-center text-sm font-bold">
                            <i data-lucide="check-square" class="w-4 h-4 mr-2"></i>
                            ${state.selectedCasesForBatch.length > 0 ? '取消全選' : '全選本頁'}
                        </button>
                        <button onclick="window.executeBatchDelete()" ${state.selectedCasesForBatch.length === 0 ? 'disabled' : ''} class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            刪除選取案件 (${state.selectedCasesForBatch.length}筆)
                        </button>
                        <button onclick="window.toggleBatchDeleteMode()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 flex items-center text-sm font-bold">
                            <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                            取消
                        </button>
                    </div>
                </div>` : '';

            return `
            <div class="flex flex-col h-[calc(100vh-6rem)] animate-fade-in space-y-4">
                <header class="flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0 bg-slate-100 pt-2 pb-2 z-10">
                    <h2 class="text-2xl font-bold text-gray-800">案件資料列表</h2>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center w-full sm:w-auto">
                        <div class="flex space-x-2 w-full sm:w-auto">
                            <button onclick="window.filterUnpaidCases('all_unpaid')" class="bg-red-600 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-red-700 flex items-center shadow-sm ${state.unpaidFilter === 'all_unpaid' ? 'ring-2 ring-red-300' : ''}">
                                <i data-lucide="alert-circle" class="w-3 h-3 mr-1"></i><span class="hidden sm:inline">所有未繳</span>
                            </button>
                            <button onclick="window.filterUnpaidCases('current_unpaid')" class="bg-amber-600 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-amber-700 flex items-center shadow-sm ${state.unpaidFilter === 'current_unpaid' ? 'ring-2 ring-amber-300' : ''}">
                                <i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i><span class="hidden sm:inline">逾期未繳</span>
                            </button>
                            <button onclick="window.showActiveCases()" class="bg-blue-600 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-blue-700 flex items-center shadow-sm ${state.activeCasesFilter ? 'ring-2 ring-blue-300' : ''}">
                                <i data-lucide="list-checks" class="w-3 h-3 mr-1"></i><span class="hidden sm:inline">所有未結案</span>
                            </button>
                            <button onclick="window.showAllCases()" class="bg-gray-500 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-gray-600 flex items-center shadow-sm ${!state.unpaidFilter && !state.activeCasesFilter ? 'ring-2 ring-gray-300' : ''}">
                                <i data-lucide="database" class="w-3 h-3 mr-1"></i><span class="hidden sm:inline">全部案件</span>
                            </button>
                        </div>
                        
                        <div class="flex space-x-2 items-center w-full sm:w-auto">
                            <div class="relative flex-1 sm:w-64">
                                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                                <input type="text" id="searchInput" placeholder="搜尋編號、姓名、方式..." value="${state.searchTerm}" class="w-full pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" oninput="window.handleSearch(this.value)">
                            </div>
                            
                            <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="window.handleFileChange(event)" />
                            <button onclick="window.handleFileSelect()" class="bg-indigo-600 text-white px-3 py-2 rounded-lg hover:bg-indigo-700 flex items-center shadow-sm disabled:opacity-50 text-sm" ${state.isImporting ? 'disabled' : ''} title="匯入垂直格式報表">
                                <i data-lucide="upload" class="w-3 h-3 mr-1"></i><span class="hidden sm:inline">匯入 CSV</span>
                            </button>
                            
                            <button onclick="window.exportToExcel()" class="bg-teal-600 text-white px-3 py-2 rounded-lg hover:bg-teal-700 flex items-center shadow-sm whitespace-nowrap text-sm" title="匯出垂直格式報表（與匯入格式相同）">
                                <i data-lucide="download" class="w-3 h-3 mr-1"></i><span class="hidden sm:inline">匯出 CSV</span>
                            </button>

                            <button onclick="window.toggleBatchDeleteMode()" class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 flex items-center shadow-sm text-sm ${state.batchDeleteMode ? 'ring-2 ring-red-300' : ''}">
                                <i data-lucide="trash-2" class="w-3 h-3 mr-1"></i><span class="hidden sm:inline">批次刪除</span>
                            </button>

                            <button onclick="window.openNewForm()" class="bg-emerald-600 text-white px-3 py-2 rounded-lg hover:bg-emerald-700 flex items-center shadow-sm text-sm">
                                <i data-lucide="plus" class="w-3 h-3 mr-1"></i><span class="hidden sm:inline">新增</span>
                            </button>
                        </div>
                    </div>
                </header>
                
                ${batchDeletePanel}
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex-1 flex flex-col overflow-hidden relative ${state.batchDeleteMode ? 'batch-selection-mode' : ''}">
                    <div class="desktop-table-view flex-1 overflow-auto relative custom-scrollbar">
                        <table class="text-left border-collapse w-max">
                            <thead>
                                <tr class="bg-gray-50 border-b border-gray-200">
                                    ${batchDeleteHeader}
                                    ${headerHtml}
                                </tr>
                            </thead>
                            <tbody id="loanListBody" class="divide-y divide-gray-100 text-sm">
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="mobileListContainer" class="mobile-card-view flex-1 overflow-y-auto p-4 custom-scrollbar">
                    </div>
                    
                    <div class="p-3 border-t border-gray-100 bg-gray-50 flex flex-col sm:flex-row justify-between items-center">
                        <div class="text-xs sm:text-sm text-gray-500 mb-2 sm:mb-0">
                            ${state.unpaidFilter === 'all_unpaid' ? 
                                `<span class="font-bold text-red-600"><i data-lucide="alert-circle" class="w-3 h-3 inline mr-1"></i>所有未繳案件</span>` : 
                              state.unpaidFilter === 'current_unpaid' ? 
                                `<span class="font-bold text-amber-600"><i data-lucide="alert-triangle" class="w-3 h-3 inline mr-1"></i>逾期未繳案件</span>` : 
                              state.activeCasesFilter ?
                                `<span class="font-bold text-blue-600"><i data-lucide="list-checks" class="w-3 h-3 inline mr-1"></i>所有未結案 (狀態1+2+3)</span>` :
                              '全部案件'}
                        </div>
                        <div class="flex items-center space-x-1">
                            <button id="btnFirst" onclick="window.goToFirstPage()" class="p-1.5 rounded hover:bg-gray-200 disabled:opacity-30 transition-colors" title="最前頁">
                                <i data-lucide="chevrons-left" class="w-4 h-4 text-gray-600"></i>
                            </button>
                            <button id="btnPrev" onclick="window.changePage(-1)" class="p-1.5 rounded hover:bg-gray-200 disabled:opacity-30 transition-colors" title="上一頁">
                                <i data-lucide="chevron-left" class="w-4 h-4 text-gray-600"></i>
                            </button>
                            <span id="paginationInfo" class="text-xs sm:text-sm text-gray-500 mx-2"></span>
                            <div class="flex items-center space-x-1">
                                <input type="number" id="pageInput" class="w-12 sm:w-16 text-center border border-gray-300 rounded p-1 text-xs sm:text-sm" min="1" />
                                <button id="pageGoBtn" onclick="window.goToPage(document.getElementById('pageInput').value)" class="p-1.5 rounded hover:bg-gray-200 transition-colors text-xs sm:text-sm" title="跳轉到指定頁碼">
                                    跳轉
                                </button>
                            </div>
                            <button id="btnNext" onclick="window.changePage(1)" class="p-1.5 rounded hover:bg-gray-200 disabled:opacity-30 transition-colors" title="下一頁">
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600"></i>
                            </button>
                            <button id="btnLast" onclick="window.goToLastPage()" class="p-1.5 rounded hover:bg-gray-200 disabled:opacity-30 transition-colors" title="最末頁">
                                <i data-lucide="chevrons-right" class="w-4 h-4 text-gray-600"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderUserManagement() {
             return `<div class="max-w-6xl mx-auto animate-fade-in">
                <header class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">用戶權限管理</h2>
                    <p class="text-sm text-gray-500">僅管理員可見，設定誰可以使用「代管」功能，並管理用戶帳號。</p>
                </header>
                
                <div class="mb-4 flex justify-end space-x-2">
                    <button onclick="window.cleanupOrphanedCases()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 flex items-center text-sm font-bold">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>清理無主案件
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                            <tr>
                                <th class="p-4">用戶名稱</th>
                                <th class="p-4">Email</th>
                                <th class="p-4 text-center">角色</th>
                                <th class="p-4 text-center">允許代管 (Status 2)</th>
                                <th class="p-4 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${state.usersDirectory.map(u => { 
                                const allowStatus2 = u.allowedStatus && u.allowedStatus.includes('2'); 
                                const isCurrentUser = u.uid === state.currentUserUid;
                                
                                return `<tr>
                                    <td class="p-4 font-bold text-gray-800">${u.username} ${isCurrentUser ? '<span class="ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">(目前登入)</span>' : ''}</td>
                                    <td class="p-4 text-sm text-gray-600">${u.email}</td>
                                    <td class="p-4 text-center">
                                        <span class="px-2 py-1 rounded-full text-xs font-bold ${u.role==='admin'?'bg-purple-100 text-purple-700':'bg-gray-100 text-gray-600'}">
                                            ${u.role==='admin'?'管理員':'一般用戶'}
                                        </span>
                                    </td>
                                    <td class="p-4 text-center">
                                        ${isCurrentUser ? 
                                            '<span class="text-gray-400 text-xs">(不適用)</span>' : 
                                            `<label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" class="sr-only peer" onchange="window.toggleUserStatus2Permission('${u.uid}')" ${allowStatus2 ? 'checked' : ''}>
                                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>`
                                        }
                                    </td>
                                    <td class="p-4 text-center">
                                        ${isCurrentUser ? 
                                            '<span class="text-gray-400 text-xs">無法刪除自己</span>' : 
                                            `<button onclick="window.deleteUserAccount('${u.uid}', '${u.username}')" class="px-3 py-1.5 bg-red-100 text-red-600 hover:bg-red-200 rounded text-xs font-bold flex items-center">
                                                <i data-lucide="trash-2" class="w-3 h-3 mr-1"></i>刪除帳號
                                            </button>`
                                        }
                                    </td>
                                </tr>`; 
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-bold text-yellow-800 flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i>注意事項</h3>
                    <ul class="text-sm text-yellow-700 mt-2 space-y-1">
                        <li>• 刪除帳號會同時刪除該用戶的所有貸款記錄</li>
                        <li>• 無法刪除自己的帳號</li>
                        <li>• 刪除操作無法復原，請謹慎操作</li>
                        <li>• 「清理無主案件」會刪除所有沒有對應用戶的案件</li>
                    </ul>
                </div>
            </div>`;
        }

        function renderForm() { 
             const isEdit = !!state.editingRecord; 
             const calc = calculateDerivedData(formData);
             
             const canUseStatus2 = state.allowedStatus.includes('2');
             
             return `<div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden animate-fade-in flex flex-col h-[calc(100vh-6rem)]"><div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0"><h3 class="font-bold text-gray-800 flex items-center"><i data-lucide="${isEdit ? 'edit-2' : 'plus'}" class="w-4 h-4 mr-2"></i> ${isEdit ? '編輯案件' : '新增案件'}</h3><button onclick="window.setActiveTab('list')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button></div>
             <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 text-sm flex-1 overflow-y-auto custom-scrollbar">
                 <div class="lg:col-span-4 bg-gray-50 p-3 rounded-lg border border-gray-200"><h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 border-b border-gray-200 pb-1">基本與聯絡資料</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-3"><div><label class="block text-[10px] text-gray-500 mb-0.5">借款人</label><input type="text" id="input_borrower" value="${formData.borrower}" oninput="window.updateFormData('borrower', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">身分證字號</label><input type="text" id="input_idNumber" value="${formData.idNumber}" oninput="window.updateFormData('idNumber', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">工作</label><input type="text" id="input_job" value="${formData.job}" oninput="window.updateFormData('job', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">經辦人</label><input type="text" id="input_agent" value="${formData.agent}" oninput="window.updateFormData('agent', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div class="md:col-span-2"><label class="block text-[10px] text-gray-500 mb-0.5">住址</label><input type="text" id="input_address" value="${formData.address}" oninput="window.updateFormData('address', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">電話</label><input type="text" id="input_telephone" value="${formData.telephone}" oninput="window.updateFormData('telephone', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">手機</label><input type="text" id="input_mobile" value="${formData.mobile}" oninput="window.updateFormData('mobile', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div></div></div>
                 <div class="lg:col-span-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"><div class="lg:col-span-2 bg-blue-50 p-3 rounded-lg border border-blue-100"><h4 class="text-xs font-bold text-blue-800 uppercase tracking-wider mb-2 border-b border-blue-200 pb-1">貸款設定</h4><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] text-gray-500 mb-0.5">狀態</label><select onchange="window.updateFormData('status', this.value, true)" class="w-full py-1 px-2 border rounded outline-none bg-white text-sm">
                    <option value="1" ${formData.status=='1'?'selected':''}>1 - 進行中</option>
                    ${canUseStatus2 ? `<option value="2" ${formData.status=='2'?'selected':''}>2 - 代管案件</option>` : ''}
                    <option value="3" ${formData.status=='3'?'selected':''}>3 - 呆帳</option>
                    <option value="0" ${formData.status=='0'?'selected':''}>0 - 已結案</option>
                    <option value="4" ${formData.status=='4'?'selected':''}>4 - 已結案呆帳</option>
                 </select></div>
                 <div><label class="block text-[10px] text-gray-500 mb-0.5">方式</label><select onchange="window.updateFormData('method', this.value, true)" class="w-full py-1 px-2 border rounded outline-none bg-white text-sm"><option value="叨簿子" ${formData.method=='叨簿子'?'selected':''}>叨簿子</option><option value="設定" ${formData.method=='設定'?'selected':''}>設定</option><option value="票貼" ${formData.method=='票貼'?'selected':''}>票貼</option><option value="小額" ${formData.method=='小額'?'selected':''}>小額</option></select></div><div><label class="block text-[10px] text-gray-500 mb-0.5">借款金額(債權)</label><input type="number" id="input_loanAmount" value="${formData.loanAmount}" oninput="window.updateFormData('loanAmount', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">放款金額(實際)</label><input type="number" id="input_disbursed" value="${formData.disbursed}" oninput="window.updateFormData('disbursed', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">放款日期</label><input type="date" id="input_date" value="${formData.date}" oninput="window.updateFormData('date', this.value)" class="w-full py-1 px-2 border rounded outline-none text-sm" /></div></div></div><div class="lg:col-span-2 bg-emerald-50 p-3 rounded-lg border border-emerald-100"><h4 class="text-xs font-bold text-emerald-800 uppercase tracking-wider mb-2 border-b border-emerald-200 pb-1">還款條件</h4><div class="grid grid-cols-3 gap-3"><div><label class="block text-[10px] text-gray-500 mb-0.5">期數</label><input type="number" id="input_terms" value="${formData.terms}" oninput="window.updateFormData('terms', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">利率(%)</label><input type="text" id="input_interestRate" value="${formData.interestRate}" oninput="window.updateFormData('interestRate', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">每期還款日</label><input type="text" id="input_repayDay" value="${formData.repayDay}" oninput="window.updateFormData('repayDay', this.value)" class="w-full py-1 px-2 border rounded outline-none text-sm" /></div>${formData.status === '2' ? `<div class="col-span-3 border-t border-emerald-200 my-1"></div><div><label class="block text-[10px] text-blue-600 mb-0.5">借款利率 (%)</label><input type="text" id="input_specialRate" value="${formData.specialRate}" oninput="window.updateFormData('specialRate', this.value)" class="w-full py-1 px-2 border border-blue-300 rounded font-mono bg-white text-sm" placeholder="例如: 0.5"></div><div><label class="block text-[10px] text-blue-600 mb-0.5">應付 (給委託人)</label><input type="text" id="input_expectedPayment" value="${formatNumber(formData.expectedPayment || 0)}" readonly class="w-full py-1 px-2 border border-blue-300 rounded font-mono bg-blue-50 text-blue-800 text-sm" /></div>` : ''}<div class="col-span-3 grid grid-cols-2 gap-3 mt-1"><div><label class="block text-[10px] text-gray-500 mb-0.5 font-bold">每期本金 (合約)</label><input type="number" id="input_principalPerTerm" value="${formData.principalPerTerm}" oninput="window.updateFormData('principalPerTerm', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono bg-gray-100 text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5 font-bold">${formData.status === '2' ? '管理費' : '每期利息'} (合約)</label><input type="number" id="input_interestPerTerm" value="${formData.interestPerTerm}" oninput="window.updateFormData('interestPerTerm', this.value)" ${formData.status === '2' ? 'readonly' : ''} class="w-full py-1 px-2 border rounded outline-none font-mono ${formData.status === '2' ? 'bg-blue-50 text-blue-800' : 'bg-gray-100'} text-sm" /></div></div> 
                 ${isEdit ? `<div class="col-span-3 border-t border-orange-200 my-1 pt-1"><h4 class="text-[10px] font-bold text-orange-600 uppercase tracking-wider mb-1">本期調整 (當月實收)</h4><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] text-gray-500 mb-0.5">本期本金</label><input type="number" id="input_currentPrincipal" value="${formData.currentPrincipal !== undefined ? formData.currentPrincipal : formData.principalPerTerm}" oninput="window.updateFormData('currentPrincipal', this.value)" class="w-full py-1 px-2 border border-orange-300 rounded outline-none font-mono bg-orange-50 text-sm text-gray-700 font-bold" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">本期利息</label><input type="number" id="input_currentInterest" value="${formData.currentInterest !== undefined ? formData.currentInterest : formData.interestPerTerm}" oninput="window.updateFormData('currentInterest', this.value)" class="w-full py-1 px-2 border border-orange-300 rounded outline-none font-mono bg-orange-50 text-sm text-gray-700 font-bold" /></div></div></div>` : ''}</div></div><div class="lg:col-span-4"><label class="block text-[10px] text-gray-500 mb-0.5">附註</label><textarea rows="2" id="input_note" oninput="window.updateFormData('note', this.value)" class="w-full py-1 px-2 border rounded outline-none text-sm resize-none">${formData.note}</textarea></div>
                 ${isEdit ? `
                     <div class="lg:col-span-4 bg-yellow-50 p-2 rounded border border-yellow-200 grid grid-cols-4 gap-2">
                         <div>
                             <label class="block text-[10px] text-gray-500">欠款</label>
                             <span id="display_arrears" class="font-mono font-bold text-red-600">${formatNumber(calc.arrears)}</span>
                         </div>
                         <div>
                             <label class="block text-[10px] text-gray-500">在外本金</label>
                             <span id="display_outstanding" class="font-mono font-bold">${formatNumber(calc.outstanding)}</span>
                         </div>
                         <div class="col-span-2 flex justify-end">
                             <button onclick="window.handleDelete('${state.editingRecord.id}')" class="px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs font-bold flex items-center"><i data-lucide="trash-2" class="w-3 h-3 mr-1"></i>刪除案件</button>
                         </div>
                     </div>` : ''}
             </div>
             <div class="bg-white px-6 py-4 flex justify-end items-center gap-6 border-t border-gray-100 shrink-0 mt-auto">
                 <button onclick="window.setActiveTab('list')" class="text-gray-500 hover:text-gray-800 text-sm font-medium transition-colors">取消</button>
                 <button onclick="window.handleSaveForm()" class="px-6 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 shadow-sm flex items-center font-bold text-sm transition-transform active:scale-95"><i data-lucide="save" class="w-4 h-4 mr-2"></i>儲存資料</button>
             </div>
             </div>`; 
        }

        function renderRepayment() { 
            let repaymentCases = state.records.filter(r => {
                if (r.status === '1') return true;
                if (r.status === '2' && state.allowedStatus.includes('2')) return true;
                return false;
            });
            
            const isSearching = !!state.repaymentSearchTerm; 
            const dropdownDisplayClass = isSearching ? '' : 'hidden'; 
            const dropdownHtml = `<div id="repaymentDropdownContainer" class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-xl max-h-60 overflow-y-auto ${dropdownDisplayClass}"></div>`; 
            const selectedCase = state.selectedRepaymentId ? state.records.find(r => r.id === state.selectedRepaymentId) : null; 
            
            return `<div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden animate-fade-in mt-8"><div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 text-white flex justify-between items-center"><div><h2 class="text-xl font-bold flex items-center"><i data-lucide="banknote" class="w-6 h-6 mr-2"></i> 還款入帳作業</h2><p class="text-blue-100 text-sm mt-1">選取案件連結後，輸入每期還款資訊</p></div><button onclick="window.setActiveTab('list')" class="px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-colors flex items-center text-sm font-medium"><i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>回上一頁</button></div><div class="p-8 space-y-6"><div class="space-y-2 relative"><label class="text-sm font-bold text-gray-600 flex items-center"><i data-lucide="search" class="w-4 h-4 mr-1"></i> 選擇案件 (僅顯示進行中${state.allowedStatus.includes('2') ? '/代管' : ''})</label><div class="relative"><input type="text" placeholder="輸入編號或姓名搜尋..." value="${state.repaymentSearchTerm}" oninput="window.updateRepaymentSearch(this.value)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none pl-10"/><i data-lucide="search" class="absolute left-3 top-3.5 text-gray-400 w-4 h-4"></i></div>${dropdownHtml}<select id="repaymentSelect" onchange="window.handleRepaymentSelect(this.value)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white mt-2" ${isSearching ? 'hidden' : ''}><option value="">-- 請選擇案件 --</option>${repaymentCases.map(r => `<option value="${r.id}" ${state.selectedRepaymentId === r.id ? 'selected' : ''}>${r.displayId || r.caseNumber || ''} - ${r.borrower || ''} (每期應繳: $${formatNumber((Number(r.principalPerTerm)||0) + (Number(r.interestPerTerm)||0))})</option>`).join('')}</select>${selectedCase ? `<div class="mt-2 flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-100"><span class="text-sm text-blue-800 font-medium">當前連結案件：${selectedCase.displayId || selectedCase.caseNumber || ''} ${selectedCase.borrower}</span><button onclick="window.resetRepaymentSelection()" class="text-xs text-blue-500 hover:text-blue-700 underline">重新選擇</button></div>` : ''}</div><div class="bg-gray-50 rounded-xl p-6 border border-gray-200 space-y-4"><div class="flex justify-between items-center border-b border-gray-200 pb-2 mb-4"><h3 class="font-bold text-gray-700 flex items-center"><i data-lucide="edit-2" class="w-4 h-4 mr-2"></i> 入帳資訊</h3>${selectedCase ? `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold flex items-center"><i data-lucide="check" class="w-3 h-3 mr-1"></i> 已連結</span>` : `<span class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-xs font-bold flex items-center"><i data-lucide="link" class="w-3 h-3 mr-1"></i> 未連結案件</span>`}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 mb-1">還款日期 (入帳日)</label><input type="date" value="${state.repaymentDate}" oninput="window.updateRepaymentInput('repaymentDate', this.value)" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white"/></div><div class="hidden md:block"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">還款本金</label><div class="relative"><span class="absolute left-3 top-2.5 text-gray-400">$</span><input type="number" value="${state.repaymentPrincipal}" oninput="window.updateRepaymentInput('repaymentPrincipal', this.value)" placeholder="0" class="w-full p-2 pl-7 border rounded focus:ring-2 focus:ring-blue-500 outline-none font-mono text-lg bg-white" ${selectedCase?.status === '2' ? 'disabled bg-gray-200' : ''}/></div></div><div><label class="block text-xs font-bold text-gray-500 mb-1">還款利息</label><div class="relative"><span class="absolute left-3 top-2.5 text-gray-400">$</span><input type="number" value="${state.repaymentInterest}" oninput="window.updateRepaymentInput('repaymentInterest', this.value)" placeholder="0" class="w-full p-2 pl-7 border rounded focus:ring-2 focus:ring-blue-500 outline-none font-mono text-lg bg-white"/></div></div></div></div><div class="pt-4 flex justify-end border-t border-gray-100 mt-6"><button onclick="window.submitRepayment()" ${!selectedCase ? 'disabled' : ''} class="px-6 py-3 rounded-lg shadow-md flex items-center font-bold text-lg transition-all ${selectedCase ? 'bg-blue-600 text-white hover:bg-blue-700 transform active:scale-95' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"><i data-lucide="save" class="w-5 h-5 mr-2"></i> 確認入帳</button></div></div></div>`; 
        }

        function renderApp() { 
            const app = document.getElementById('app');
            if (!state.currentUser && !state.isDemoMode) {
                app.innerHTML = renderAuth();
            } else {
                const stats = calculateStats();
                let content = '';
                if (state.activeTab === 'dashboard') content = renderDashboard(stats);
                else if (state.activeTab === 'list') content = renderList();
                else if (state.activeTab === 'form') content = renderForm();
                else if (state.activeTab === 'repayment') content = renderRepayment();
                else if (state.activeTab === 'admin') content = renderUserManagement();

                let modalHtml = '';
                
                if (state.activeModal.type) {
                     const isNote = state.activeModal.type === 'note'; const record = state.activeModal.record; const content = isNote ? record.note : record.schedule;
                     modalHtml += `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in backdrop-blur-sm"><div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col ${!isNote ? 'max-h-[80vh]' : ''}"><div class="bg-gradient-to-r ${!isNote ? 'from-emerald-600 to-teal-600' : 'from-blue-600 to-indigo-600'} p-4 flex justify-between items-center text-white shrink-0"><h3 class="font-bold flex items-center"><i data-lucide="${isNote ? 'file-pen-line' : 'calendar-days'}" class="w-5 h-5 mr-2"></i> 編輯${isNote ? '附註' : '還款日程'}</h3><button onclick="window.updateState({activeModal: {type: null, record: null}})" class="hover:bg-white/20 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-4 flex-1 overflow-y-auto custom-scrollbar">${isNote ? `<textarea id="modalTextarea" class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none text-sm leading-relaxed" placeholder="請輸入內容...">${record.note || ''}</textarea>` : `<div class="p-0 overflow-y-auto flex-1 custom-scrollbar" style="max-height: 400px;"><table class="w-full text-left border-collapse"><thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0 z-10"><tr><th class="p-3 border-b">日期 / 紀錄事項</th><th class="p-3 border-b text-center w-16">操作</th></tr></thead><tbody class="divide-y divide-gray-100">${(state.tempScheduleLines || []).map((line, idx) => `<tr class="hover:bg-gray-50 group"><td class="p-2"><input type="text" value="${line}" oninput="window.updateScheduleLine(${idx}, this.value)" class="w-full p-2 border border-gray-200 rounded focus:ring-2 focus:ring-emerald-500 outline-none text-sm bg-transparent group-hover:bg-white" /></td><td class="p-2 text-center"><button onclick="window.deleteScheduleLine(${idx})" class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('')}</tbody></table>${(state.tempScheduleLines || []).length === 0 ? '<div class="p-8 text-center text-gray-400 text-sm">尚無還款紀錄</div>' : ''}</div><div class="p-4 border-t border-gray-100 bg-gray-50 shrink-0 flex justify-between items-center"><button onclick="window.addScheduleLine()" class="text-emerald-600 hover:text-emerald-800 text-sm font-medium flex items-center"><i data-lucide="plus" class="w-4 h-4 mr-1"></i> 新增一筆</button></div>`}</div><div class="p-4 border-t border-gray-100 bg-gray-50 text-right shrink-0 flex justify-end gap-2"><button onclick="window.updateState({activeModal: {type: null, record: null}})" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg text-sm">取消</button><button onclick="window.saveModalData('${record.id}', '${state.activeModal.type}')" class="px-4 py-2 ${!isNote ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-blue-600 hover:bg-blue-700'} text-white rounded-lg text-sm font-medium">儲存</button></div></div></div>`; 
                }
                if (state.modalType) {
                    let filteredRecs = [];
                    const currentStats = calculateStats();

                    if (state.modalType === 'active') filteredRecs = currentStats.activeRecords;
                    else if (state.modalType === 'unpaid') filteredRecs = currentStats.unpaidRecords;
                    else if (state.modalType === 'closed') filteredRecs = currentStats.closedRecords;
                    else if (state.modalType === 'badDebt') filteredRecs = currentStats.badDebtCases;
                    else if (state.modalType === 'managed') filteredRecs = currentStats.managedRecords; // 新增：代管案件
                    else {
                        let baseRecords = state.records;
                        if (state.isAdmin && state.viewingUid !== 'all' && state.viewingUid !== null) {
                            baseRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
                        } else if (!state.isAdmin && !state.isDemoMode) {
                            baseRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
                        }
                        
                        if (state.modalType === 'outstanding') filteredRecs = baseRecords.filter(r => (r.status === '1' || r.status === '3') && calculateDerivedData(r).outstanding > 0);
                        else if (state.modalType === 'currentLent') filteredRecs = baseRecords.filter(r => r.status === '1' || r.status === '3');
                        else if (state.modalType === 'creditAmount') filteredRecs = baseRecords.filter(r => r.status === '1' || r.status === '3');
                        else if (state.modalType === 'monthDue') filteredRecs = baseRecords.filter(r => r.status === '1' || r.status === '2');
                        else if (state.modalType === 'totalManagementFee') filteredRecs = baseRecords.filter(r => r.status === '2');
                        else if (state.modalType === 'totalIncome') filteredRecs = baseRecords.filter(r => calculateDerivedData(r).totalInterestPaid > 0);
                        else if (state.modalType === 'monthCollected') {
                             filteredRecs = baseRecords.filter(r => {
                                 const { isPaid } = getPaymentStatus(r);
                                 return isPaid && (r.status === '1' || r.status === '2');
                             });
                        }
                        else if (state.modalType === 'monthDiff') { 
                             filteredRecs = baseRecords.filter(r => {
                                 const { isPaid } = getPaymentStatus(r);
                                 return !isPaid && (r.status === '1' || r.status === '2');
                             });
                        }
                        else if (state.modalType === 'monthInterestDiff') { 
                             filteredRecs = baseRecords.filter(r => {
                                 const { isPaid } = getPaymentStatus(r);
                                 return !isPaid && r.status === '1';
                             });
                        }
                        else if (state.modalType === 'badDebtAmount') { 
                             filteredRecs = baseRecords.filter(r => r.status === '3' || r.status === '4');
                        }
                        else if (state.modalType === 'monthInterestDue') {
                             filteredRecs = baseRecords.filter(r => r.status === '1');
                        }
                        else if (state.modalType === 'monthInterestCollected') {
                             filteredRecs = baseRecords.filter(r => {
                                 const { isPaid } = getPaymentStatus(r);
                                 return isPaid && r.status === '1';
                             });
                        }
                        else if (state.modalType === 'managedCases') {
                             filteredRecs = baseRecords.filter(r => r.status === '2');
                        }
                        else filteredRecs = baseRecords.filter(r => r.status === '1' || r.status === '2');
                    }
                    
                    // 修正：在模態視窗中也按日期排序
                    filteredRecs.sort((a, b) => {
                        const dateA = a.date ? new Date(a.date.replace(/\//g, '-')) : new Date('9999-12-31');
                        const dateB = b.date ? new Date(b.date.replace(/\//g, '-')) : new Date('9999-12-31');
                        return dateA - dateB;
                    });
                    
                    // 計算顯示編號
                    const filteredWithDisplayIds = calculateDisplayIds(filteredRecs);
                    
                    let customHeaders = ''; let customRowBuilder = null;

                    customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">欠款</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                    customRowBuilder = (r, calc, status) => `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower} <span class="text-xs font-normal text-gray-400">(${r.displayId || r.caseNumber || ''})</span></td><td class="p-2 text-right text-red-600 font-mono">${formatNumber(calc.arrears)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td><td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td></tr>`;
                    
                    if (state.modalType === 'totalIncome') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">累計利息/管理費</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right text-emerald-600 font-mono font-bold">${formatNumber(calc.totalInterestPaid)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td><td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td></tr>`;
                    } else if (state.modalType === 'outstanding') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">在外本金</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right text-emerald-600 font-mono font-bold">${formatNumber(calc.outstanding)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td><td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td></tr>`;
                    } else if (state.modalType === 'currentLent') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">放款金額</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right text-emerald-600 font-mono font-bold">${formatNumber(r.disbursed)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td><td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td></tr>`;
                    } else if (state.modalType === 'monthDue') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本月本金</th><th class="p-2 text-right">本月利息</th><th class="p-2 text-right">總計</th><th class="p-2 text-center">本月繳款狀態</th><th class="p-2 text-center">狀態</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const p = r.status==='2' ? 0 : (Number(r.principalPerTerm)||0);
                             const i = Number(r.interestPerTerm)||0;
                             const { isPaid, isOverdue } = getPaymentStatus(r);
                             const paymentStatusHtml = isPaid 
                                 ? `<span class="text-emerald-600 font-bold text-xs"><i data-lucide="check" class="w-3 h-3 inline"></i>已繳清</span>` 
                                 : (isOverdue ? `<span class="text-red-600 font-bold text-xs"><i data-lucide="alert-triangle" class="w-3 h-3 inline"></i>逾期</span>` : `<span class="text-gray-500 font-bold text-xs">未繳</span>`);

                             return `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right font-mono">${formatNumber(p)}</td><td class="p-2 text-right font-mono">${formatNumber(i)}</td><td class="p-2 text-right font-mono font-bold text-blue-600">${formatNumber(p+i)}</td><td class="p-2 text-center">${paymentStatusHtml}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td></tr>`;
                           }
                    } else if (state.modalType === 'monthInterestDue') { 
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本月利息</th><th class="p-2 text-center">本月繳款狀態</th><th class="p-2 text-center">狀態</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const i = Number(r.interestPerTerm)||0;
                             const { isPaid, isOverdue } = getPaymentStatus(r);
                             const paymentStatusHtml = isPaid 
                                 ? `<span class="text-emerald-600 font-bold text-xs"><i data-lucide="check" class="w-3 h-3 inline"></i>已繳清</span>` 
                                 : (isOverdue ? `<span class="text-red-600 font-bold text-xs"><i data-lucide="alert-triangle" class="w-3 h-3 inline"></i>逾期</span>` : `<span class="text-gray-500 font-bold text-xs">未繳</span>`);

                             return `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right font-mono font-bold text-emerald-600">${formatNumber(i)}</td><td class="p-2 text-center">${paymentStatusHtml}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td></tr>`;
                           }
                    } else if (state.modalType === 'monthCollected') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本期本金</th><th class="p-2 text-right">本期利息</th><th class="p-2 text-right">總計</th><th class="p-2 text-center">狀態</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const p = r.status==='2' ? 0 : (Number(r.principalPerTerm)||0);
                             const i = Number(r.interestPerTerm)||0;
                             return `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right font-mono">${formatNumber(p)}</td><td class="p-2 text-right font-mono">${formatNumber(i)}</td><td class="p-2 text-right font-mono font-bold text-emerald-600">${formatNumber(p+i)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td></tr>`;
                           }
                    } else if (state.modalType === 'monthInterestCollected') { 
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本期利息</th><th class="p-2 text-center">狀態</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const i = Number(r.interestPerTerm)||0;
                             return `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right font-mono font-bold text-emerald-600">${formatNumber(i)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td></tr>`;
                           }
                    } else if (state.modalType === 'totalManagementFee') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">管理費 (利息)</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right text-emerald-600 font-mono font-bold">${formatNumber(r.interestPerTerm)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td><td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td></tr>`;
                    } else if (state.modalType === 'monthDiff') { 
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本期本金</th><th class="p-2 text-right">本期利息</th><th class="p-2 text-right">未繳總計</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const p = r.status==='2' ? 0 : (Number(r.principalPerTerm)||0);
                             const i = Number(r.interestPerTerm)||0;
                             const total = p + i;
                             return `<tr class="hover:bg-gray-50 transition-colors">
                                 <td class="p-2 font-bold text-gray-800">${r.borrower}</td>
                                 <td class="p-2 text-right font-mono text-gray-600">${formatNumber(p)}</td>
                                 <td class="p-2 text-right font-mono text-gray-600">${formatNumber(i)}</td>
                                 <td class="p-2 text-right font-mono font-bold text-red-600">${formatNumber(total)}</td>
                                 <td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td>
                                 <td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td>
                               </tr>`;
                           }
                    } else if (state.modalType === 'monthInterestDiff') { 
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本期利息</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const i = Number(r.interestPerTerm)||0;
                             return `<tr class="hover:bg-gray-50 transition-colors">
                                 <td class="p-2 font-bold text-gray-800">${r.borrower}</td>
                                 <td class="p-2 text-right font-mono text-red-600 font-bold">${formatNumber(i)}</td>
                                 <td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td>
                                 <td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td>
                               </tr>`;
                           }
                    } else if (state.modalType === 'managedCases') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">管理費</th><th class="p-2 text-center">本月繳款狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const i = Number(r.interestPerTerm)||0;
                             const { isPaid, isOverdue } = getPaymentStatus(r);
                             const paymentStatusHtml = isPaid 
                                 ? `<span class="text-emerald-600 font-bold text-xs"><i data-lucide="check" class="w-3 h-3 inline"></i>已繳清</span>` 
                                 : (isOverdue ? `<span class="text-red-600 font-bold text-xs"><i data-lucide="alert-triangle" class="w-3 h-3 inline"></i>逾期</span>` : `<span class="text-gray-500 font-bold text-xs">未繳</span>`);
                             
                             return `<tr class="hover:bg-gray-50 transition-colors">
                                 <td class="p-2 font-bold text-gray-800">${r.borrower} <span class="text-xs font-normal text-gray-400">(${r.displayId || r.caseNumber || ''})</span></td>
                                 <td class="p-2 text-right font-mono font-bold text-blue-600">${formatNumber(i)}</td>
                                 <td class="p-2 text-center">${paymentStatusHtml}</td>
                                 <td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td>
                               </tr>`;
                           }
                    }

                    modalHtml += `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in backdrop-blur-sm"><div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] flex flex-col"><div class="p-4 flex justify-between items-center text-white shrink-0 bg-gradient-to-r from-blue-600 to-indigo-600"><h3 class="font-bold flex items-center"><i data-lucide="list" class="w-5 h-5 mr-2"></i> 案件列表</h3><button onclick="window.updateState({modalType: null})" class="hover:bg-white/20 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-0 overflow-y-auto flex-1"><table class="w-full text-left border-collapse"><thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0">${customHeaders}</thead><tbody class="divide-y divide-gray-100 text-sm">${filteredWithDisplayIds.map(r => { const calc = calculateDerivedData(r); const status = getStatusLabel(r.status); return customRowBuilder(r, calc, status); }).join('')}</tbody></table></div></div></div>`;
                }

                app.innerHTML = `<div class="flex h-screen bg-slate-100 font-sans text-gray-800"><div class="w-20 sm:w-64 bg-slate-900 text-white flex flex-col justify-between fixed h-full z-20 transition-all duration-300"><div><div class="p-6 flex items-center justify-center sm:justify-start border-b border-slate-700"><i data-lucide="wallet" class="w-8 h-8 text-emerald-400 mr-0 sm:mr-3"></i><span class="hidden sm:block text-xl font-bold tracking-wider">借貸管理</span></div><div class="px-6 py-4 flex items-center border-b border-slate-800 mb-2"><div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mr-3 ${state.isDemoMode ? 'bg-amber-500' : 'bg-slate-700'}">${state.isDemoMode ? 'T' : (state.currentUser ? state.currentUser.substring(0, 2).toUpperCase() : 'U')}</div><div class="hidden sm:block"><p class="text-xs text-slate-400">${state.isDemoMode ? "試用模式" : "已登入"}</p><p class="text-sm font-bold text-white truncate w-32">${state.isDemoMode ? "訪客 (不儲存)" : state.currentUser}</p></div></div><nav class="mt-4 px-4 space-y-2"><button onclick="window.setActiveTab('dashboard')" class="w-full flex items-center p-3 rounded-lg transition-colors ${state.activeTab === 'dashboard' ? 'bg-emerald-600' : 'hover:bg-slate-800'}"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i><span class="hidden sm:block">營運報表</span></button><button onclick="window.setActiveTab('list')" class="w-full flex items-center p-3 rounded-lg transition-colors ${state.activeTab === 'list' ? 'bg-emerald-600' : 'hover:bg-slate-800'}"><i data-lucide="database" class="w-5 h-5 mr-3"></i><span class="hidden sm:block">案件列表</span></button><button onclick="window.setActiveTab('repayment')" class="w-full flex items-center p-3 rounded-lg transition-colors ${state.activeTab === 'repayment' ? 'bg-emerald-600' : 'hover:bg-slate-800'}"><i data-lucide="banknote" class="w-5 h-5 mr-3"></i><span class="hidden sm:block">還款輸入</span></button>${state.isAdmin ? `<button onclick="window.setActiveTab('admin')" class="w-full flex items-center p-3 rounded-lg transition-colors ${state.activeTab === 'admin' ? 'bg-emerald-600' : 'hover:bg-slate-800'}"><i data-lucide="users" class="w-5 h-5 mr-3"></i><span class="hidden sm:block">用戶管理</span></button>` : ''}</nav></div><div class="p-4 border-t border-slate-700 space-y-2"><button onclick="window.handleLogout()" class="w-full flex items-center justify-center sm:justify-start p-3 rounded-lg text-slate-400 hover:bg-red-900/30 hover:text-red-400 transition-colors"><i data-lucide="log-out" class="w-5 h-5 mr-0 sm:mr-2"></i><span class="hidden sm:block font-medium">登出系統</span></button></div></div><div class="flex-1 ml-20 sm:ml-64 p-4 sm:p-8 overflow-x-hidden">${content}</div>${modalHtml}</div>`;
                
                if (state.activeTab === 'list') {
                    window.refreshListUI();
                }
            }
            lucide.createIcons();
        }

        // Init App
        if (firebaseAvailable) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.currentUser = user.displayName || user.email;
                    state.currentUserUid = user.uid;
                    state.isDemoMode = false;
                    
                    if (state.viewingUid === null) {
                        state.viewingUid = user.uid;
                    }
                    
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'user_directory'), async (snap) => {
                        const allUsers = snap.docs.map(d => d.data());
                        state.usersDirectory = allUsers;
                        
                        const myProfile = allUsers.find(u => u.uid === state.currentUserUid);
                        
                        if (myProfile) {
                            const newIsAdmin = myProfile.role === 'admin';
                            
                            if (newIsAdmin !== state.isAdmin) {
                                state.isAdmin = newIsAdmin;
                                state.allowedStatus = myProfile.allowedStatus || ['0', '1', '3', '4'];
                                renderApp();
                            } else {
                                state.allowedStatus = myProfile.allowedStatus || ['0', '1', '3', '4'];
                                if (state.isAdmin) renderApp();
                            }
                        }

                        if (allUsers.length === 1 && myProfile && myProfile.role !== 'admin') {
                            console.log("Self-healing: Promoting single user to admin...");
                            try {
                                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_directory', state.currentUserUid), {
                                    role: 'admin',
                                    allowedStatus: ['0', '1', '2', '3', '4']
                                });
                            } catch (e) {
                                console.error("Self-healing failed:", e);
                            }
                        } else if (allUsers.length > 1 && myProfile && myProfile.role === 'admin') {
                            const adminCount = allUsers.filter(u => u.role === 'admin').length;
                            if (adminCount > 1) {
                                console.warn(`系統中有 ${adminCount} 個管理員，建議只保留一個`);
                            }
                        }
                    });

                    if (!state.isLoadingListener) {
                        const q = query(
                            collection(db, 'artifacts', appId, 'public', 'data', 'loan_records'), 
                            orderBy('date', 'asc')
                        );
                        onSnapshot(q, (snapshot) => {
                            const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            
                            // 按日期排序
                            docs.sort((a, b) => {
                                const dateA = a.date ? new Date(a.date.replace(/\//g, '-')) : new Date('9999-12-31');
                                const dateB = b.date ? new Date(b.date.replace(/\//g, '-')) : new Date('9999-12-31');
                                return dateA - dateB;
                            });
                            
                            updateState({ records: docs });
                        });
                        state.isLoadingListener = true;
                    }
                } else {
                    updateState({ 
                        currentUser: null, 
                        currentUserUid: null,
                        currentUserName: 'Guest',
                        isAdmin: false,
                        allowedStatus: ['0', '1', '3', '4'],
                        viewingUid: null,
                        usersDirectory: [],
                        isDemoMode: false,
                        isRegistering: false,
                        authLoading: false,
                        activeTab: 'dashboard',
                        records: [],
                        cardLayout: initialCardLayout,
                        editingRecord: null,
                        searchTerm: '',
                        repaymentSearchTerm: '',
                        selectedRepaymentId: '',
                        repaymentDate: new Date().toISOString().split('T')[0],
                        repaymentPrincipal: '',
                        repaymentInterest: '',
                        currentPage: 1,
                        itemsPerPage: 10,
                        modalType: null,
                        showAIModal: false,
                        activeModal: { type: null, record: null },
                        tempScheduleLines: [],
                        isLoadingListener: false,
                        isImporting: false,
                        unpaidFilter: null,
                        batchDeleteMode: false,
                        selectedCasesForBatch: [],
                        activeCasesFilter: true, // 保持預設顯示未結案案件（狀態1、2、3）
                        cardColors: {} // 清除顏色設定
                    });
                    
                    formData = { ...initialFormState };
                    
                    if (typeof sessionStorage !== 'undefined') {
                        sessionStorage.removeItem('firebase:authUser:' + firebaseConfig.apiKey + ':' + appId);
                    }
                    
                    setTimeout(() => {
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput) searchInput.value = '';
                    }, 0);
                    
                    renderApp();
                }
            });
        } else {
            renderApp();
        }

    </script>
</body>
</html>