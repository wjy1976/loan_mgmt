<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>借貸管理系統 (Firebase多人版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        
        /* Drag and Drop Styles */
        .draggable-card { cursor: grab; }
        .draggable-card:active { cursor: grabbing; }
        
        /* Table Styles */
        th, td { vertical-align: middle; }
        
        /* Input in table */
        .table-input {
            transition: all 0.2s;
        }
        .table-input:focus {
            outline: 2px solid #10b981;
            background-color: #ffffff;
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800">

    <div id="app"></div>
    
    <!-- 隱藏的檔案輸入框，用於 CSV 匯入 -->
    <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="window.handleFileChange(event)" />

    <!-- 系統訊息與確認容器 -->
    <div id="system-modals">
        <!-- 訊息提示 (Error/Success) -->
        <div id="message-container" class="fixed top-4 right-4 w-full max-w-sm z-[90] pointer-events-none"></div>

        <!-- 確認視窗 Modal -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 animate-fade-in backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all">
                <div class="p-6">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-red-100 text-red-600 rounded-full">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800" id="confirm-title">確認操作</h3>
                            <p class="text-sm text-gray-500" id="confirm-message">您確定要執行此操作嗎？此動作無法復原。</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3 border-t border-gray-100">
                    <button id="confirm-cancel" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg text-sm transition-colors">取消</button>
                    <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg text-sm font-medium transition-colors">確定</button>
                </div>
            </div>
        </div>
        
        <!-- 載入中 Modal -->
        <div id="loading-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 animate-fade-in backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl p-6 flex items-center space-x-4">
                <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                <p class="text-gray-700 font-medium" id="loading-text">處理中，請稍候...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc, serverTimestamp, writeBatch, orderBy, getDoc, setDoc, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Custom Alert/Confirm Logic ---
        const showMessage = (message, type) => {
            const container = document.getElementById('message-container');
            if (!container) return;

            const isError = type === 'error';
            const bgColor = isError ? 'bg-red-50 border-red-300' : 'bg-emerald-50 border-emerald-300';
            const textColor = isError ? 'text-red-700' : 'text-emerald-700';
            const icon = isError ? 'x-circle' : 'check-circle';

            const messageBox = document.createElement('div');
            messageBox.className = `p-4 mt-3 border rounded-xl shadow-lg flex items-start space-x-3 animate-fade-in pointer-events-auto ${bgColor}`;
            messageBox.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 flex-shrink-0 ${textColor}"></i><p class="text-sm font-medium ${textColor}">${message}</p>`;
            container.prepend(messageBox);
            lucide.createIcons();

            setTimeout(() => {
                messageBox.remove();
            }, 4000);
        };

        window.showError = (message) => showMessage(message, 'error');
        window.showSuccess = (message) => showMessage(message, 'success');

        window.showConfirm = (message, callback) => {
            const modal = document.getElementById('confirm-modal');
            const msgEl = document.getElementById('confirm-message');
            const okBtn = document.getElementById('confirm-ok');
            const cancelBtn = document.getElementById('confirm-cancel');

            if (!modal || !msgEl || !okBtn || !cancelBtn) return;

            msgEl.textContent = message;
            modal.classList.remove('hidden');

            const newOk = okBtn.cloneNode(true); okBtn.parentNode.replaceChild(newOk, okBtn);
            const newCancel = cancelBtn.cloneNode(true); cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

            const closeAndClean = () => modal.classList.add('hidden');

            newOk.addEventListener('click', () => { closeAndClean(); callback(true); });
            newCancel.addEventListener('click', () => { closeAndClean(); callback(false); });
        };


        // --- Configuration ---
        const apiKey = "AIzaSyAHwE1LPtzDpKtfP77gQahh1dKoobGGyw4"; 
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAHwE1LPtzDpKtfP77gQahh1dKoobGGyw4",
          authDomain: "loanproject-2fe6d.firebaseapp.com",
          projectId: "loanproject-2fe6d",
          storageBucket: "loanproject-2fe6d.firebasestorage.app",
          messagingSenderId: "754719036128",
          appId: "1:754719036128:web:57b3b4ad579bd00af8f685"
        };

        // --- Initialization ---
        let app, auth, db;
        let firebaseAvailable = false;
        let appId = 'loanproject-default'; 

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            firebaseAvailable = true;
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.warn("Firebase 初始化失敗:", e);
            firebaseAvailable = false;
        }

        // --- Global State ---
        const initialCardLayout = [
            { id: 'totalIncome', label: "總收入 (累計)", type: "primary", icon: "wallet", isCurrency: true, width: 2 },
            { id: 'creditAmount', label: "債權總額", type: "primary", icon: "file-text", isCurrency: true, width: 1 },
            { id: 'outstanding', label: "在外本金", type: "warning", icon: "dollar-sign", isCurrency: true, width: 1 },
            { id: 'currentLent', label: "目前放款額", type: "warning", icon: "credit-card", isCurrency: true, width: 1 },
            { id: 'monthDue', label: "本月應收款", type: "primary", icon: "credit-card", compact: true, isCurrency: true, width: 1 },
            { id: 'monthCollected', label: "本月已收款", type: "primary", icon: "check", compact: true, isCurrency: true, width: 1 },
            { id: 'monthDiff', label: "本月款差", type: "critical", icon: "alert-circle", compact: true, isCurrency: true, width: 1 },
            { id: 'monthInterestDiff', label: "本月息差", type: "critical", icon: "alert-circle", compact: true, isCurrency: true, width: 1 },
            { id: 'monthInterestDue', label: "本月應收息", type: "primary", icon: "trending-up", compact: true, isCurrency: true, width: 1 },
            { id: 'monthInterestCollected', label: "本月已收息", type: "primary", icon: "check", compact: true, isCurrency: true, width: 1 },
            { id: 'totalManagementFee', label: "本月管理費", type: "primary", icon: "credit-card", isCurrency: true, width: 1 },
            { id: 'badDebtAmount', label: "呆帳金額", type: "critical", icon: "x", isCurrency: true, width: 1 }
        ];
        
        // --- 核心欄位定義 ---
        const listFieldDefinitions = [
            { key: 'actions', label: '操作', isAction: true, widthVal: 120 }, // Sticky 1
            { key: 'caseNumber', label: '編號', bg: 'bg-gray-100', widthVal: 80 }, // Sticky 2
            { key: 'borrower', label: '借款人', font: 'font-bold', widthVal: 100 }, // Sticky 3
            { key: 'status', label: '狀態', widthVal: 80 }, // Sticky 4
            { key: 'paymentStatus', label: '本月繳款狀態', isComputed: true, widthVal: 100 }, // Sticky 5
            { key: 'repaidTerms', label: '還款期數(次)', widthVal: 90 },
            { key: 'method', label: '方式', widthVal: 80 },
            { key: 'date', label: '放款日期', widthVal: 100 },
            { key: 'loanAmount', label: '借款金額', isCurrency: true, widthVal: 100 },
            { key: 'disbursed', label: '放款金額', isCurrency: true, widthVal: 100 },
            { key: 'arrears', label: '欠款', isCurrency: true, isDanger: true, isComputed: true, widthVal: 100 },
            { key: 'outstanding', label: '在外本金', isCurrency: true, isComputed: true, widthVal: 100 },
            { key: 'interestRate', label: '利率(%)', isCurrency: false, widthVal: 80 },
            { key: 'agent', label: '銀行/人', widthVal: 100 },
            { key: 'terms', label: '期數', widthVal: 60 },
            { key: 'repayDay', label: '每期還款日', widthVal: 80 },
            { key: 'principalPerTerm', label: '每期還款本金', isCurrency: true, widthVal: 100 },
            { key: 'interestPerTerm', label: '每期利息', isCurrency: true, widthVal: 100 },
            { key: 'remainingTerms', label: '餘期', isComputed: true, widthVal: 60 },
            { key: 'roiTerms', label: '回本期數', isComputed: true, widthVal: 80 },
            { key: 'totalInterestIncome', label: '利息收入', isCurrency: true, widthVal: 100 },
            { key: 'note', label: '附註', isEditable: true, widthVal: 150 },
        ];
        const listStickyOffsets = [0, 120, 200, 300, 380];

        const state = {
            currentUser: firebaseAvailable ? null : 'Guest', 
            currentUserUid: null,
            currentUserName: 'Guest', 
            isAdmin: false, // 權限標記
            allowedStatus: ['0', '1', '2', '3', '4'], // 預設權限 (會在登入後更新)
            viewingUid: 'all', // Admin 檢視模式: 'all' or specific uid
            usersDirectory: [], // 存放所有用戶資料 (Admin 用)
            
            isDemoMode: !firebaseAvailable,
            isRegistering: false,
            authLoading: false,
            activeTab: 'dashboard',
            records: [],
            cardLayout: initialCardLayout, 
            editingRecord: null,
            searchTerm: '',
            repaymentSearchTerm: '',
            selectedRepaymentId: '',
            repaymentDate: new Date().toISOString().split('T')[0],
            repaymentPrincipal: '',
            repaymentInterest: '',
            currentPage: 1,
            itemsPerPage: 10,
            modalType: null,
            messageModalRecord: null,
            showAIModal: false,
            activeModal: { type: null, record: null },
            tempScheduleLines: [],
            aiReport: '',
            aiMessage: '',
            aiLoading: false,
            isLoadingListener: false,
            isImporting: false, 
            // 新增：未繳案件篩選狀態
            unpaidFilter: null, // null, 'all_unpaid', 'current_unpaid'
        };

        // Demo Data
        if (state.isDemoMode) {
             state.records = [
                 { id: 'demo1', caseNumber: '#001', displayId: '#001', borrower: '王小明', status: '1', method: '叨簿子', loanAmount: 100000, disbursed: 90000, interestRate: 5.0, terms: 10, principalPerTerm: 10000, interestPerTerm: 5000, date: '2023-10-01', schedule: '2023-11-01 本金:10000 利息:5000\n2023-12-01 本金:10000 利息:5000', note: '正常繳款中', job: '工程師', agent: '張三', ownerUid: 'demo' },
                 { id: 'demo2', caseNumber: '#002', displayId: '#002', borrower: '李大華', status: '4', method: '設定', loanAmount: 500000, disbursed: 450000, interestRate: 3.0, specialRate: 5.0, terms: 0, principalPerTerm: 0, interestPerTerm: 15000, date: '2023-09-15', schedule: '', note: '代管案件，每月僅收息', job: '業務', agent: '李四', ownerUid: 'demo' },
                 { id: 'demo3', caseNumber: '#003', displayId: '#003', borrower: '陳淑芬', status: '3', method: '票貼', loanAmount: 30000, disbursed: 27000, interestRate: 10.0, terms: 3, principalPerTerm: 10000, interestPerTerm: 3000, date: '2023-11-01', schedule: '', note: '已失聯，列為呆帳', job: '自營商', agent: '王五', ownerUid: 'demo' },
                 { id: 'demo4', caseNumber: '#004', displayId: '#004', borrower: '張志豪', status: '0', method: '小額', loanAmount: 20000, disbursed: 20000, interestRate: 0, terms: 1, principalPerTerm: 20000, interestPerTerm: 0, date: '2023-08-01', schedule: '2023-08-05 本金:20000 利息:0', note: '已結清', job: '司機', agent: '趙六', ownerUid: 'demo' }
               ];
        }

        const initialFormState = {
            status: '1', method: '叨簿子', date: '', borrower: '', job: '',
            idNumber: '', address: '', telephone: '', mobile: '',
            loanAmount: '', disbursed: '', interestRate: '', specialRate: '', agent: '', 
            terms: '', repayDay: '', principalPerTerm: '', interestPerTerm: '',
            currentPrincipal: '', currentInterest: '', 
            note: '', schedule: ''
        };
        let formData = { ...initialFormState };

        // --- Helper Functions ---
        const formatNumber = (num) => {
            if (typeof num === 'string' && !/^-?\d/.test(num)) return num;
            if (num === '∞' || num === '-') return num;
            if (num === null || num === undefined || num === '') return "";
            const n = Number(num);
            if (isNaN(n)) return num; 
            return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        };
        const formatCaseId = (num) => `#${String(num).padStart(3, '0')}`;
        
        const extractDatesFromSchedule = (scheduleStr) => {
            if (!scheduleStr) return [];
            const regex = /\b(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})\b/g; 
            const matches = []; let match;
            while ((match = regex.exec(scheduleStr)) !== null) {
                const d = new Date(match[0].replace(/\//g, '-')); 
                if (!isNaN(d.getTime())) matches.push(d);
            }
            return matches;
        };
        const sortScheduleLines = (lines) => {
            return [...lines].sort((a, b) => {
                const datesA = extractDatesFromSchedule(a); const datesB = extractDatesFromSchedule(b);
                const dateA = datesA.length > 0 ? datesA[0] : null; const dateB = datesB.length > 0 ? datesB[0] : null;
                if (dateA && dateB) return dateA - dateB; if (dateA) return -1; if (dateB) return 1; return 0; 
            });
        };
        const getPaymentStatus = (record) => {
            if (record.status === '4') return { isPaid: true, isOverdue: false }; 
            const dates = extractDatesFromSchedule(record.schedule);
            const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
            let isPaidThisMonth = false;
            for (let d of dates) { if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) { isPaidThisMonth = true; break; } }
            if (!isPaidThisMonth && record.lastRepaymentDate) { const lastDate = new Date(record.lastRepaymentDate); if (lastDate.getMonth() === currentMonth && lastDate.getFullYear() === currentYear) isPaidThisMonth = true; }
            if (record.status === '0') return { isPaid: true, isOverdue: false };
            let repayDay = null; if (record.repayDay) { const match = String(record.repayDay).match(/(\d+)/); if (match) repayDay = parseInt(match[1], 10); }
            let isOverdue = false; if (!isPaidThisMonth && repayDay) { const currentDay = now.getDate(); if (currentDay >= repayDay) isOverdue = true; }
            return { isPaid: isPaidThisMonth, isOverdue };
        };

        // 修改點1: 更新 parseSchedule 函數以支持新格式
        const parseSchedule = (scheduleStr) => {
            if (!scheduleStr) return [];
            const lines = scheduleStr.split('\n').filter(l => l.trim() !== '');
            return lines.map(line => {
                const dateMatch = line.match(/^(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/);
                
                // 嘗試匹配新格式（本金: 利息:）
                let pMatch = line.match(/本金:(\d+)/);
                let iMatch = line.match(/利息:(\d+)/);
                
                // 如果沒有匹配到新格式，嘗試舊格式（P: I:）
                if (!pMatch) pMatch = line.match(/P:(\d+)/);
                if (!iMatch) iMatch = line.match(/I:(\d+)/);
                
                const date = dateMatch ? new Date(dateMatch[1].replace(/\//g, '-')) : null;
                const principal = pMatch ? parseInt(pMatch[1], 10) : 0;
                const interest = iMatch ? parseInt(iMatch[1], 10) : 0;
                
                // 轉換為新格式的原始字串
                const raw = dateMatch ? `${dateMatch[0]} 本金:${principal} 利息:${interest}` : line;
                
                return { date, principal, interest, raw };
            }).filter(item => item.date !== null);
        };

        const calculateDerivedData = (record) => {
            const loanAmount = Number(record.loanAmount) || 0; 
            const disbursed = Number(record.disbursed) || 0;
            
            const entries = parseSchedule(record.schedule);
            let totalPrincipalPaid = 0;
            let totalInterestPaid = 0;
            
            entries.forEach(e => {
                totalPrincipalPaid += e.principal;
                totalInterestPaid += e.interest;
            });

            if (record.status === '4') {
                return {
                    outstanding: record.outstandingPrincipal !== undefined ? Number(record.outstandingPrincipal) : (disbursed - (totalPrincipalPaid + totalInterestPaid)),
                    arrears: record.arrears !== undefined ? Number(record.arrears) : (loanAmount - totalPrincipalPaid - totalInterestPaid),
                    remainingTerms: '-', 
                    roiTerms: '-',
                    totalPrincipalPaid,
                    totalInterestPaid
                };
            }

            if (record.status === '0' || record.status === '2') {
                return { 
                    outstanding: record.status === '0' ? 0 : (disbursed - totalPrincipalPaid), 
                    arrears: record.status === '0' ? 0 : (loanAmount - totalPrincipalPaid),
                    remainingTerms: '-', 
                    roiTerms: '-',
                    totalPrincipalPaid,
                    totalInterestPaid
                };
            }

            let outstanding = disbursed - totalPrincipalPaid; 
            if (outstanding < 0) outstanding = 0; 

            let arrears = loanAmount - totalPrincipalPaid; 

            let remainingTerms = '-'; let roiTerms = "-";
            const method = record.method || ''; const isSpecialMethod = ['設定', '票貼', '小額'].includes(method);
            if (!isSpecialMethod) {
                const terms = Number(record.terms) || 0; 
                const repaidTerms = entries.length;
                let val = terms - repaidTerms; if (val < 0) val = 0; remainingTerms = Math.floor(val); 
                
                const termPrincipal = Number(record.principalPerTerm) || 0; 
                const termInterest = Number(record.interestPerTerm) || 0; 
                const termTotal = termPrincipal + termInterest;
                
                if (record.status === '3') roiTerms = "∞"; 
                else if (record.status === '1') { 
                    if (termTotal > 0 && outstanding > 0) { 
                        let val = outstanding / termTotal; 
                        if (val < 0) val = 0; 
                        roiTerms = Math.ceil(val);
                    } else if (outstanding <= 0) roiTerms = "0"; 
                }
            }
            return { outstanding, arrears, remainingTerms, roiTerms, totalPrincipalPaid, totalInterestPaid };
        };
        
        const getStatusLabel = (status) => {
            switch(String(status)) {
                case '0': return { text: '結案', color: 'bg-gray-100 text-gray-600' };
                case '1': return { text: '進行中', color: 'bg-emerald-100 text-emerald-600' };
                case '2': return { text: '代管中', color: 'bg-blue-100 text-blue-600' };
                case '3': return { text: '呆帳', color: 'bg-red-100 text-red-600' };
                case '4': return { text: '結案(呆)', color: 'bg-orange-100 text-orange-600' };
                default: return { text: status, color: 'bg-gray-100 text-gray-600' };
            }
        };

        // --- Logic ---
        const updateState = (updates) => { Object.assign(state, updates); renderApp(); };

        window.updateStatus4Amount = async (id, field, value) => {
            const val = Number(value) || 0;
            const idx = state.records.findIndex(r => r.id === id);
            
            if (idx !== -1) {
                const updatedRecord = { ...state.records[idx] };
                if (field === 'arrears') updatedRecord.arrears = val;
                else if (field === 'outstanding') updatedRecord.outstandingPrincipal = val;
                
                state.records[idx] = updatedRecord;
                renderApp();

                if (firebaseAvailable && state.currentUser) {
                    try {
                        const updateData = {};
                        if (field === 'arrears') updateData.arrears = val;
                        if (field === 'outstanding') updateData.outstandingPrincipal = val;
                        // Use public collection
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'loan_records', id), updateData);
                    } catch (e) {
                        console.error("Update failed", e);
                        window.showError("更新失敗，請檢查網路連線。");
                    }
                }
            }
        };

        // 修改點2: 更新搜尋邏輯只搜尋借款人和編號
        const calculateStats = () => {
            const s = { 
                totalIncome: 0, creditAmount: 0, outstanding: 0, 
                monthCollected: 0, monthInterestCollected: 0, monthDue: 0, monthInterestDue: 0, 
                borrowers: 0, 
                badDebtAmount: 0, 
                currentLent: 0, 
                monthDiff: 0, monthInterestDiff: 0, totalManagementFee: 0, 
                activeCases: 0, unpaidCount: 0, normalClosedCount: 0, closedBadDebtCount: 0, activeBadDebtCount: 0,
                unpaidRecords: [], closedRecords: [], activeRecords: [], badDebtCases: []
            };

            const uniqueBorrowers = new Set();
            
            // Filter records based on Admin View Mode
            let displayRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all') {
                displayRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                 // Double check, though onSnapshot should have handled it
                 displayRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }

            // 修改搜尋邏輯
            const searchTerm = state.searchTerm.toLowerCase();
            const filtered = displayRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm))
            );

            // 修正點3: 計算本月已收款和本月已收息
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            filtered.forEach(r => {
                const calc = calculateDerivedData(r); 
                const principal = Number(r.principalPerTerm) || 0; 
                const termInterest = Number(r.interestPerTerm) || 0;
                
                if (r.status === '1' || r.status === '3' || r.status === '4') {
                     s.creditAmount += calc.arrears;
                     s.outstanding += calc.outstanding;
                     s.currentLent += Number(r.disbursed) || 0;
                }

                if (r.status === '1') {
                    s.monthDue += (principal + termInterest);
                    s.monthInterestDue += termInterest; 
                } else if (r.status === '2') {
                    s.monthDue += termInterest; 
                    s.hasManagedCases = true;
                    s.totalManagementFee += termInterest; 
                }

                if (r.status === '3' || r.status === '4') {
                    s.badDebtAmount += calc.arrears;
                }

                if (r.status === '0') {
                    s.normalClosedCount++; s.closedRecords.push(r);
                } else if (r.status === '4') {
                    s.closedBadDebtCount++; s.badDebtCases.push(r);
                } else if (r.status === '3') {
                    s.activeBadDebtCount++; s.badDebtCases.push(r);
                } else if (r.status === '1') {
                    s.activeCases++; s.activeRecords.push(r);
                    const { isOverdue } = getPaymentStatus(r);
                    if (isOverdue) { s.unpaidCount++; s.unpaidRecords.push(r); }
                    
                    const { isPaid } = getPaymentStatus(r);
                    if (!isPaid) {
                        s.monthDiff += (principal + termInterest);
                        s.monthInterestDiff += termInterest;
                    }
                } else if (r.status === '2') {
                     const { isPaid } = getPaymentStatus(r);
                     if (!isPaid) {
                        s.monthDiff += termInterest; 
                     }
                }

                s.totalIncome += calc.totalInterestPaid; 
                
                // 修正點3: 計算本月已收款和本月已收息
                if (r.status === '1' || r.status === '2') {
                    const { isPaid } = getPaymentStatus(r);
                    if (isPaid) {
                        // 本月已收款 = 本金 + 利息
                        s.monthCollected += (r.status === '2' ? 0 : principal) + termInterest;
                        // 本月已收息 = 利息
                        s.monthInterestCollected += termInterest;
                    }
                }

                if (r.borrower) uniqueBorrowers.add(r.borrower);
            });

            s.totalIncome -= s.badDebtAmount; 
            s.borrowers = uniqueBorrowers.size;
            return s;
        };

        const getCardConfig = (id) => {
            const stats = calculateStats(); if (!stats) return null;
            const layoutItem = state.cardLayout.find(c => c.id === id);
            const width = layoutItem ? layoutItem.width : 1;
            const config = {
                totalIncome: { label: "總收入 (累計)", value: stats.totalIncome, type: "primary", icon: "wallet", isCurrency: true },
                creditAmount: { label: "債權總額", value: stats.creditAmount, type: "primary", icon: "file-text", isCurrency: true },
                outstanding: { label: "在外本金", value: stats.outstanding, type: "warning", icon: "dollar-sign", isCurrency: true },
                currentLent: { label: "目前放款額", value: stats.currentLent, type: "warning", icon: "credit-card", isCurrency: true },
                monthDue: { label: "本月應收款", value: stats.monthDue, type: "primary", icon: "credit-card", compact: true, isCurrency: true },
                monthCollected: { label: "本月已收款", value: stats.monthCollected, type: "primary", icon: "check", compact: true, isCurrency: true },
                monthDiff: { label: "本月款差", value: stats.monthDiff, type: "critical", icon: "alert-circle", compact: true, isCurrency: true },
                monthInterestDiff: { label: "本月息差", value: stats.monthInterestDiff, type: "critical", icon: "alert-circle", compact: true, isCurrency: true },
                monthInterestDue: { label: "本月應收息", value: stats.monthInterestDue, type: "primary", icon: "trending-up", compact: true, isCurrency: true },
                monthInterestCollected: { label: "本月已收息", value: stats.monthInterestCollected, type: "primary", icon: "check", compact: true, isCurrency: true },
                totalManagementFee: { label: "本月管理費", value: stats.totalManagementFee, type: "primary", icon: "credit-card", isCurrency: true },
                badDebtAmount: { label: "呆帳金額", value: stats.badDebtAmount, type: "critical", icon: "x", isCurrency: true }
            };
            if (id === 'totalManagementFee' && !stats.hasManagedCases) return null;
            return { ...config[id], width };
        };

        window.setActiveTab = (tab) => updateState({ activeTab: tab, modalType: null });
        window.updateState = (updates) => updateState(updates);
        window.handleDragStart = (e, id) => { e.dataTransfer.setData('cardId', id); };
        window.handleDragOver = (e) => { e.preventDefault(); };
        window.handleDrop = (e, targetId) => { e.preventDefault(); const sourceId = e.dataTransfer.getData('cardId'); if (sourceId && sourceId !== targetId) { const layout = [...state.cardLayout]; const fromIndex = layout.findIndex(c => c.id === sourceId); const toIndex = layout.findIndex(c => c.id === targetId); if (fromIndex !== -1 && toIndex !== -1) { const [moved] = layout.splice(fromIndex, 1); layout.splice(toIndex, 0, moved); updateState({ cardLayout: layout }); } } };
        window.resizeCard = (e, id) => { e.stopPropagation(); const layout = state.cardLayout.map(c => { if (c.id === id) { return { ...c, width: c.width === 2 ? 1 : 2 }; } return c; }); updateState({ cardLayout: layout }); };
        window.toggleAuthMode = () => { updateState({ isRegistering: !state.isRegistering }); };
        
        // --- FIX: Correct Auth flow to prevent input clearing ---
        window.handleAuth = async (e) => { 
            e.preventDefault(); 
            if (!firebaseAvailable) { window.showError("Firebase 未設定，將無法儲存資料。"); return; } 
            
            // 1. Get values BEFORE updating state (which causes re-render)
            const usernameInput = document.getElementById('authUsername').value.trim(); 
            const passwordInput = document.getElementById('authPassword').value; 
            const emailInput = state.isRegistering ? document.getElementById('authEmail').value.trim() : null;
            const confirmPass = state.isRegistering ? document.getElementById('authConfirmPassword').value : null;

            // 2. Set loading state
            updateState({ authLoading: true }); 

            try { 
                const userDirCollection = collection(db, 'artifacts', appId, 'public', 'data', 'user_directory');

                if (state.isRegistering) { 
                    if (passwordInput !== confirmPass) throw new Error("密碼不一致"); 
                    
                    // Check if first user in system
                    const snapshot = await getDocs(query(userDirCollection, limit(1)));
                    const isFirstUser = snapshot.empty;
                    const role = isFirstUser ? 'admin' : 'user';
                    const allowedStatus = isFirstUser ? ['0', '1', '2', '3', '4'] : ['0', '1', '3', '4']; // Default users cannot use Status 2

                    const userCredential = await createUserWithEmailAndPassword(auth, emailInput, passwordInput); 
                    const user = userCredential.user; 
                    await updateProfile(user, { displayName: usernameInput }); 
                    
                    // Store user profile in public directory
                    await setDoc(doc(userDirCollection, user.uid), { 
                        email: emailInput, 
                        uid: user.uid, 
                        username: usernameInput, 
                        role: role,
                        allowedStatus: allowedStatus,
                        createdAt: serverTimestamp() 
                    }); 
                    
                } else { 
                    // Login
                    const q = query(userDirCollection, where("username", "==", usernameInput));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        // Fallback: try login as email if format looks like email
                        if (usernameInput.includes('@')) {
                            await signInWithEmailAndPassword(auth, usernameInput, passwordInput);
                        } else {
                            throw new Error("找不到帳號，請確認 ID 是否正確");
                        }
                    } else {
                        const userDoc = querySnapshot.docs[0];
                        const targetEmail = userDoc.data().email; 
                        await signInWithEmailAndPassword(auth, targetEmail, passwordInput); 
                    } 
                } 
            } catch (err) { 
                window.showError(err.message); 
                updateState({ authLoading: false }); 
            } 
        };

        window.handleLogout = async () => { if (firebaseAvailable) { try { await signOut(auth); } catch (e) { console.error(e); } } updateState({ currentUser: null, currentUserUid: null, isAdmin: false, isDemoMode: false, records: [] }); window.location.reload(); };
        window.openNewForm = () => { formData = { ...initialFormState }; updateState({ editingRecord: null, activeTab: 'form' }); };
        window.startEdit = (id) => { const record = state.records.find(r => r.id === id); if (record) { formData = { ...record }; updateState({ editingRecord: record, activeTab: 'form' }); } };
        
        window.handleSearch = (val) => { state.searchTerm = val; state.currentPage = 1; state.unpaidFilter = null; window.refreshListUI(); };
        window.changePage = (delta) => { state.currentPage += delta; window.refreshListUI(); };
        
        // 修改點4: 新增翻頁功能函數
        window.goToFirstPage = () => { state.currentPage = 1; window.refreshListUI(); };
        window.goToLastPage = () => { 
            let sourceRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all') {
                sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }
            
            // 使用新的搜尋邏輯
            const searchTerm = state.searchTerm.toLowerCase();
            let filtered = sourceRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm))
            );
            
            // 套用未繳篩選
            if (state.unpaidFilter === 'all_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid } = getPaymentStatus(r);
                    return r.status === '1' && !isPaid;
                });
            } else if (state.unpaidFilter === 'current_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid } = getPaymentStatus(r);
                    return r.status === '1' && !isPaid;
                });
            }
            
            const totalPages = Math.ceil(filtered.length / state.itemsPerPage) || 1;
            state.currentPage = totalPages;
            window.refreshListUI(); 
        };
        
        window.goToPage = (pageNum) => { 
            let sourceRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all') {
                sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }
            
            // 使用新的搜尋邏輯
            const searchTerm = state.searchTerm.toLowerCase();
            let filtered = sourceRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm))
            );
            
            // 套用未繳篩選
            if (state.unpaidFilter === 'all_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid } = getPaymentStatus(r);
                    return r.status === '1' && !isPaid;
                });
            } else if (state.unpaidFilter === 'current_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid } = getPaymentStatus(r);
                    return r.status === '1' && !isPaid;
                });
            }
            
            const totalPages = Math.ceil(filtered.length / state.itemsPerPage) || 1;
            const page = parseInt(pageNum);
            if (!isNaN(page) && page >= 1 && page <= totalPages) {
                state.currentPage = page;
                window.refreshListUI();
            }
        };
        
        // 修改點5: 新增未繳案件篩選函數
        window.filterUnpaidCases = (type) => {
            state.unpaidFilter = type;
            state.currentPage = 1;
            state.searchTerm = '';
            window.refreshListUI();
        };
        
        window.clearUnpaidFilter = () => {
            state.unpaidFilter = null;
            state.currentPage = 1;
            window.refreshListUI();
        };

        window.updateFormData = (key, val, shouldRender = false) => { 
            formData[key] = val; 
            const loan = Number(formData.loanAmount) || 0; 
            const t = Number(formData.terms) || 0; 
            const interestRate = (parseFloat(formData.interestRate) || 0) / 100; 
            const specialRate = (parseFloat(formData.specialRate) || 0) / 100; 

            if (key === 'loanAmount' || key === 'terms' || key === 'status' || key === 'method') { 
                if (formData.status === '2') { formData.principalPerTerm = 0; } 
                else if ((formData.status === '1' || formData.method === '叨簿子') && t > 0) formData.principalPerTerm = Math.round(loan / t); 
                if (['設定', '票貼', '小額'].includes(formData.method)) { formData.principalPerTerm = 0; formData.terms = 0; } 
            } 
            if (key === 'status' || key === 'loanAmount' || key === 'interestRate' || key === 'specialRate') { 
                if (formData.status === '2') { formData.interestPerTerm = Math.round(loan * interestRate); formData.managementFee = Math.round(loan * specialRate); } 
                else { formData.interestPerTerm = Math.round(loan * interestRate); formData.managementFee = 0; } 
            } 

            if (shouldRender) { renderApp(); } 
            else { 
                const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; }; 
                const setText = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; }; 
                
                setVal('input_principalPerTerm', formData.principalPerTerm); 
                setVal('input_interestPerTerm', formData.interestPerTerm); 
                
                const calc = calculateDerivedData(formData); 
                setText('display_arrears', formatNumber(calc.arrears)); 
                setText('display_outstanding', formatNumber(calc.outstanding)); 
                
                if(formData.status === '2') { 
                    const expected = Math.round((loan/t||0) + (loan*specialRate) - (loan*interestRate)); 
                    setVal('input_expectedPayment', formatNumber(expected)); 
                } 
            } 
        };

        window.handleSaveForm = async () => { 
            if (!state.currentUser && !state.isDemoMode) { window.showError("請先登入才能儲存資料。"); return; } 
            
            const dataToSave = { ...formData, updatedAt: serverTimestamp() }; 
            
            if (state.isDemoMode) { 
                if (!state.editingRecord) { 
                    const newRec = { ...dataToSave, id: `new_${Date.now()}`, caseNumber: '', createdAt: serverTimestamp(), ownerUid: 'demo' }; 
                    state.records.push(newRec); 
                } else { 
                    const idx = state.records.findIndex(r => r.id === state.editingRecord.id); 
                    if (idx !== -1) state.records[idx] = { ...state.records[idx], ...dataToSave }; 
                } 
                
                // 重新排序並編號
                const userRecords = state.records.filter(r => r.ownerUid === 'demo');
                const sorted = userRecords.sort((a, b) => {
                    const dateA = new Date(a.date || '9999-12-31');
                    const dateB = new Date(b.date || '9999-12-31');
                    return dateA - dateB;
                });
                
                // 重新賦予編號
                sorted.forEach((record, index) => {
                    record.caseNumber = formatCaseId(index + 1);
                    record.displayId = formatCaseId(index + 1);
                });
                
                // 合併回所有記錄
                const otherRecords = state.records.filter(r => r.ownerUid !== 'demo');
                state.records = [...otherRecords, ...sorted];
                
            } else if (firebaseAvailable) { 
                // Save to PUBLIC collection with ownerUid
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'loan_records'); 
                
                if (!state.editingRecord) { 
                    dataToSave.createdAt = serverTimestamp(); 
                    dataToSave.ownerUid = state.currentUserUid; // Important: Tag the owner
                    await addDoc(colRef, dataToSave); 
                } else { 
                    await updateDoc(doc(colRef, state.editingRecord.id), dataToSave); 
                } 
                
                // 重新排序並編號
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'loan_records'),
                    where('ownerUid', '==', state.currentUserUid),
                    orderBy('date', 'asc')
                );
                const querySnapshot = await getDocs(q);
                
                // 批次更新所有記錄的編號
                const batch = writeBatch(db);
                
                querySnapshot.docs.forEach((docSnap, index) => {
                    const newCaseNumber = formatCaseId(index + 1);
                    batch.update(docSnap.ref, { 
                        caseNumber: newCaseNumber,
                        displayId: newCaseNumber
                    });
                });
                
                await batch.commit();
            } 
            window.setActiveTab('list'); 
            window.showSuccess(`案件資料已成功${state.editingRecord ? '更新' : '新增'}，編號已按日期重新排序。`);
        };
        
        window.handleDelete = (id) => {
            window.showConfirm("確定要永久刪除此案件嗎？此操作無法復原。", async (confirmed) => {
                if (!confirmed) return;
                
                if (state.isDemoMode) {
                    // 刪除案件
                    state.records = state.records.filter(r => r.id !== id);
                    
                    // 重新排序並編號
                    const userRecords = state.records.filter(r => r.ownerUid === 'demo');
                    const sorted = userRecords.sort((a, b) => {
                        const dateA = new Date(a.date || '9999-12-31');
                        const dateB = new Date(b.date || '9999-12-31');
                        return dateA - dateB;
                    });
                    
                    // 重新賦予編號
                    sorted.forEach((record, index) => {
                        record.caseNumber = formatCaseId(index + 1);
                        record.displayId = formatCaseId(index + 1);
                    });
                    
                    // 合併回所有記錄
                    const otherRecords = state.records.filter(r => r.ownerUid !== 'demo');
                    state.records = [...otherRecords, ...sorted];
                    
                    renderApp();
                    window.showSuccess("案件已成功刪除，編號已重新排序。");
                } else if (firebaseAvailable) {
                    try {
                        // 先刪除文件
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'loan_records', id));
                        
                        // 重新排序並編號
                        const q = query(
                            collection(db, 'artifacts', appId, 'public', 'data', 'loan_records'),
                            where('ownerUid', '==', state.currentUserUid),
                            orderBy('date', 'asc')
                        );
                        const querySnapshot = await getDocs(q);
                        
                        // 批次更新所有記錄的編號
                        const batch = writeBatch(db);
                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'loan_records');
                        
                        querySnapshot.docs.forEach((docSnap, index) => {
                            const newCaseNumber = formatCaseId(index + 1);
                            batch.update(docSnap.ref, { 
                                caseNumber: newCaseNumber,
                                displayId: newCaseNumber
                            });
                        });
                        
                        await batch.commit();
                        window.showSuccess("案件已成功刪除，編號已重新排序。");
                    } catch (e) {
                        window.showError("刪除失敗，請檢查權限或連線。");
                    }
                }
            });
        };
        
        // --- Admin Functions (FIXED: Simplified argument passing) ---
        window.toggleUserStatus2Permission = async (uid) => {
            if (!state.isAdmin) return;
            
            // Find current user data from local state instead of passing from HTML
            const targetUser = state.usersDirectory.find(u => u.uid === uid);
            if (!targetUser) {
                window.showError("找不到用戶資料");
                return;
            }
            
            const currentAllowed = targetUser.allowedStatus || [];

            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_directory', uid);
                let newAllowed = [...currentAllowed];
                
                if (newAllowed.includes('2')) {
                    newAllowed = newAllowed.filter(s => s !== '2');
                } else {
                    newAllowed.push('2');
                    newAllowed.sort();
                }
                
                await updateDoc(userRef, { allowedStatus: newAllowed });
                window.showSuccess("權限已更新");
            } catch(e) {
                console.error(e);
                window.showError("權限更新失敗");
            }
        };

        window.updateRepaymentInput = (key, val) => { state[key] = val; };
        window.updateRepaymentSearch = (val) => { state.repaymentSearchTerm = val; state.selectedRepaymentId = ''; const container = document.getElementById('repaymentDropdownContainer'); const select = document.getElementById('repaymentSelect'); if (container && select) { const repaymentCases = state.records.filter(r => (r.status === '1' || r.status === '2')); if (val) { select.hidden = true; select.classList.add('hidden'); container.hidden = false; container.classList.remove('hidden'); const filteredOptions = repaymentCases.filter(r => { const { isPaid } = getPaymentStatus(r); const matchesSearch = (r.borrower||'').includes(val) || (r.displayId||'').includes(val); return matchesSearch && !isPaid; }); if (filteredOptions.length > 0) { const html = filteredOptions.map(r => { const amount = (Number(r.currentPrincipal)||Number(r.principalPerTerm)||0) + (Number(r.currentInterest)||Number(r.interestPerTerm)||0); const displayId = r.displayId || r.caseNumber || ''; return `<div onclick="window.handleRepaymentSelect('${r.id}')" class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0 text-sm"><span class="font-bold text-gray-800">${displayId} - ${r.borrower || ''}</span><span class="block text-xs text-red-500">此案件本月尚未繳款</span><span class="block text-xs text-gray-500">每期應繳: $${formatNumber(amount)}</span></div>`; }).join(''); container.innerHTML = html; } else { container.innerHTML = `<div class="p-3 text-gray-500 text-sm text-center">找不到符合條件的未繳案件</div>`; } } else { select.hidden = false; select.classList.remove('hidden'); container.hidden = true; container.classList.add('hidden'); container.innerHTML = ''; } } };
        
        window.handleRepaymentSelect = (id) => { 
            const record = state.records.find(r => r.id === id); 
            if (record) { 
                const { isPaid } = getPaymentStatus(record); 
                const defP = record.currentPrincipal !== undefined && record.currentPrincipal !== "" ? Number(record.currentPrincipal) : Number(record.principalPerTerm);
                const defI = record.currentInterest !== undefined && record.currentInterest !== "" ? Number(record.currentInterest) : Number(record.interestPerTerm);

                updateState({ 
                    selectedRepaymentId: id, 
                    repaymentSearchTerm: '', 
                    repaymentPrincipal: isPaid || record.status === '2' ? 0 : defP, 
                    repaymentInterest: isPaid ? 0 : defI
                }); 
            } 
        };
        window.resetRepaymentSelection = () => updateState({ selectedRepaymentId: '', repaymentPrincipal: '', repaymentInterest: '' });
        
        window.submitRepayment = async () => { 
            const record = state.records.find(r => r.id === state.selectedRepaymentId); 
            if (!record) return; 
            
            // 使用新格式
            const newEntry = `${state.repaymentDate} 本金:${Number(state.repaymentPrincipal)} 利息:${Number(state.repaymentInterest)}`;
            const currentSchedule = record.schedule || ''; 
            const newSchedule = (currentSchedule ? currentSchedule + '\n' : '') + newEntry;
            const sortedSchedule = sortScheduleLines(newSchedule.split('\n').filter(x=>x.trim())).join('\n'); 
            
            const data = { 
                schedule: sortedSchedule, 
                lastRepaymentDate: state.repaymentDate, 
                updatedAt: serverTimestamp() 
            }; 
            
            if (state.isDemoMode) { 
                const idx = state.records.findIndex(r => r.id === record.id); 
                if (idx !== -1) state.records[idx] = { ...state.records[idx], ...data }; 
                renderApp(); 
            } else if (firebaseAvailable) { 
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'loan_records', record.id), data); 
            } 
            
            window.showSuccess("入帳成功！財務指標已更新。"); 
            window.resetRepaymentSelection(); 
        };
        
        window.openAIAdvisor = async () => { updateState({ showAIModal: true, aiLoading: true, aiReport: '' }); const stats = calculateStats(); const prompt = `角色：專業私人財務顧問。請根據數據生成繁體中文診斷報告：總收入$${stats.totalIncome}，呆帳$${stats.badDebtAmount}，逾期${stats.unpaidCount}筆。請給出評分與建議。`; setTimeout(async () => { const report = await window.callGemini(prompt); updateState({ aiReport: report, aiLoading: false }); }, 500); };
        window.callGemini = async (prompt) => { if (!apiKey) { if (prompt.includes("診斷報告")) return `**[AI 財務診斷報告 (模擬)]**\n\n基於您的數據...\n1. 營運狀況良好 (8/10)\n2. 注意呆帳風險\n3. 建議定期追蹤逾期案件`; return "模擬回應"; } try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); const data = await response.json(); return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI 暫時無法回應。"; } catch (e) { return "連線錯誤"; } };
        window.openMessageModal = (id) => { const r = state.records.find(rec => rec.id === id); updateState({ messageModalRecord: r, aiLoading: true, aiMessage: '' }); window.generateMessage('polite'); };
        window.generateMessage = async (tone) => { if (!state.messageModalRecord) return; updateState({ aiLoading: true }); const r = state.messageModalRecord; const amount = (Number(r.principalPerTerm)+Number(r.interestPerTerm)); const prompt = `寫一則${tone==='polite'?'委婉':tone==='firm'?'堅定':'嚴厲'}的催收簡訊給${r.borrower}，案件編號${r.caseNumber}，請款金額$${formatNumber(amount)}。請務必使用繁體中文。`; const msg = await window.callGemini(prompt); updateState({ aiMessage: msg, aiLoading: false }); };
        window.openModal = (type, id) => { const r = state.records.find(rec => rec.id === id); let lines = []; if (type === 'schedule') { lines = sortScheduleLines((r.schedule || '').split('\n').filter(l => l.trim() !== '')); } updateState({ activeModal: { type, record: r }, tempScheduleLines: lines }); };
        window.saveModalData = async (id, type) => { 
            let data = {}; 
            if (type === 'note') {
                const val = document.getElementById('modalTextarea') ? document.getElementById('modalTextarea').value : '';
                data.note = val; 
            } else { 
                const sorted = sortScheduleLines(state.tempScheduleLines).join('\n'); 
                data.schedule = sorted; 
                const r = state.records.find(rec => rec.id === id); 
                const count = extractDatesFromSchedule(sorted).length; 
                const dates = extractDatesFromSchedule(sorted); 
                let latestDate = null; 
                if (dates.length > 0) { 
                    dates.sort((a, b) => b - a); 
                    latestDate = dates[0].toISOString().split('T')[0]; 
                } 
                data.repaidTerms = count; 
                data.totalInterestIncome = count * (Number(r.interestPerTerm)||0); 
                data.actualReceivedMonth = count * (Number(r.principalPerTerm)||0); 
                if(latestDate) data.lastRepaymentDate = latestDate; 
            } 
            if (state.isDemoMode) { 
                const idx = state.records.findIndex(r => r.id === id); 
                if (idx !== -1) state.records[idx] = { ...state.records[idx], ...data }; 
                renderApp(); 
            } else if (firebaseAvailable) { 
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'loan_records', id), data); 
            } 
            updateState({ activeModal: { type: null, record: null } }); 
        };
        
        // 修改點3: 更新 addScheduleLine 函數
        window.addScheduleLine = () => {
            const record = state.activeModal.record;
            const principal = Number(record.principalPerTerm) || 0;
            const interest = Number(record.interestPerTerm) || 0;
            const today = new Date().toISOString().split('T')[0];
            state.tempScheduleLines.push(`${today} 本金:${principal} 利息:${interest}`);
            renderApp();
        };
        
        window.updateScheduleLine = (index, value) => { state.tempScheduleLines[index] = value; }; 
        window.deleteScheduleLine = (index) => { state.tempScheduleLines.splice(index, 1); renderApp(); };
        window.handlePaymentStatusClick = (id) => { window.handleRepaymentSelect(id); updateState({ activeTab: 'repayment' }); };
        
        window.enterDemoMode = () => { 
            if(state.records.length === 0) { 
                // Restore demo data
                state.records = [
                     { id: 'demo1', caseNumber: '#001', displayId: '#001', borrower: '王小明', status: '1', method: '叨簿子', loanAmount: 100000, disbursed: 90000, interestRate: 5.0, terms: 10, principalPerTerm: 10000, interestPerTerm: 5000, date: '2023-10-01', schedule: '2023-11-01 本金:10000 利息:5000\n2023-12-01 本金:10000 利息:5000', note: '正常繳款中', job: '工程師', agent: '張三', ownerUid: 'demo' },
                     { id: 'demo2', caseNumber: '#002', displayId: '#002', borrower: '李大華', status: '4', method: '設定', loanAmount: 500000, disbursed: 450000, interestRate: 3.0, specialRate: 5.0, terms: 0, principalPerTerm: 0, interestPerTerm: 15000, date: '2023-09-15', schedule: '', note: '代管案件，每月僅收息', job: '業務', agent: '李四', ownerUid: 'demo' },
                     { id: 'demo3', caseNumber: '#003', displayId: '#003', borrower: '陳淑芬', status: '3', method: '票貼', loanAmount: 30000, disbursed: 27000, interestRate: 10.0, terms: 3, principalPerTerm: 10000, interestPerTerm: 3000, date: '2023-11-01', schedule: '', note: '已失聯，列為呆帳', job: '自營商', agent: '王五', ownerUid: 'demo' },
                     { id: 'demo4', caseNumber: '#004', displayId: '#004', borrower: '張志豪', status: '0', method: '小額', loanAmount: 20000, disbursed: 20000, interestRate: 0, terms: 1, principalPerTerm: 20000, interestPerTerm: 0, date: '2023-08-01', schedule: '2023-08-05 本金:20000 利息:0', note: '已結清', job: '司機', agent: '趙六', ownerUid: 'demo' }
                ];
            } 
            // FIXED: Set isAdmin to false for Demo users to hide Admin features
            updateState({ isDemoMode: true, currentUser: 'Guest', allowedStatus: ['0','1','2','3','4'], isAdmin: false }); 
        };
        window.openModalList = (type) => updateState({ modalType: type });

        // =======================================================
        // NEW: EXCEL EXPORT & VERTICAL CSV IMPORT LOGIC
        // =======================================================
        
        // --- 1. Export Logic ---
        window.exportToExcel = () => {
            // 獲取當前過濾的資料（與列表顯示一致）
            let sourceRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all') {
                sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }
            
            // 使用新的搜尋邏輯
            const searchTerm = state.searchTerm.toLowerCase();
            const filtered = sourceRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm))
            );
            
            if (filtered.length === 0) {
                window.showError("目前無資料可匯出");
                return;
            }

            // 定義垂直 CSV 的欄位順序（根據您提供的 CSV 格式）
            const verticalFields = [
                '狀態', '方式', '日期', '借款人', '工作', '借款', '放款', '利息',
                '銀行/人', '期數', '每期還款日期', '每期還款本金', '利息', '還款期數',
                '利息收入', '欠款', '在外本金', '餘期', '回本餘期', '利息收入',
                '本月實收款', '本月實收息', '附註', '還款日期'
            ];
            
            // 建立垂直格式的 CSV
            let csvLines = [];
            
            // 對於每個欄位，收集所有記錄的該欄位值
            verticalFields.forEach((fieldName, rowIndex) => {
                let rowValues = [fieldName]; // 第一欄是欄位名稱
                
                filtered.forEach((record, colIndex) => {
                    let value = '';
                    const calc = calculateDerivedData(record);
                    
                    switch(fieldName) {
                        case '狀態':
                            value = getStatusLabel(record.status).text;
                            break;
                        case '方式':
                            value = record.method || '';
                            break;
                        case '日期':
                            value = record.date || '';
                            break;
                        case '借款人':
                            value = record.borrower || '';
                            break;
                        case '工作':
                            value = record.job || '';
                            break;
                        case '借款':
                            value = formatNumber(record.loanAmount || 0);
                            break;
                        case '放款':
                            value = formatNumber(record.disbursed || 0);
                            break;
                        case '利息':
                            value = record.interestRate || 0;
                            break;
                        case '銀行/人':
                            value = record.agent || '';
                            break;
                        case '期數':
                            value = record.terms || 0;
                            break;
                        case '每期還款日期':
                            value = record.repayDay || '';
                            break;
                        case '每期還款本金':
                            value = formatNumber(record.principalPerTerm || 0);
                            break;
                        case '利息':
                            value = formatNumber(record.interestPerTerm || 0);
                            break;
                        case '還款期數':
                            value = parseSchedule(record.schedule).length;
                            break;
                        case '利息收入':
                            value = formatNumber(calc.totalInterestPaid || 0);
                            break;
                        case '欠款':
                            value = formatNumber(calc.arrears || 0);
                            break;
                        case '在外本金':
                            value = formatNumber(calc.outstanding || 0);
                            break;
                        case '餘期':
                            value = calc.remainingTerms || 0;
                            break;
                        case '回本餘期':
                            value = calc.roiTerms || 0;
                            break;
                        case '利息收入':
                            value = formatNumber(calc.totalInterestPaid || 0);
                            break;
                        case '本月實收款':
                            value = formatNumber(calc.totalPrincipalPaid || 0);
                            break;
                        case '本月實收息':
                            value = formatNumber(calc.totalInterestPaid || 0);
                            break;
                        case '附註':
                            value = record.note || '';
                            break;
                        case '還款日期':
                            const dates = extractDatesFromSchedule(record.schedule);
                            if (dates.length > 0) {
                                dates.sort((a, b) => b.getTime() - a.getTime());
                                value = dates[0].toISOString().split('T')[0];
                            }
                            break;
                        default:
                            value = '';
                    }
                    
                    // 處理特殊字元並加入該列
                    rowValues.push(`"${String(value).replace(/"/g, '""')}"`);
                });
                
                csvLines.push(rowValues.join(','));
            });
            
            const csvContent = csvLines.join('\n');
            
            // 建立 Blob 並下載
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `借貸管理資料_垂直格式_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- 2. Vertical CSV Import Logic (Ported from loanmgmt4-3.html) ---
        
        // 核心欄位垂直索引定義
        const MAP_ROWS = {
            STATUS: 0,          // 狀態 (第一行)
            CATEGORY: 1,        // 方式 (第二行)
            LOAN_DATE: 2,       // 日期 (第三行)
            BORROWER: 3,        // 借款人 (第四行)
            JOB: 4,             // 工作
            AMOUNT: 5,          // 借款
            ACTUAL_AMOUNT: 6,   // 放款
            INTEREST_RATE: 7,   // 利息
            AGENT: 8,           // 銀行/人
            PERIODS: 9,         // 期數
            RULE_DAY: 10,       // 每期還款日期 (規則)
            HISTORY_START: 11   // 歷史還款日期開始的垂直行索引 (第 12 行)
        };
        
        const cleanNumber = (val) => val ? parseFloat(String(val).replace(/,/g, '').replace(/%/g, '').trim()) : 0;
        
        // CSV 垂直解析函數
        const parseCSV = (text) => {
            const rows = text.trim().split(/\r\n|\n/).map(row => {
                let values = [];
                let current = '';
                let inQuotes = false;
                for (let j = 0; j < row.length; j++) {
                    const char = row[j];
                    if (char === '"') { inQuotes = !inQuotes; } 
                    else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; } 
                    else { current += char; }
                }
                values.push(current.trim());
                return values;
            }).filter(values => values.length > 1);

            if (rows.length === 0) return [];
            
            const parsedCases = [];
            const totalCols = rows[0].length;
            const startingCol = 2; // 數據從 C 欄開始

            for (let col = startingCol; col < totalCols; col++) {
                const borrowerName = rows[MAP_ROWS.BORROWER]?.[col]?.trim();
                const loanAmount = cleanNumber(rows[MAP_ROWS.AMOUNT]?.[col]);
                
                if (!borrowerName || loanAmount === 0) continue; 

                let status = String(rows[MAP_ROWS.STATUS]?.[col] || '1').trim();
                const terms = cleanNumber(rows[MAP_ROWS.PERIODS]?.[col]);
                const interestRateFloat = cleanNumber(rows[MAP_ROWS.INTEREST_RATE]?.[col]) / 100;

                if (!['0', '1', '2', '3', '4'].includes(status)) {
                    if (status.includes('進行')) status = '1';
                    else if (status.includes('代管')) status = '2';
                    else if (status.includes('呆帳')) status = '3';
                    else if (status.includes('結案')) status = '0';
                    else status = '1'; 
                }

                let principalPerTerm = 0;
                if (status !== '2' && terms > 0) {
                    principalPerTerm = Math.round(loanAmount / terms);
                }
                const interestPerTerm = Math.round(loanAmount * interestRateFloat);

                const scheduleLines = [];
                let lastRepaymentDate = '';

                for (let rowIdx = MAP_ROWS.HISTORY_START; rowIdx < rows.length; rowIdx++) {
                    const historyDateStr = rows[rowIdx]?.[col]?.trim();
                    if (historyDateStr && /\d{4}[-\/]\d{1,2}[-\/]\d{1,2}/.test(historyDateStr)) {
                        const cleanDate = historyDateStr.replace(/\//g, '-');
                        const entry = `${cleanDate} 本金:${principalPerTerm} 利息:${interestPerTerm}`;
                        scheduleLines.push(entry);
                    }
                }
                
                const sortedSchedule = sortScheduleLines(scheduleLines).join('\n');
                const repaidTermsCount = extractDatesFromSchedule(sortedSchedule).length;
                const totalInterestIncome = repaidTermsCount * interestPerTerm;
                
                if (repaidTermsCount > 0) {
                    const allDates = extractDatesFromSchedule(sortedSchedule);
                    allDates.sort((a, b) => b.getTime() - a.getTime());
                    if (allDates.length > 0) lastRepaymentDate = allDates[0].toISOString().split('T')[0];
                }

                const newCase = {
                    status: status,
                    method: rows[MAP_ROWS.CATEGORY]?.[col] || '',
                    date: rows[MAP_ROWS.LOAN_DATE]?.[col] || '',
                    borrower: borrowerName,
                    job: rows[MAP_ROWS.JOB]?.[col] || '',
                    loanAmount: loanAmount,
                    disbursed: cleanNumber(rows[MAP_ROWS.ACTUAL_AMOUNT]?.[col]) || loanAmount,
                    interestRate: cleanNumber(rows[MAP_ROWS.INTEREST_RATE]?.[col]) || 0,
                    agent: rows[MAP_ROWS.AGENT]?.[col] || '',
                    terms: terms,
                    repayDay: rows[MAP_ROWS.RULE_DAY]?.[col] || '',
                    principalPerTerm: principalPerTerm,
                    interestPerTerm: interestPerTerm,
                    schedule: sortedSchedule,
                    repaidTerms: repaidTermsCount,
                    totalInterestIncome: totalInterestIncome,
                    lastRepaymentDate: lastRepaymentDate,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    note: '', idNumber: '', address: '', telephone: '', mobile: '',
                };
                parsedCases.push(newCase);
            }
            return parsedCases;
        };
        
        const showLoading = (show, text = "處理中...") => {
            const modal = document.getElementById('loading-modal');
            const textEl = document.getElementById('loading-text');
            if (modal) {
                if (show) {
                    modal.classList.remove('hidden');
                    if (textEl) textEl.textContent = text;
                    state.isImporting = true;
                } else {
                    modal.classList.add('hidden');
                    state.isImporting = false;
                }
            }
            renderApp(); 
        };

        window.handleFileSelect = () => { document.getElementById('csvFileInput').click(); };

        window.handleFileChange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) { window.showError("請選擇有效的 CSV 檔案。"); return; }

            const reader = new FileReader();
            reader.readAsText(file, 'Big5'); // Support Traditional Chinese Encoding

            reader.onload = async (e) => {
                const csvText = e.target.result;
                try { await window.processCsvData(csvText); } 
                catch (error) { showLoading(false); console.error("CSV 處理失敗:", error); window.showError(`CSV 匯入處理失敗。`); }
            };
            event.target.value = ''; 
        };
        
        window.processCsvData = async (csvText) => {
            if (!state.currentUser && !state.isDemoMode) { window.showError("請先登入才能匯入資料。"); return; }
            
            showLoading(true, "正在解析檔案及計算合約金額...");
            
            let records = [];
            try { records = parseCSV(csvText); } 
            catch (e) { showLoading(false); window.showError(`CSV 解析錯誤: ${e.message}`); return; }
            
            if (records.length === 0) { showLoading(false); window.showError("CSV 檔案內容為空或無法解析出有效案件。"); return; }
            
            // CSV導入後的重新排序
            if (state.isDemoMode) {
                const demoRecords = records.map(r => ({ 
                    ...r, 
                    createdAt: new Date().getTime(), 
                    updatedAt: new Date().getTime(), 
                    id: `new_demo_${Math.random()}`, 
                    ownerUid: 'demo' 
                }));
                state.records = [...state.records, ...demoRecords];
                
                // 按放款日期排序並重新編號
                const userRecords = state.records.filter(r => r.ownerUid === 'demo');
                const sorted = userRecords.sort((a, b) => {
                    const dateA = new Date(a.date || '9999-12-31');
                    const dateB = new Date(b.date || '9999-12-31');
                    return dateA - dateB;
                });
                
                // 重新賦予編號
                sorted.forEach((record, index) => {
                    record.caseNumber = formatCaseId(index + 1);
                    record.displayId = formatCaseId(index + 1);
                });
                
                // 合併回所有記錄
                const otherRecords = state.records.filter(r => r.ownerUid !== 'demo');
                state.records = [...otherRecords, ...sorted];
                
                showLoading(false);
                window.showSuccess(`本地試用模式：成功匯入 ${records.length} 筆案件，編號已按日期重新排序。`);
                renderApp();
                return;
            }

            if (firebaseAvailable) {
                try {
                    const batch = writeBatch(db);
                    // FIX: Write to public collection to maintain admin visibility
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'loan_records');
                    
                    records.forEach((record) => {
                        const newDocRef = doc(colRef);
                        batch.set(newDocRef, record);
                    });

                    await batch.commit();
                    
                    // 重新排序並編號
                    const q = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'loan_records'),
                        where('ownerUid', '==', state.currentUserUid),
                        orderBy('date', 'asc')
                    );
                    const querySnapshot = await getDocs(q);
                    
                    const renumberBatch = writeBatch(db);
                    
                    querySnapshot.docs.forEach((docSnap, index) => {
                        const newCaseNumber = formatCaseId(index + 1);
                        renumberBatch.update(docSnap.ref, { 
                            caseNumber: newCaseNumber,
                            displayId: newCaseNumber
                        });
                    });
                    
                    await renumberBatch.commit();
                    
                    showLoading(false);
                    window.showSuccess(`成功匯入 ${records.length} 筆新案件，編號已按日期重新排序！`);
                } catch (e) {
                    showLoading(false);
                    console.error("Firebase 批次寫入失敗:", e);
                    window.showError(`資料庫寫入失敗: ${e.message}`);
                }
            }
        };

        // --- Helper: Generate Row HTML (分離的渲染邏輯) ---
        const generateRowsHtml = () => {
            let sourceRecords = state.records;
            if (state.isAdmin && state.viewingUid !== 'all') {
                sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
            } else if (!state.isAdmin && !state.isDemoMode) {
                sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
            }

            // 修改點4: 更新搜尋邏輯只搜尋借款人和編號
            const searchTerm = state.searchTerm.toLowerCase();
            let filtered = sourceRecords.filter(r => 
                (r.borrower?.toLowerCase().includes(searchTerm) || 
                 r.displayId?.toLowerCase().includes(searchTerm))
            );
            
            // 修改點6: 套用未繳篩選
            if (state.unpaidFilter === 'all_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid } = getPaymentStatus(r);
                    return r.status === '1' && !isPaid;
                });
            } else if (state.unpaidFilter === 'current_unpaid') {
                filtered = filtered.filter(r => {
                    const { isPaid } = getPaymentStatus(r);
                    return r.status === '1' && !isPaid;
                });
            }
            
            const currentRecords = filtered.slice((state.currentPage - 1) * state.itemsPerPage, state.currentPage * state.itemsPerPage);
            
            if (filtered.length === 0) {
                return `<tr><td colspan="${listFieldDefinitions.length}" class="p-8 text-center text-gray-400">目前無資料，請點擊新增案件</td></tr>`;
            }

            return currentRecords.map(r => {
                const { isPaid, isOverdue } = getPaymentStatus(r);
                const calc = calculateDerivedData(r);
                const statusLbl = getStatusLabel(r.status);
                const isBadDebt = r.status === '3';
                const isClosedBadDebt = r.status === '4';

                return `<tr class="hover:bg-gray-50 transition-colors">` + listFieldDefinitions.map((field, idx) => {
                    let content = '';
                    let val = r[field.key];
                    
                    if (field.key === 'caseNumber') {
                        val = r.displayId || r.caseNumber || ''; 
                    }

                    if (isBadDebt) {
                        if (field.key === 'loanAmount' || field.key === 'disbursed') val = 0;
                    }
                    if (isClosedBadDebt) {
                        if (field.key === 'principalPerTerm' || field.key === 'interestPerTerm') val = 0;
                    }

                    if (field.isComputed) {
                        if (field.key === 'paymentStatus') {
                            if (isBadDebt) {
                                content = `<div class="flex items-center justify-center p-2"><span class="text-gray-500 font-bold flex items-center text-xs bg-gray-100 px-2 py-1 rounded border border-gray-200 cursor-not-allowed" title="此案件已轉為呆帳"><i data-lucide="gavel" class="w-3 h-3 mr-1"></i>法務程序中</span></div>`;
                            } else {
                                content = `<div onclick="window.handlePaymentStatusClick('${r.id}')" class="flex items-center justify-center cursor-pointer p-2 rounded transition-colors ${isPaid ? 'hover:bg-emerald-200' : 'hover:bg-red-100'}" title="點擊前往還款頁面">${isPaid ? `<span class="text-emerald-600 font-bold flex items-center"><i data-lucide="check" class="w-3 h-3 mr-1"></i>已繳清</span>` : `<span class="font-bold flex items-center ${isOverdue ? 'text-red-700' : 'text-red-600'}">${isOverdue ? '<i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i>逾期未繳' : '未繳'}</span>`}</div>`;
                            }
                        } else if (field.key === 'remainingTerms') content = calc.remainingTerms;
                        else if (field.key === 'roiTerms') content = calc.roiTerms;
                        else if (field.key === 'arrears') content = `<span class="font-mono ${Number(calc.arrears)>0?'text-red-600 font-bold':''}">${formatNumber(calc.arrears)}</span>`;
                        else if (field.key === 'outstanding') content = `<span class="font-mono font-bold">${formatNumber(calc.outstanding)}</span>`;
                        
                        if (isClosedBadDebt && (field.key === 'arrears' || field.key === 'outstanding')) {
                            const inputVal = field.key === 'arrears' ? calc.arrears : calc.outstanding;
                            const isRed = field.key === 'arrears';
                            content = `<input type="number" value="${inputVal}" onchange="window.updateStatus4Amount('${r.id}', '${field.key}', this.value)" class="table-input w-24 p-1.5 border border-gray-300 rounded text-right font-mono text-xs ${isRed ? 'text-red-600 font-bold' : 'text-gray-700'}" onclick="event.stopPropagation()" title="可手動修改金額">`;
                        }

                    } else if (field.isAction) {
                        content = `<div class="flex space-x-2 justify-center items-center"><button onclick="window.openMessageModal('${r.id}')" class="text-purple-600 hover:text-purple-800 bg-purple-50 p-1 rounded" title="AI 催收"><i data-lucide="sparkles" class="w-4 h-4"></i></button><button onclick="window.startEdit('${r.id}')" class="text-blue-600 hover:text-blue-800 bg-blue-50 p-1 rounded" title="編輯"><i data-lucide="edit-2" class="w-4 h-4"></i></button><button onclick="window.handleDelete('${r.id}')" class="text-red-600 hover:text-red-800 bg-red-50 p-1 rounded" title="刪除整筆案件"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                    } else if (field.key === 'status') {
                        content = `<span class="px-2 py-1 rounded text-xs ${statusLbl.color}">${statusLbl.text}</span>`;
                    } else if (field.key === 'repaidTerms') {
                        content = `<div class="cursor-pointer text-blue-600 font-bold hover:underline flex items-center justify-center" onclick="window.openModal('schedule', '${r.id}')" title="點擊查看還款日程">${parseSchedule(r.schedule).length} <i data-lucide="calendar-days" class="w-3 h-3 ml-1"></i></div>`;
                    } else if (field.isEditable) {
                        const icon = field.key === 'note' ? 'file-pen-line' : 'calendar-days';
                        content = `<button onclick="window.openModal('${field.key}', '${r.id}')" class="flex items-center justify-center text-gray-500 hover:text-blue-600 bg-gray-100 hover:bg-blue-50 px-3 py-1 rounded-md text-xs transition-colors mx-auto"><i data-lucide="${icon}" class="w-3 h-3 mr-1"></i>檢視/編輯</button>`;
                    } else {
                        if (val === undefined || val === null) val = '-';
                        if (field.key === 'totalInterestIncome') val = calc.totalInterestPaid;
                        content = `<span class="${field.isCurrency ? 'font-mono' : ''} ${field.isDanger && Number(val) > 0 ? 'text-red-600 font-bold' : 'text-gray-700'}">${field.isCurrency ? '$' : ''}${formatNumber(val)}</span>`;
                    }
                    
                    let stickyClass = '';
                    let style = `min-width: ${field.widthVal}px; max-width: ${field.widthVal}px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;`;
                    
                    if (idx <= 4) { 
                        stickyClass = `sticky z-20 bg-white border-r border-gray-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]`;
                        style += ` left: ${listStickyOffsets[idx]}px;`;
                    } else {
                        style += ` border-r border-gray-100;`;
                    }
                    if (field.key === 'paymentStatus' && isOverdue && !isBadDebt) stickyClass = stickyClass.replace('bg-white', 'bg-emerald-100');

                    return `<td class="py-2 px-2 text-xs text-center ${field.font || ''} ${stickyClass}" style="${style}" title="${val||''}">${content}</td>`;
                }).join('') + `</tr>`;
            }).join('');
        };

        window.refreshListUI = () => {
            const tbody = document.getElementById('loanListBody');
            const paginationInfo = document.getElementById('paginationInfo');
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            const btnFirst = document.getElementById('btnFirst');
            const btnLast = document.getElementById('btnLast');
            const pageInput = document.getElementById('pageInput');
            const pageGoBtn = document.getElementById('pageGoBtn');

            if (tbody) {
                tbody.innerHTML = generateRowsHtml();
                lucide.createIcons();
            }

            if (paginationInfo && btnPrev && btnNext && btnFirst && btnLast && pageInput) {
                let sourceRecords = state.records;
                if (state.isAdmin && state.viewingUid !== 'all') {
                    sourceRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
                } else if (!state.isAdmin && !state.isDemoMode) {
                    sourceRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
                }
                
                // 使用新的搜尋邏輯
                const searchTerm = state.searchTerm.toLowerCase();
                let filtered = sourceRecords.filter(r => 
                    (r.borrower?.toLowerCase().includes(searchTerm) || 
                     r.displayId?.toLowerCase().includes(searchTerm))
                );
                
                // 套用未繳篩選
                if (state.unpaidFilter === 'all_unpaid') {
                    filtered = filtered.filter(r => {
                        const { isPaid } = getPaymentStatus(r);
                        return r.status === '1' && !isPaid;
                    });
                } else if (state.unpaidFilter === 'current_unpaid') {
                    filtered = filtered.filter(r => {
                        const { isPaid } = getPaymentStatus(r);
                        return r.status === '1' && !isPaid;
                    });
                }
                
                const totalPages = Math.ceil(filtered.length / state.itemsPerPage) || 1;
                
                paginationInfo.textContent = `第 ${state.currentPage} 頁 / 共 ${totalPages} 頁 (共 ${filtered.length} 筆)`;
                btnFirst.disabled = state.currentPage === 1;
                btnPrev.disabled = state.currentPage === 1;
                btnNext.disabled = state.currentPage >= totalPages || filtered.length === 0;
                btnLast.disabled = state.currentPage >= totalPages || filtered.length === 0;
                
                // 更新頁碼輸入框
                pageInput.value = state.currentPage;
                pageInput.max = totalPages;
                pageInput.min = 1;
            }
        };

        // Render Functions
        function renderAuth() { return `<div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-4 font-sans"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in p-8"><div class="text-center mb-8"><div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 mb-4"><i data-lucide="wallet" class="w-8 h-8 text-blue-600"></i></div><h2 class="text-2xl font-bold text-gray-800">${state.isRegistering ? "註冊新帳號" : "登入財務系統"}</h2><p class="text-xs text-gray-500 mt-2">${state.isRegistering ? "設定您的專屬帳號ID與綁定Email" : "使用您的帳號ID登入"}</p></div><form onsubmit="window.handleAuth(event)" class="space-y-6"><div><label class="block text-sm font-medium text-gray-700 mb-1">帳號 (ID)</label><div class="relative"><span class="absolute left-3 top-3 text-gray-400"><i data-lucide="user" class="w-5 h-5"></i></span><input type="text" id="authUsername" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="請輸入帳號" required></div></div>${state.isRegistering ? `<div><label class="block text-sm font-medium text-gray-700 mb-1">綁定 Email</label><div class="relative"><span class="absolute left-3 top-3 text-gray-400"><i data-lucide="at-sign" class="w-5 h-5"></i></span><input type="email" id="authEmail" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="name@example.com" required></div></div>` : ''}<div><label class="block text-sm font-medium text-gray-700 mb-1">密碼</label><div class="relative"><span class="absolute left-3 top-3 text-gray-400"><i data-lucide="lock" class="w-5 h-5"></i></span><input type="password" id="authPassword" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="????????" required></div></div>${state.isRegistering ? `<div><label class="block text-sm font-medium text-gray-700 mb-1">確認密碼</label><div class="relative"><span class="absolute left-3 top-3 text-gray-400"><i data-lucide="lock" class="w-5 h-5"></i></span><input type="password" id="authConfirmPassword" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="再次輸入密碼" required></div></div>` : ''}<button type="submit" ${state.authLoading ? 'disabled' : ''} class="w-full text-white ${state.isRegistering ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-blue-600 hover:bg-blue-700'} py-3 rounded-lg font-bold transition-all shadow-md flex justify-center items-center disabled:opacity-50">${state.authLoading ? '<i data-lucide="refresh-cw" class="w-5 h-5 mr-2 animate-spin"></i>' : (state.isRegistering ? '<i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> 立即註冊' : '<i data-lucide="log-in" class="w-5 h-5 mr-2"></i> 登入系統')}</button></form><div class="mt-6 text-center text-sm space-y-4"><div><span class="text-gray-500">${state.isRegistering ? "已經有帳號了嗎？" : "還沒有帳號嗎？"}</span><button onclick="window.toggleAuthMode()" class="ml-2 text-blue-600 hover:text-blue-800 font-bold hover:underline focus:outline-none">${state.isRegistering ? "直接登入" : "註冊新帳號"}</button></div><div class="pt-2 border-t border-gray-100"><button onclick="window.enterDemoMode()" class="text-gray-400 hover:text-gray-600 text-xs flex items-center justify-center w-full hover:underline"><i data-lucide="log-in" class="w-3 h-3 mr-1"></i> 先行試用 (免登入/不儲存資料)</button></div></div></div></div>`; }

        function renderDashboard(stats) {
            const cardsHtml = state.cardLayout.filter(c => c.id !== 'totalManagementFee' || stats.hasManagedCases).map(c => {
                const config = getCardConfig(c.id); 
                if(!config) return '';
                const s = { bg: "bg-white", border: "border-gray-200", text: "text-gray-900", iconBg: "bg-gray-100", iconColor: "text-gray-600" };
                switch (config.type) {
                    case 'primary': Object.assign(s, { bg: "bg-emerald-100", border: "border-emerald-300", text: "text-emerald-900", iconBg: "bg-emerald-200", iconColor: "text-emerald-700" }); break;
                    case 'danger': Object.assign(s, { bg: "bg-rose-50", border: "border-rose-200", text: "text-rose-900", iconBg: "bg-rose-100", iconColor: "text-rose-600" }); break;
                    case 'warning': Object.assign(s, { bg: "bg-amber-50", border: "border-amber-200", text: "text-amber-900", iconBg: "bg-amber-100", iconColor: "text-amber-600" }); break;
                    case 'critical': Object.assign(s, { bg: "bg-red-200", border: "border-red-300", text: "text-red-900", iconBg: "bg-red-300", iconColor: "text-red-700" }); break;
                }
                const colSpan = c.width === 2 ? 'lg:col-span-2' : 'lg:col-span-1';
                return `<div class="${s.bg} ${colSpan} border ${s.border} rounded-xl p-3 shadow-sm relative overflow-hidden flex flex-col justify-between h-full draggable-card hover:shadow-md transition-transform hover:scale-[1.01]" draggable="true" ondragstart="window.handleDragStart(event, '${c.id}')" ondragover="window.handleDragOver(event)" ondrop="window.handleDrop(event, '${c.id}')" onclick="window.openModalList('${c.id}')">
                    <div class="flex justify-between items-start z-10">
                        <span class="text-base font-bold text-gray-700">${config.label}</span>
                        <div class="flex items-center space-x-1">
                            <button onclick="window.resizeCard(event, '${c.id}')" class="p-1 hover:bg-black/10 rounded" title="調整大小"><i data-lucide="${c.width===1?'maximize-2':'minimize-2'}" class="w-3 h-3 opacity-50"></i></button>
                            <div class="p-1.5 rounded-lg ${s.iconBg}"><i data-lucide="${config.icon}" class="w-4 h-4 ${s.iconColor}"></i></div>
                        </div>
                    </div>
                    <div class="mt-1 z-10"><span class="text-2xl sm:text-3xl font-extrabold tracking-tight ${s.text}">${config.isCurrency ? '<span class="text-lg mr-1">$</span>' : ''}${formatNumber(config.value)}${!config.isCurrency ? '<span class="text-lg ml-1">人</span>' : ''}</span></div>
                </div>`;
            }).join('');

            return `<div class="animate-fade-in space-y-6"><header class="flex justify-between items-center mb-6"><div><h2 class="text-2xl font-bold text-gray-800">財務營運儀表板</h2></div>
            ${state.isAdmin ? `<div class="flex items-center space-x-2 bg-white p-1 rounded-lg border border-gray-200 shadow-sm"><span class="text-xs font-bold text-gray-500 px-2">檢視對象:</span><select onchange="window.updateState({viewingUid: this.value})" class="text-sm border-none bg-transparent outline-none font-bold text-blue-600"><option value="all">全部用戶</option>${state.usersDirectory.map(u => `<option value="${u.uid}" ${state.viewingUid === u.uid ? 'selected' : ''}>${u.username}</option>`).join('')}</select></div>` : ''}
            </header><div class="grid grid-cols-1 lg:grid-cols-4 gap-3"><div class="lg:col-span-3 grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-3">${cardsHtml}</div><div class="flex flex-col gap-3"><div class="bg-gradient-to-br from-teal-600 to-cyan-700 rounded-xl p-4 shadow-lg border border-transparent flex flex-col justify-center relative overflow-hidden flex-1 min-h-[300px]"><div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-xl"></div><div class="absolute bottom-0 left-0 w-24 h-24 bg-black/10 rounded-full -ml-10 -mb-10 blur-xl"></div><div class="flex items-center mb-4 relative z-10 border-b border-white/20 pb-2"><i data-lucide="database" class="w-6 h-6 text-white mr-2"></i><h3 class="font-bold text-white text-xl tracking-wide">系統案件狀態</h3></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 relative z-10 flex-1"><div onclick="window.openModalList('active')" class="bg-emerald-100 backdrop-blur-sm p-3 rounded-xl text-center cursor-pointer hover:bg-emerald-200 transition-all border border-emerald-300 group flex flex-col justify-center"><span class="block text-4xl font-extrabold text-emerald-800 mb-1 group-hover:scale-110 transition-transform">${formatNumber(stats.activeCases)}</span><span class="text-base text-emerald-700 font-bold uppercase tracking-wider">進行中</span></div><div onclick="window.openModalList('unpaid')" class="bg-red-200 p-3 rounded-xl text-center cursor-pointer hover:bg-red-300 transition-all shadow-md group flex flex-col justify-center"><span class="block text-4xl font-extrabold text-red-800 mb-1 group-hover:scale-110 transition-transform">${formatNumber(stats.unpaidCount)}</span><span class="text-lg text-red-700 font-bold uppercase tracking-wider flex items-center justify-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1 animate-pulse"></i>本期逾期</span></div><div onclick="window.openModalList('closed')" class="bg-gray-200 p-3 rounded-xl text-center cursor-pointer hover:bg-gray-300 transition-all border border-gray-300 flex flex-col justify-center"><span class="block text-4xl font-bold text-gray-800 mb-1">${formatNumber(stats.normalClosedCount)}</span><span class="text-lg text-gray-600 font-bold uppercase tracking-wider">結案</span></div><div onclick="window.openModalList('badDebt')" class="bg-pink-300 p-3 rounded-xl text-center cursor-pointer hover:bg-pink-400 transition-all shadow-md group flex flex-col justify-center"><span class="block text-4xl font-extrabold text-pink-900 mb-1 group-hover:scale-110 transition-transform">${formatNumber(stats.activeBadDebtCount + stats.closedBadDebtCount)}</span><span class="text-lg text-pink-800 font-bold uppercase tracking-wider">呆帳</span></div></div></div><div class="h-40 cursor-pointer" onclick="window.openAIAdvisor()"><div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-xl p-6 text-white shadow-lg relative overflow-hidden h-full flex flex-col items-center justify-center hover:shadow-xl hover:scale-[1.02] transition-all group"><div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-10 -mt-10 blur-xl group-hover:bg-white/20 transition-all"></div><div class="relative z-10 flex flex-col items-center justify-center"><i data-lucide="sparkles" class="w-8 h-8 mb-2 text-yellow-300 animate-pulse"></i><h3 class="text-lg font-bold text-center">AI 財務顧問</h3><span class="text-xs opacity-80 mt-1 group-hover:opacity-100 transition-opacity">點擊開啟診斷報告</span></div></div></div></div></div></div>`; 
        }

        function renderList() {
            // Generate header separately
            const headerHtml = listFieldDefinitions.map((field, idx) => {
                let stickyClass = '';
                let style = `min-width: ${field.widthVal}px; width: ${field.widthVal}px;`;
                
                if (idx <= 4) {
                    stickyClass = `sticky z-40 bg-gray-50 border-r border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]`;
                    style += ` left: ${listStickyOffsets[idx]}px;`;
                } else {
                    stickyClass = `sticky top-0 z-30 bg-gray-50 border-r border-gray-300`;
                }
                
                return `<th class="p-2 font-semibold text-gray-700 text-sm whitespace-nowrap text-center ${stickyClass}" style="${style}">${field.label}</th>`;
            }).join('');

            return `
            <div class="flex flex-col h-[calc(100vh-6rem)] animate-fade-in space-y-4">
                <header class="flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0 bg-slate-100 pt-2 pb-2 z-10">
                    <h2 class="text-2xl font-bold text-gray-800">案件資料列表</h2>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center w-full sm:w-auto">
                        <!-- 修改點7: 新增未繳案件篩選按鈕 -->
                        <div class="flex space-x-2 w-full sm:w-auto">
                            <button onclick="window.filterUnpaidCases('all_unpaid')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center shadow-sm ${state.unpaidFilter === 'all_unpaid' ? 'ring-2 ring-red-300' : ''}">
                                <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i>顯示所有未繳
                            </button>
                            <button onclick="window.filterUnpaidCases('current_unpaid')" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 flex items-center shadow-sm ${state.unpaidFilter === 'current_unpaid' ? 'ring-2 ring-amber-300' : ''}">
                                <i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i>本期未繳
                            </button>
                            ${state.unpaidFilter ? `<button onclick="window.clearUnpaidFilter()" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 flex items-center shadow-sm">
                                <i data-lucide="x" class="w-4 h-4 mr-2"></i>清除篩選
                            </button>` : ''}
                        </div>
                        
                        <div class="flex space-x-2 items-center w-full sm:w-auto">
                            <div class="relative flex-1 sm:w-64"><i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i><input type="text" id="searchInput" placeholder="搜尋編號、姓名..." value="${state.searchTerm}" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" oninput="window.handleSearch(this.value)"></div>
                            
                            <!-- NEW: CSV Import Button and Hidden Input -->
                            <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="window.handleFileChange(event)" />
                            <button onclick="window.handleFileSelect()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center shadow-sm disabled:opacity-50" ${state.isImporting ? 'disabled' : ''} title="匯入垂直格式報表">
                                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>匯入 CSV
                            </button>
                            
                            <!-- NEW: Excel Export Button -->
                            <button onclick="window.exportToExcel()" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 flex items-center shadow-sm whitespace-nowrap" title="匯出垂直格式報表（與匯入格式相同）">
                                <i data-lucide="download" class="w-4 h-4 mr-2"></i>匯出垂直 CSV
                            </button>

                            <button onclick="window.openNewForm()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 flex items-center shadow-sm"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>新增</button>
                        </div>
                    </div>
                </header>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex-1 flex flex-col overflow-hidden relative">
                    <div class="flex-1 overflow-auto relative custom-scrollbar">
                        <table class="text-left border-collapse w-max">
                            <thead>
                                <tr class="bg-gray-50 border-b border-gray-200">
                                    ${headerHtml}
                                </tr>
                            </thead>
                            <tbody id="loanListBody" class="divide-y divide-gray-100 text-sm">
                                <!-- Rows will be injected here by refreshListUI() -->
                            </tbody>
                        </table>
                    </div>
                    <!-- 修改點8: 改進分頁控件 -->
                    <div class="p-4 border-t border-gray-100 bg-gray-50 flex flex-col sm:flex-row justify-between items-center">
                        <div class="text-sm text-gray-500 mb-2 sm:mb-0">
                            ${state.unpaidFilter ? `<span class="font-bold ${state.unpaidFilter === 'all_unpaid' ? 'text-red-600' : 'text-amber-600'}"><i data-lucide="filter" class="w-3 h-3 inline mr-1"></i>${state.unpaidFilter === 'all_unpaid' ? '所有未繳案件' : '本期未繳案件'}</span>` : '全部案件'}
                        </div>
                        <div class="flex items-center space-x-1">
                            <button id="btnFirst" onclick="window.goToFirstPage()" class="p-2 rounded hover:bg-gray-200 disabled:opacity-30 transition-colors" title="最前頁"><i data-lucide="chevrons-left" class="w-5 h-5 text-gray-600"></i></button>
                            <button id="btnPrev" onclick="window.changePage(-1)" class="p-2 rounded hover:bg-gray-200 disabled:opacity-30 transition-colors" title="上一頁"><i data-lucide="chevron-left" class="w-5 h-5 text-gray-600"></i></button>
                            <span id="paginationInfo" class="text-sm text-gray-500 mx-2"></span>
                            <input type="number" id="pageInput" class="w-16 text-center border border-gray-300 rounded p-1 text-sm" min="1" />
                            <button id="pageGoBtn" onclick="window.goToPage(document.getElementById('pageInput').value)" class="p-2 rounded hover:bg-gray-200 transition-colors text-sm" title="跳轉到指定頁碼">跳轉</button>
                            <button id="btnNext" onclick="window.changePage(1)" class="p-2 rounded hover:bg-gray-200 disabled:opacity-30 transition-colors" title="下一頁"><i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i></button>
                            <button id="btnLast" onclick="window.goToLastPage()" class="p-2 rounded hover:bg-gray-200 disabled:opacity-30 transition-colors" title="最末頁"><i data-lucide="chevrons-right" class="w-5 h-5 text-gray-600"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderUserManagement() {
             // FIXED: Only pass UID to toggleUserStatus2Permission to avoid string escaping issues in HTML attribute
             return `<div class="max-w-4xl mx-auto animate-fade-in"><header class="mb-6"><h2 class="text-2xl font-bold text-gray-800">用戶權限管理</h2><p class="text-sm text-gray-500">僅管理員可見，設定誰可以使用「代管」功能。</p></header><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-50 text-gray-500 text-xs uppercase"><tr><th class="p-4">用戶名稱</th><th class="p-4">Email</th><th class="p-4 text-center">角色</th><th class="p-4 text-center">允許代管 (Status 2)</th></tr></thead><tbody class="divide-y divide-gray-100">${state.usersDirectory.map(u => { const allowStatus2 = u.allowedStatus && u.allowedStatus.includes('2'); return `<tr><td class="p-4 font-bold text-gray-800">${u.username}</td><td class="p-4 text-sm text-gray-600">${u.email}</td><td class="p-4 text-center"><span class="px-2 py-1 rounded-full text-xs font-bold ${u.role==='admin'?'bg-purple-100 text-purple-700':'bg-gray-100 text-gray-600'}">${u.role==='admin'?'管理員':'一般用戶'}</span></td><td class="p-4 text-center"><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="window.toggleUserStatus2Permission('${u.uid}')" ${allowStatus2 ? 'checked' : ''}><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></td></tr>`; }).join('')}</tbody></table></div></div>`;
        }

        function renderForm() { 
             const isEdit = !!state.editingRecord; const calc = calculateDerivedData(formData);
             const canUseStatus2 = state.allowedStatus.includes('2');

             return `<div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden animate-fade-in flex flex-col h-[calc(100vh-6rem)]"><div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center bg-gray-50 shrink-0"><h3 class="font-bold text-gray-800 flex items-center"><i data-lucide="${isEdit ? 'edit-2' : 'plus'}" class="w-4 h-4 mr-2"></i> ${isEdit ? '編輯案件' : '新增案件'}</h3><button onclick="window.setActiveTab('list')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button></div>
             <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 text-sm flex-1 overflow-y-auto custom-scrollbar">
                 <div class="lg:col-span-4 bg-gray-50 p-3 rounded-lg border border-gray-200"><h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 border-b border-gray-200 pb-1">基本與聯絡資料</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-3"><div><label class="block text-[10px] text-gray-500 mb-0.5">借款人</label><input type="text" id="input_borrower" value="${formData.borrower}" oninput="window.updateFormData('borrower', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">身分證字號</label><input type="text" id="input_idNumber" value="${formData.idNumber}" oninput="window.updateFormData('idNumber', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">工作</label><input type="text" id="input_job" value="${formData.job}" oninput="window.updateFormData('job', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">經辦人</label><input type="text" id="input_agent" value="${formData.agent}" oninput="window.updateFormData('agent', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div class="md:col-span-2"><label class="block text-[10px] text-gray-500 mb-0.5">住址</label><input type="text" id="input_address" value="${formData.address}" oninput="window.updateFormData('address', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">電話</label><input type="text" id="input_telephone" value="${formData.telephone}" oninput="window.updateFormData('telephone', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">手機</label><input type="text" id="input_mobile" value="${formData.mobile}" oninput="window.updateFormData('mobile', this.value)" class="w-full py-1 px-2 border rounded focus:ring-1 focus:ring-emerald-500 outline-none text-sm" /></div></div></div>
                 <div class="lg:col-span-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"><div class="lg:col-span-2 bg-blue-50 p-3 rounded-lg border border-blue-100"><h4 class="text-xs font-bold text-blue-800 uppercase tracking-wider mb-2 border-b border-blue-200 pb-1">貸款設定</h4><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] text-gray-500 mb-0.5">狀態</label><select onchange="window.updateFormData('status', this.value, true)" class="w-full py-1 px-2 border rounded outline-none bg-white text-sm"><option value="1" ${formData.status=='1'?'selected':''}>1 - 進行中</option>${canUseStatus2 ? `<option value="2" ${formData.status=='2'?'selected':''}>2 - 代管案件</option>` : ''}<option value="3" ${formData.status=='3'?'selected':''}>3 - 呆帳</option><option value="0" ${formData.status=='0'?'selected':''}>0 - 已結案</option><option value="4" ${formData.status=='4'?'selected':''}>4 - 已結案呆帳</option></select></div><div><label class="block text-[10px] text-gray-500 mb-0.5">方式</label><select onchange="window.updateFormData('method', this.value, true)" class="w-full py-1 px-2 border rounded outline-none bg-white text-sm"><option value="叨簿子" ${formData.method=='叨簿子'?'selected':''}>叨簿子</option><option value="設定" ${formData.method=='設定'?'selected':''}>設定</option><option value="票貼" ${formData.method=='票貼'?'selected':''}>票貼</option><option value="小額" ${formData.method=='小額'?'selected':''}>小額</option></select></div><div><label class="block text-[10px] text-gray-500 mb-0.5">借款金額(債權)</label><input type="number" id="input_loanAmount" value="${formData.loanAmount}" oninput="window.updateFormData('loanAmount', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">放款金額(實際)</label><input type="number" id="input_disbursed" value="${formData.disbursed}" oninput="window.updateFormData('disbursed', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">放款日期</label><input type="date" id="input_date" value="${formData.date}" oninput="window.updateFormData('date', this.value)" class="w-full py-1 px-2 border rounded outline-none text-sm" /></div></div></div><div class="lg:col-span-2 bg-emerald-50 p-3 rounded-lg border border-emerald-100"><h4 class="text-xs font-bold text-emerald-800 uppercase tracking-wider mb-2 border-b border-emerald-200 pb-1">還款條件</h4><div class="grid grid-cols-3 gap-3"><div><label class="block text-[10px] text-gray-500 mb-0.5">期數</label><input type="number" id="input_terms" value="${formData.terms}" oninput="window.updateFormData('terms', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">利率(%)</label><input type="text" id="input_interestRate" value="${formData.interestRate}" oninput="window.updateFormData('interestRate', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">每期還款日</label><input type="text" id="input_repayDay" value="${formData.repayDay}" oninput="window.updateFormData('repayDay', this.value)" class="w-full py-1 px-2 border rounded outline-none text-sm" /></div>${formData.status === '2' ? `<div class="col-span-3 border-t border-emerald-200 my-1"></div><div><label class="block text-[10px] text-blue-600 mb-0.5">借款利率 (%)</label><input type="text" id="input_specialRate" value="${formData.specialRate}" oninput="window.updateFormData('specialRate', this.value)" class="w-full py-1 px-2 border border-blue-300 rounded font-mono bg-white text-sm" placeholder="例如: 0.5"></div><div class="col-span-2"><label class="block text-[10px] text-blue-600 mb-0.5">預期應付 (本+借息-利息)</label><input type="text" id="input_expectedPayment" value="${formatNumber(Math.round((Number(formData.loanAmount)/Number(formData.terms)||0) + (Number(formData.loanAmount)*(Number(formData.specialRate)/100||0)) - (Number(formData.loanAmount)*(Number(formData.interestRate)/100||0))))}" readonly class="w-full py-1 px-2 border border-blue-300 rounded font-mono bg-blue-50 text-blue-800 text-sm" /></div>` : ''}<div class="col-span-3 grid grid-cols-2 gap-3 mt-1"><div><label class="block text-[10px] text-gray-500 mb-0.5 font-bold">每期本金 (合約)</label><input type="number" id="input_principalPerTerm" value="${formData.principalPerTerm}" oninput="window.updateFormData('principalPerTerm', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono bg-gray-100 text-sm" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5 font-bold">每期利息 (合約)</label><input type="number" id="input_interestPerTerm" value="${formData.interestPerTerm}" oninput="window.updateFormData('interestPerTerm', this.value)" class="w-full py-1 px-2 border rounded outline-none font-mono bg-gray-100 text-sm" /></div></div> 
                 ${isEdit ? `<div class="col-span-3 border-t border-orange-200 my-1 pt-1"><h4 class="text-[10px] font-bold text-orange-600 uppercase tracking-wider mb-1">本期調整 (當月實收)</h4><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] text-gray-500 mb-0.5">本期本金</label><input type="number" id="input_currentPrincipal" value="${formData.currentPrincipal !== undefined ? formData.currentPrincipal : formData.principalPerTerm}" oninput="window.updateFormData('currentPrincipal', this.value)" class="w-full py-1 px-2 border border-orange-300 rounded outline-none font-mono bg-orange-50 text-sm text-gray-700 font-bold" /></div><div><label class="block text-[10px] text-gray-500 mb-0.5">本期利息</label><input type="number" id="input_currentInterest" value="${formData.currentInterest !== undefined ? formData.currentInterest : formData.interestPerTerm}" oninput="window.updateFormData('currentInterest', this.value)" class="w-full py-1 px-2 border border-orange-300 rounded outline-none font-mono bg-orange-50 text-sm text-gray-700 font-bold" /></div></div></div>` : ''}</div></div><div class="lg:col-span-4"><label class="block text-[10px] text-gray-500 mb-0.5">附註</label><textarea rows="2" id="input_note" oninput="window.updateFormData('note', this.value)" class="w-full py-1 px-2 border rounded outline-none text-sm resize-none">${formData.note}</textarea></div>
                 ${isEdit ? `
                     <div class="lg:col-span-4 bg-yellow-50 p-2 rounded border border-yellow-200 grid grid-cols-4 gap-2">
                         <div>
                             <label class="block text-[10px] text-gray-500">欠款</label>
                             <span id="display_arrears" class="font-mono font-bold text-red-600">${formatNumber(calc.arrears)}</span>
                         </div>
                         <div>
                             <label class="block text-[10px] text-gray-500">在外本金</label>
                             <span id="display_outstanding" class="font-mono font-bold">${formatNumber(calc.outstanding)}</span>
                         </div>
                         <div class="col-span-2 flex justify-end">
                             <button onclick="window.handleDelete('${state.editingRecord.id}')" class="px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs font-bold flex items-center"><i data-lucide="trash-2" class="w-3 h-3 mr-1"></i>刪除案件</button>
                         </div>
                     </div>` : ''}
             </div>
             <div class="bg-white px-6 py-4 flex justify-end items-center gap-6 border-t border-gray-100 shrink-0 mt-auto">
                 <button onclick="window.setActiveTab('list')" class="text-gray-500 hover:text-gray-800 text-sm font-medium transition-colors">取消</button>
                 <button onclick="window.handleSaveForm()" class="px-6 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 shadow-sm flex items-center font-bold text-sm transition-transform active:scale-95"><i data-lucide="save" class="w-4 h-4 mr-2"></i>儲存資料</button>
             </div>
             </div>`; 
        }

        function renderRepayment() { 
            const repaymentCases = state.records.filter(r => (r.status === '1' || r.status === '2')); const isSearching = !!state.repaymentSearchTerm; const dropdownDisplayClass = isSearching ? '' : 'hidden'; const dropdownHtml = `<div id="repaymentDropdownContainer" class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-xl max-h-60 overflow-y-auto ${dropdownDisplayClass}"></div>`; const selectedCase = state.selectedRepaymentId ? state.records.find(r => r.id === state.selectedRepaymentId) : null; return `<div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden animate-fade-in mt-8"><div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 text-white flex justify-between items-center"><div><h2 class="text-xl font-bold flex items-center"><i data-lucide="banknote" class="w-6 h-6 mr-2"></i> 還款入帳作業</h2><p class="text-blue-100 text-sm mt-1">選取案件連結後，輸入每期還款資訊</p></div><button onclick="window.setActiveTab('list')" class="px-4 py-2 bg-white/20 text-white rounded-lg hover:bg-white/30 transition-colors flex items-center text-sm font-medium"><i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>回上一頁</button></div><div class="p-8 space-y-6"><div class="space-y-2 relative"><label class="text-sm font-bold text-gray-600 flex items-center"><i data-lucide="search" class="w-4 h-4 mr-1"></i> 選擇案件 (僅顯示進行中/代管)</label><div class="relative"><input type="text" placeholder="輸入編號或姓名搜尋..." value="${state.repaymentSearchTerm}" oninput="window.updateRepaymentSearch(this.value)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none pl-10"/><i data-lucide="search" class="absolute left-3 top-3.5 text-gray-400 w-4 h-4"></i></div>${dropdownHtml}<select id="repaymentSelect" onchange="window.handleRepaymentSelect(this.value)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white mt-2" ${isSearching ? 'hidden' : ''}><option value="">-- 請選擇案件 --</option>${repaymentCases.map(r => `<option value="${r.id}" ${state.selectedRepaymentId === r.id ? 'selected' : ''}>${r.displayId || r.caseNumber || ''} - ${r.borrower || ''} (每期應繳: $${formatNumber((Number(r.principalPerTerm)||0) + (Number(r.interestPerTerm)||0))})</option>`).join('')}</select>${selectedCase ? `<div class="mt-2 flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-100"><span class="text-sm text-blue-800 font-medium">當前連結案件：${selectedCase.displayId || selectedCase.caseNumber || ''} ${selectedCase.borrower}</span><button onclick="window.resetRepaymentSelection()" class="text-xs text-blue-500 hover:text-blue-700 underline">重新選擇</button></div>` : ''}</div><div class="bg-gray-50 rounded-xl p-6 border border-gray-200 space-y-4"><div class="flex justify-between items-center border-b border-gray-200 pb-2 mb-4"><h3 class="font-bold text-gray-700 flex items-center"><i data-lucide="edit-2" class="w-4 h-4 mr-2"></i> 入帳資訊</h3>${selectedCase ? `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold flex items-center"><i data-lucide="check" class="w-3 h-3 mr-1"></i> 已連結</span>` : `<span class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-xs font-bold flex items-center"><i data-lucide="link" class="w-3 h-3 mr-1"></i> 未連結案件</span>`}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 mb-1">還款日期 (入帳日)</label><input type="date" value="${state.repaymentDate}" oninput="window.updateRepaymentInput('repaymentDate', this.value)" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white"/></div><div class="hidden md:block"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">還款本金</label><div class="relative"><span class="absolute left-3 top-2.5 text-gray-400">$</span><input type="number" value="${state.repaymentPrincipal}" oninput="window.updateRepaymentInput('repaymentPrincipal', this.value)" placeholder="0" class="w-full p-2 pl-7 border rounded focus:ring-2 focus:ring-blue-500 outline-none font-mono text-lg bg-white" ${selectedCase?.status === '2' ? 'disabled bg-gray-200' : ''}/></div></div><div><label class="block text-xs font-bold text-gray-500 mb-1">還款利息</label><div class="relative"><span class="absolute left-3 top-2.5 text-gray-400">$</span><input type="number" value="${state.repaymentInterest}" oninput="window.updateRepaymentInput('repaymentInterest', this.value)" placeholder="0" class="w-full p-2 pl-7 border rounded focus:ring-2 focus:ring-blue-500 outline-none font-mono text-lg bg-white"/></div></div></div></div><div class="pt-4 flex justify-end border-t border-gray-100 mt-6"><button onclick="window.submitRepayment()" ${!selectedCase ? 'disabled' : ''} class="px-6 py-3 rounded-lg shadow-md flex items-center font-bold text-lg transition-all ${selectedCase ? 'bg-blue-600 text-white hover:bg-blue-700 transform active:scale-95' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"><i data-lucide="save" class="w-5 h-5 mr-2"></i> 確認入帳</button></div></div></div>`; 
        }

        function renderApp() { 
            const app = document.getElementById('app');
            if (!state.currentUser && !state.isDemoMode) {
                app.innerHTML = renderAuth();
            } else {
                const stats = calculateStats();
                let content = '';
                if (state.activeTab === 'dashboard') content = renderDashboard(stats);
                else if (state.activeTab === 'list') content = renderList();
                else if (state.activeTab === 'form') content = renderForm();
                else if (state.activeTab === 'repayment') content = renderRepayment();
                else if (state.activeTab === 'admin') content = renderUserManagement();

                // Modals...
                let modalHtml = '';
                // ... (Keep existing modals: AI, Message, Edit Schedule, Card Details) ...
                if (state.showAIModal) modalHtml += `<div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 animate-fade-in backdrop-blur-sm"><div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh]"><div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 flex justify-between items-center text-white shrink-0"><h3 class="font-bold flex items-center text-lg"><i data-lucide="sparkles" class="w-5 h-5 mr-2 text-yellow-300"></i> AI 財務診斷報告</h3><button onclick="window.updateState({showAIModal: false})" class="hover:bg-white/20 p-1 rounded transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 overflow-y-auto custom-scrollbar">${state.aiLoading ? `<div class="flex flex-col items-center justify-center py-12 space-y-4"><div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div><p class="text-gray-500 animate-pulse font-medium">AI 正在分析...</p></div>` : `<div class="prose prose-sm prose-indigo max-w-none"><div class="whitespace-pre-wrap text-gray-700 leading-relaxed text-base">${state.aiReport}</div></div>`}</div></div></div>`;
                if (state.messageModalRecord) modalHtml += `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in backdrop-blur-sm"><div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden"><div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-4 flex justify-between items-center text-white"><h3 class="font-bold flex items-center"><i data-lucide="message-square" class="w-5 h-5 mr-2"></i> AI 智慧催收助理</h3><button onclick="window.updateState({messageModalRecord: null})" class="hover:bg-white/20 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-5"><div class="flex space-x-2 mb-4"><button onclick="window.generateMessage('polite')" class="flex-1 py-2 text-xs font-medium rounded-lg bg-gray-100 hover:bg-emerald-100 text-gray-600">委婉提醒</button><button onclick="window.generateMessage('firm')" class="flex-1 py-2 text-xs font-medium rounded-lg bg-gray-100 hover:bg-emerald-100 text-gray-600">堅定催收</button><button onclick="window.generateMessage('legal')" class="flex-1 py-2 text-xs font-medium rounded-lg bg-gray-100 hover:bg-emerald-100 text-gray-600">嚴重警告</button></div><div class="bg-gray-50 border border-gray-200 rounded-lg p-4 min-h-[150px] relative">${state.aiLoading ? `<div class="absolute inset-0 flex items-center justify-center"><i data-lucide="sparkles" class="w-8 h-8 animate-pulse text-emerald-400"></i></div>` : `<textarea class="w-full h-full bg-transparent border-none outline-none resize-none text-gray-700 text-sm leading-relaxed" rows="8">${state.aiMessage}</textarea>`}</div></div></div></div>`;
                if (state.activeModal.type) {
                     const isNote = state.activeModal.type === 'note'; const record = state.activeModal.record; const content = isNote ? record.note : record.schedule;
                     modalHtml += `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in backdrop-blur-sm"><div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col ${!isNote ? 'max-h-[80vh]' : ''}"><div class="bg-gradient-to-r ${!isNote ? 'from-emerald-600 to-teal-600' : 'from-blue-600 to-indigo-600'} p-4 flex justify-between items-center text-white shrink-0"><h3 class="font-bold flex items-center"><i data-lucide="${isNote ? 'file-pen-line' : 'calendar-days'}" class="w-5 h-5 mr-2"></i> 編輯${isNote ? '附註' : '還款日程'}</h3><button onclick="window.updateState({activeModal: {type: null, record: null}})" class="hover:bg-white/20 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-4 flex-1 overflow-y-auto custom-scrollbar">${isNote ? `<textarea id="modalTextarea" class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none text-sm leading-relaxed" placeholder="請輸入內容...">${record.note || ''}</textarea>` : `<div class="p-0 overflow-y-auto flex-1 custom-scrollbar" style="max-height: 400px;"><table class="w-full text-left border-collapse"><thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0 z-10"><tr><th class="p-3 border-b">日期 / 紀錄事項</th><th class="p-3 border-b text-center w-16">操作</th></tr></thead><tbody class="divide-y divide-gray-100">${(state.tempScheduleLines || []).map((line, idx) => `<tr class="hover:bg-gray-50 group"><td class="p-2"><input type="text" value="${line}" oninput="window.updateScheduleLine(${idx}, this.value)" class="w-full p-2 border border-gray-200 rounded focus:ring-2 focus:ring-emerald-500 outline-none text-sm bg-transparent group-hover:bg-white" /></td><td class="p-2 text-center"><button onclick="window.deleteScheduleLine(${idx})" class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('')}</tbody></table>${(state.tempScheduleLines || []).length === 0 ? '<div class="p-8 text-center text-gray-400 text-sm">尚無還款紀錄</div>' : ''}</div><div class="p-4 border-t border-gray-100 bg-gray-50 shrink-0 flex justify-between items-center"><button onclick="window.addScheduleLine()" class="text-emerald-600 hover:text-emerald-800 text-sm font-medium flex items-center"><i data-lucide="plus" class="w-4 h-4 mr-1"></i> 新增一筆</button></div>`}</div><div class="p-4 border-t border-gray-100 bg-gray-50 text-right shrink-0 flex justify-end gap-2"><button onclick="window.updateState({activeModal: {type: null, record: null}})" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg text-sm">取消</button><button onclick="window.saveModalData('${record.id}', '${state.activeModal.type}')" class="px-4 py-2 ${!isNote ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-blue-600 hover:bg-blue-700'} text-white rounded-lg text-sm font-medium">儲存</button></div></div></div>`; 
                }
                if (state.modalType) {
                    let filteredRecs = [];
                    // Filter based on modal type AND current user view (admin/user)
                    // We reuse calculateStats() logic which already respects viewingUid
                    const currentStats = calculateStats();

                    if (state.modalType === 'active') filteredRecs = currentStats.activeRecords;
                    else if (state.modalType === 'unpaid') filteredRecs = currentStats.unpaidRecords;
                    else if (state.modalType === 'closed') filteredRecs = currentStats.closedRecords;
                    else if (state.modalType === 'badDebt') filteredRecs = currentStats.badDebtCases;
                    // For card clicks that don't have direct arrays in stats, we must filter manually
                    // But we must respect permissions
                    else {
                        // Base set of records to filter from
                        let baseRecords = state.records;
                        if (state.isAdmin && state.viewingUid !== 'all') {
                            baseRecords = state.records.filter(r => r.ownerUid === state.viewingUid);
                        } else if (!state.isAdmin && !state.isDemoMode) {
                            baseRecords = state.records.filter(r => r.ownerUid === state.currentUserUid);
                        }
                        
                        if (state.modalType === 'outstanding') filteredRecs = baseRecords.filter(r => (r.status === '1' || r.status === '3') && calculateDerivedData(r).outstanding > 0);
                        else if (state.modalType === 'currentLent') filteredRecs = baseRecords.filter(r => r.status === '1' || r.status === '3');
                        else if (state.modalType === 'creditAmount') filteredRecs = baseRecords.filter(r => r.status === '1' || r.status === '3');
                        else if (state.modalType === 'monthDue') filteredRecs = baseRecords.filter(r => r.status === '1' || r.status === '2');
                        else if (state.modalType === 'totalManagementFee') filteredRecs = baseRecords.filter(r => r.status === '2');
                        else if (state.modalType === 'totalIncome') filteredRecs = baseRecords.filter(r => calculateDerivedData(r).totalInterestPaid > 0);
                        else if (state.modalType === 'monthCollected') {
                             filteredRecs = baseRecords.filter(r => {
                                 const { isPaid } = getPaymentStatus(r);
                                 return isPaid && (r.status === '1' || r.status === '2');
                             });
                        }
                        else if (state.modalType === 'monthDiff') { 
                             filteredRecs = baseRecords.filter(r => {
                                 const { isPaid } = getPaymentStatus(r);
                                 return !isPaid && (r.status === '1' || r.status === '2');
                             });
                        }
                        else if (state.modalType === 'monthInterestDiff') { 
                             filteredRecs = baseRecords.filter(r => {
                                 const { isPaid } = getPaymentStatus(r);
                                 return !isPaid && r.status === '1';
                             });
                        }
                        else if (state.modalType === 'badDebtAmount') { 
                             filteredRecs = baseRecords.filter(r => r.status === '3' || r.status === '4');
                        }
                        else if (state.modalType === 'monthInterestDue') {
                             filteredRecs = baseRecords.filter(r => r.status === '1');
                        }
                        else if (state.modalType === 'monthInterestCollected') {
                             filteredRecs = baseRecords.filter(r => {
                                 const { isPaid } = getPaymentStatus(r);
                                 return isPaid && r.status === '1';
                             });
                        }
                        else filteredRecs = baseRecords.filter(r => r.status === '1' || r.status === '2');
                    }
                    
                    // 修改點9: 卡片點擊列表按放款日期排序
                    filteredRecs.sort((a, b) => {
                        const dateA = new Date(a.date || '9999-12-31');
                        const dateB = new Date(b.date || '9999-12-31');
                        return dateA - dateB;
                    });
                    
                    let customHeaders = ''; let customRowBuilder = null;

                    // Default
                    customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">欠款</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                    customRowBuilder = (r, calc, status) => `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower} <span class="text-xs font-normal text-gray-400">(${r.displayId || r.caseNumber || ''})</span></td><td class="p-2 text-right text-red-600 font-mono">${formatNumber(calc.arrears)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td><td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td></tr>`;
                    
                    if (state.modalType === 'totalIncome') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">累計利息/管理費</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right text-emerald-600 font-mono font-bold">${formatNumber(calc.totalInterestPaid)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td><td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td></tr>`;
                    } else if (state.modalType === 'outstanding') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">在外本金</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right text-emerald-600 font-mono font-bold">${formatNumber(calc.outstanding)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td><td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td></tr>`;
                    } else if (state.modalType === 'currentLent') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">放款金額</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right text-emerald-600 font-mono font-bold">${formatNumber(r.disbursed)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td><td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td></tr>`;
                    } else if (state.modalType === 'monthDue') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本月本金</th><th class="p-2 text-right">本月利息</th><th class="p-2 text-right">總計</th><th class="p-2 text-center">本月繳款狀態</th><th class="p-2 text-center">狀態</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const p = r.status==='2' ? 0 : (Number(r.principalPerTerm)||0);
                             const i = Number(r.interestPerTerm)||0;
                             const { isPaid, isOverdue } = getPaymentStatus(r);
                             const paymentStatusHtml = isPaid 
                                 ? `<span class="text-emerald-600 font-bold text-xs"><i data-lucide="check" class="w-3 h-3 inline"></i>已繳清</span>` 
                                 : (isOverdue ? `<span class="text-red-600 font-bold text-xs"><i data-lucide="alert-triangle" class="w-3 h-3 inline"></i>逾期</span>` : `<span class="text-gray-500 font-bold text-xs">未繳</span>`);

                             return `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right font-mono">${formatNumber(p)}</td><td class="p-2 text-right font-mono">${formatNumber(i)}</td><td class="p-2 text-right font-mono font-bold text-blue-600">${formatNumber(p+i)}</td><td class="p-2 text-center">${paymentStatusHtml}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td></tr>`;
                           }
                    } else if (state.modalType === 'monthInterestDue') { 
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本月利息</th><th class="p-2 text-center">本月繳款狀態</th><th class="p-2 text-center">狀態</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const i = Number(r.interestPerTerm)||0;
                             const { isPaid, isOverdue } = getPaymentStatus(r);
                             const paymentStatusHtml = isPaid 
                                 ? `<span class="text-emerald-600 font-bold text-xs"><i data-lucide="check" class="w-3 h-3 inline"></i>已繳清</span>` 
                                 : (isOverdue ? `<span class="text-red-600 font-bold text-xs"><i data-lucide="alert-triangle" class="w-3 h-3 inline"></i>逾期</span>` : `<span class="text-gray-500 font-bold text-xs">未繳</span>`);

                             return `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right font-mono font-bold text-emerald-600">${formatNumber(i)}</td><td class="p-2 text-center">${paymentStatusHtml}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td></tr>`;
                           }
                    } else if (state.modalType === 'monthCollected') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本期本金</th><th class="p-2 text-right">本期利息</th><th class="p-2 text-right">總計</th><th class="p-2 text-center">狀態</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const p = r.status==='2' ? 0 : (Number(r.principalPerTerm)||0);
                             const i = Number(r.interestPerTerm)||0;
                             return `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right font-mono">${formatNumber(p)}</td><td class="p-2 text-right font-mono">${formatNumber(i)}</td><td class="p-2 text-right font-mono font-bold text-emerald-600">${formatNumber(p+i)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td></tr>`;
                           }
                    } else if (state.modalType === 'monthInterestCollected') { 
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本期利息</th><th class="p-2 text-center">狀態</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const i = Number(r.interestPerTerm)||0;
                             return `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right font-mono font-bold text-emerald-600">${formatNumber(i)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td></tr>`;
                           }
                    } else if (state.modalType === 'totalManagementFee') {
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">管理費 (利息)</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => `<tr class="hover:bg-gray-50 transition-colors"><td class="p-2 font-bold text-gray-800">${r.borrower}</td><td class="p-2 text-right text-emerald-600 font-mono font-bold">${formatNumber(r.interestPerTerm)}</td><td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td><td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td></tr>`;
                    } else if (state.modalType === 'monthDiff') { 
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本期本金</th><th class="p-2 text-right">本期利息</th><th class="p-2 text-right">未繳總計</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const p = r.status==='2' ? 0 : (Number(r.principalPerTerm)||0);
                             const i = Number(r.interestPerTerm)||0;
                             const total = p + i;
                             return `<tr class="hover:bg-gray-50 transition-colors">
                                 <td class="p-2 font-bold text-gray-800">${r.borrower}</td>
                                 <td class="p-2 text-right font-mono text-gray-600">${formatNumber(p)}</td>
                                 <td class="p-2 text-right font-mono text-gray-600">${formatNumber(i)}</td>
                                 <td class="p-2 text-right font-mono font-bold text-red-600">${formatNumber(total)}</td>
                                 <td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td>
                                 <td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td>
                               </tr>`;
                           }
                    } else if (state.modalType === 'monthInterestDiff') { 
                         customHeaders = `<tr><th class="p-2">借款人</th><th class="p-2 text-right">本期利息</th><th class="p-2 text-center">狀態</th><th class="p-2 text-center">操作</th></tr>`;
                         customRowBuilder = (r, calc, status) => {
                             const i = Number(r.interestPerTerm)||0;
                             return `<tr class="hover:bg-gray-50 transition-colors">
                                 <td class="p-2 font-bold text-gray-800">${r.borrower}</td>
                                 <td class="p-2 text-right font-mono text-red-600 font-bold">${formatNumber(i)}</td>
                                 <td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${status.color}">${status.text}</span></td>
                                 <td class="p-2 text-center"><button onclick="window.updateState({modalType: null}); window.startEdit('${r.id}')" class="text-blue-600 hover:underline text-xs">前往處理</button></td>
                               </tr>`;
                           }
                    }

                    modalHtml += `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in backdrop-blur-sm"><div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] flex flex-col"><div class="p-4 flex justify-between items-center text-white shrink-0 bg-gradient-to-r from-blue-600 to-indigo-600"><h3 class="font-bold flex items-center"><i data-lucide="list" class="w-5 h-5 mr-2"></i> 案件列表</h3><button onclick="window.updateState({modalType: null})" class="hover:bg-white/20 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-0 overflow-y-auto flex-1"><table class="w-full text-left border-collapse"><thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0">${customHeaders}</thead><tbody class="divide-y divide-gray-100 text-sm">${filteredRecs.map(r => { const calc = calculateDerivedData(r); const status = getStatusLabel(r.status); return customRowBuilder(r, calc, status); }).join('')}</tbody></table></div></div></div>`;
                }

                // (CSV Preview Modal logic removed as requested)

                app.innerHTML = `<div class="flex h-screen bg-slate-100 font-sans text-gray-800"><div class="w-20 sm:w-64 bg-slate-900 text-white flex flex-col justify-between fixed h-full z-20 transition-all duration-300"><div><div class="p-6 flex items-center justify-center sm:justify-start border-b border-slate-700"><i data-lucide="wallet" class="w-8 h-8 text-emerald-400 mr-0 sm:mr-3"></i><span class="hidden sm:block text-xl font-bold tracking-wider">借貸管理</span></div><div class="px-6 py-4 flex items-center border-b border-slate-800 mb-2"><div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mr-3 ${state.isDemoMode ? 'bg-amber-500' : 'bg-slate-700'}">${state.isDemoMode ? 'T' : (state.currentUser ? state.currentUser.substring(0, 2).toUpperCase() : 'U')}</div><div class="hidden sm:block"><p class="text-xs text-slate-400">${state.isDemoMode ? "試用模式" : "已登入"}</p><p class="text-sm font-bold text-white truncate w-32">${state.isDemoMode ? "訪客 (不儲存)" : state.currentUser}</p></div></div><nav class="mt-4 px-4 space-y-2"><button onclick="window.setActiveTab('dashboard')" class="w-full flex items-center p-3 rounded-lg transition-colors ${state.activeTab === 'dashboard' ? 'bg-emerald-600' : 'hover:bg-slate-800'}"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i><span class="hidden sm:block">營運報表</span></button><button onclick="window.setActiveTab('list')" class="w-full flex items-center p-3 rounded-lg transition-colors ${state.activeTab === 'list' ? 'bg-emerald-600' : 'hover:bg-slate-800'}"><i data-lucide="database" class="w-5 h-5 mr-3"></i><span class="hidden sm:block">案件列表</span></button><button onclick="window.setActiveTab('repayment')" class="w-full flex items-center p-3 rounded-lg transition-colors ${state.activeTab === 'repayment' ? 'bg-emerald-600' : 'hover:bg-slate-800'}"><i data-lucide="banknote" class="w-5 h-5 mr-3"></i><span class="hidden sm:block">還款輸入</span></button>${state.isAdmin ? `<button onclick="window.setActiveTab('admin')" class="w-full flex items-center p-3 rounded-lg transition-colors ${state.activeTab === 'admin' ? 'bg-emerald-600' : 'hover:bg-slate-800'}"><i data-lucide="users" class="w-5 h-5 mr-3"></i><span class="hidden sm:block">用戶管理</span></button>` : ''}</nav></div><div class="p-4 border-t border-slate-700 space-y-2"><button onclick="window.handleLogout()" class="w-full flex items-center justify-center sm:justify-start p-3 rounded-lg text-slate-400 hover:bg-red-900/30 hover:text-red-400 transition-colors"><i data-lucide="log-out" class="w-5 h-5 mr-0 sm:mr-2"></i><span class="hidden sm:block font-medium">登出系統</span></button></div></div><div class="flex-1 ml-20 sm:ml-64 p-4 sm:p-8 overflow-x-hidden">${content}</div>${modalHtml}</div>`;
                
                // Initialize Rows if on List Tab
                if (state.activeTab === 'list') {
                    window.refreshListUI();
                }
            }
            lucide.createIcons();
        }

        // Init App
        if (firebaseAvailable) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.currentUser = user.displayName || user.email;
                    state.currentUserUid = user.uid;
                    state.isDemoMode = false;
                    
                    // --- REVISED: Use onSnapshot for real-time permission updates and self-healing ---
                    
                    // 1. Listen to user directory for permissions (and all users if admin)
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'user_directory'), async (snap) => {
                        const allUsers = snap.docs.map(d => d.data());
                        state.usersDirectory = allUsers;
                        
                        // Find current user's role
                        const myProfile = allUsers.find(u => u.uid === state.currentUserUid);
                        
                        if (myProfile) {
                            const newIsAdmin = myProfile.role === 'admin';
                            
                            // Only update and re-render if role changed
                            if (newIsAdmin !== state.isAdmin) {
                                state.isAdmin = newIsAdmin;
                                state.allowedStatus = myProfile.allowedStatus || ['0', '1', '3', '4'];
                                renderApp();
                            } else {
                                state.allowedStatus = myProfile.allowedStatus || ['0', '1', '3', '4'];
                                // If already admin, we still might need to re-render if usersDirectory changed (for dropdown)
                                if (state.isAdmin) renderApp();
                            }
                        }

                        // --- SELF-HEALING LOGIC ---
                        // If this is the ONLY user in the system, force them to be admin
                        if (allUsers.length === 1 && myProfile && myProfile.role !== 'admin') {
                            console.log("Self-healing: Promoting single user to admin...");
                            try {
                                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_directory', state.currentUserUid), {
                                    role: 'admin',
                                    allowedStatus: ['0', '1', '2', '3', '4'] // Give full access
                                });
                            } catch (e) {
                                console.error("Self-healing failed:", e);
                            }
                        }
                    });

                    // 2. Listen to Loan Records (Always listen to all, filter in UI for smooth switching)
                    if (!state.isLoadingListener) {
                        // 修改查詢，按日期排序
                        const q = query(
                            collection(db, 'artifacts', appId, 'public', 'data', 'loan_records'), 
                            orderBy('date', 'asc')
                        );
                        onSnapshot(q, (snapshot) => {
                              const docs = snapshot.docs.map((doc, index) => {
                                  const data = doc.data();
                                  const displayId = data.caseNumber || formatCaseId(index + 1);
                                  return { id: doc.id, ...data, displayId };
                              });
                              updateState({ records: docs });
                        });
                        state.isLoadingListener = true;
                    }
                } else {
                    state.currentUser = null;
                    state.currentUserUid = null;
                    state.isAdmin = false;
                    state.usersDirectory = [];
                }
                renderApp();
            });
        } else {
            renderApp();
        }

    </script>
</body>
</html>